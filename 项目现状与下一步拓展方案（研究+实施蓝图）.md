## 项目现状与下一步拓展方案（研究+实施蓝图）

基于对现有代码、上卷/中卷/下卷内容的全面分析，给出以下完整方案：

------

### 一、现有项目功能盘点

#### 1. 已实现功能（✅ 可用）

| 模块               | 状态     | 核心能力                                                     |
| :----------------- | :------- | :----------------------------------------------------------- |
| **九宫排盘研习**   | ✅ 已实现 | `DunjiaPalacePage`：展示完整九宫盘（九星/八门/三奇六仪/八神/格局） |
| **三奇应验与择日** | ✅ 已实现 | `SanqiZheriPage`：日期选择 + 干支择日（宝义伐日）+ 五阳五阴时 + 三奇九宫 + 三奇宫位详情 |
| **排盘引擎**       | ✅ 完整   | `DunjiaEngine`：真太阳时 + 阴阳遁局 + 直符直使 + 九星八门三奇六仪八神 + 格局识别 |

#### 2. 待实现功能（⏸ 规划中）

| 模块                 | 当前状态         | 原计划定位                               |
| :------------------- | :--------------- | :--------------------------------------- |
| **九星八门知识解读** | 卡片存在，无路由 | 纯知识库（九星断语、八门吉凶、旺相休囚） |
| **格局识别与判断**   | 卡片存在，无路由 | 纯知识库（吉格凶格分类、组合分析）       |
| **古籍案例重演**     | 卡片存在，无路由 | 教学盘（重现符应经案例）                 |

------

### 二、上卷/中卷/下卷规则与现有功能的匹配度

#### 1. 上卷（基础算法）→ ✅ 已落地到引擎

| 上卷内容          | 引擎实现状态 | 备注                        |
| :---------------- | :----------- | :-------------------------- |
| 阳遁/阴遁布局     | ✅ 完整       | `DunjiaEngine` 核心         |
| 九星八门三奇六仪  | ✅ 完整       | 盘面信息完备                |
| 直符直使          | ✅ 完整       | 值符宫/值使宫标记           |
| 三奇得使/三奇之灵 | ✅ 部分       | 引擎有格局识别，UI 未展示全 |

#### 2. 中卷（高级格局）→ ⚠️ 部分落地 + 大量预留

| 中卷内容              | 落地状态                       | 已有资源                     |
| :-------------------- | :----------------------------- | :--------------------------- |
| 三遁（天/地/人）      | ⏸ 规则文档 + JSON              | 未接入引擎判定               |
| 三奇入墓              | ⏸ 规则文档 + JSON              | 未接入引擎判定               |
| 六仪击刑              | ⏸ 规则文档 + JSON              | 未接入引擎判定               |
| 五阳五阴所利          | ✅ 已在 `SanqiZheriPage` 中判定 | 已实现时干判定               |
| 三胜宫                | ⏸ 规则文档 + JSON              | 未接入引擎判定               |
| 青龙返首/飞鸟跌穴     | ⏸ 规则文档 + JSON              | 未接入引擎判定               |
| 太白入荧惑/荧惑入太白 | ⏸ 规则文档 + JSON              | 未接入引擎判定               |
| 天网四张              | ⏸ 规则文档 + JSON              | 未接入引擎判定               |
| 亭亭白奸/孤虚法       | ⏸ 规则文档 + JSON              | 未接入引擎判定（需月将体系） |

#### 3. 下卷（实战应用）→ ❌ 完全未落地

| 下卷内容            | 类型     | 建议落地方式                     |
| :------------------ | :------- | :------------------------------- |
| 五不可击            | 战术禁区 | 可与三胜宫并列做"攻守宫位总览"   |
| 五不过时            | 强凶禁忌 | 可在择日页做"时干克日干"强凶警告 |
| 急则从神缓则从门    | 决策原则 | 可做情境提示                     |
| 涉阴危之中          | 综合战术 | 适合做案例展示                   |
| 伏匿藏形/玉女反闭局 | 仪式术法 | 仅做知识展示，不做功能实现       |

------

### 三、下一步拓展方案（分阶段实施）

------

## 📋 阶段一：中卷高级格局接入引擎（核心优先级 ⭐⭐⭐⭐⭐）

**目标**：把已有的中卷 JSON 规则接入 `DunjiaEngine`，让引擎能自动识别这些格局。

### 1.1 引擎改造（`DunjiaEngine.ets`）

**新增字段与方法**：

typescript

```
// 在 DunjiaPanResult 中新增字段 export interface DunjiaPanResult {  // ... 现有字段  advancedPatterns?: AdvancedPattern[];  // 高级格局列表（新增） } // 高级格局结构 export interface AdvancedPattern {  id: string;              // 格局ID（如 "san_dun_tian_dun"）  name: string;            // 格局名称（如 "天遁"）  category: string;        // 分类（如 "三遁格局"）  tendency: string;        // 吉凶倾向（如 "偏吉"/"大凶"）  palaceIndexes?: number[]; // 相关宫位索引  description: string;     // 简要说明 } // 新增格局识别方法 private detectAdvancedPatterns(palaces: PalaceState[]): AdvancedPattern[] {  const patterns: AdvancedPattern[] = [];    // 1. 检测三遁  patterns.push(...this.detectSanDun(palaces));    // 2. 检测三奇入墓  if (this.detectSanqiRuMu()) {    patterns.push({ id: 'san_qi_ru_mu', name: '三奇入墓', ... });  }    // 3. 检测六仪击刑  if (this.detectLiuYiJiXing()) {    patterns.push({ id: 'liu_yi_ji_xing', name: '六仪击刑', ... });  }    // 4. 检测青龙返首/飞鸟跌穴（六甲加六丙 / 六丙加六甲）  patterns.push(...this.detectLongNiao(palaces));    // 5. 检测太白荧惑（庚丙组合）  patterns.push(...this.detectTaiBaiYingHuo(palaces));    // 6. 检测三胜宫  patterns.push(...this.detectSanShengGong(palaces));    return patterns; }
```

### 1.2 具体判定逻辑（示例：三遁天遁）

typescript

```
private detectSanDun(palaces: PalaceState[]): AdvancedPattern[] {  const patterns: AdvancedPattern[] = [];    for (let i = 0; i < palaces.length; i++) {    const palace = palaces[i];        // 天遁：生门 + 丙奇    if (palace.doorName === '生门' && palace.tianGan === '丙') {      patterns.push({        id: 'san_dun_tian_dun',        name: '天遁',        category: '三遁格局',        tendency: '偏吉',        palaceIndexes: [i],        description: '生门遇月奇六丙，得日精之蔽，宜主动出击。'      });    }        // 地遁：开门 + 乙奇    if (palace.doorName === '开门' && palace.tianGan === '乙') {      patterns.push({        id: 'san_dun_di_dun',        name: '地遁',        category: '三遁格局',        tendency: '偏吉',        palaceIndexes: [i],        description: '开门遇日奇六乙，得月精之蔽，宜布局建设。'      });    }        // 人遁：休门 + 丁奇    if (palace.doorName === '休门' && palace.tianGan === '丁') {      patterns.push({        id: 'san_dun_ren_dun',        name: '人遁',        category: '三遁格局',        tendency: '偏吉',        palaceIndexes: [i],        description: '休门遇星奇六丁，得星精之蔽，宜筹谋隐匿。'      });    }  }    return patterns; }
```

### 1.3 UI 展示（在九宫研习页和三奇择日页）

**在 `DunjiaNineGrid` 或 `SanqiNineGrid` 中新增徽标展示**：

typescript

```
// 在宫位卡片右上角增加格局徽标 if (this.panResult.advancedPatterns) {  const relatedPatterns = this.panResult.advancedPatterns.filter(    p => p.palaceIndexes?.includes(index)  );    if (relatedPatterns.length > 0) {    Row({ space: 4 }) {      ForEach(relatedPatterns, (pattern: AdvancedPattern) => {        Text(pattern.name)          .fontSize(10)          .fontColor('#FFFFFF')          .padding({ left: 4, right: 4, top: 2, bottom: 2 })          .backgroundColor(pattern.tendency === '大吉' ? '#4CAF50' :                           pattern.tendency === '大凶' ? '#F44336' : '#FF9800')          .borderRadius(4)      })    }    .position({ x: '5%', y: '5%' })  } }
```

------

## 📋 阶段二：下卷强凶规则接入择日页（安全优先级 ⭐⭐⭐⭐）

**目标**：在三奇择日页顶部增加强凶时段警告。

### 2.1 新增判定：五不过时

**在 `SanqiZheriPage.ets` 中增加方法**：

typescript

```
/** * 判定是否为"五不过时"（时干克日干） */ private isWuBuGuoShi(): boolean {  if (!this.panResult || !this.panResult.dayInfo) return false;    const riGan = this.panResult.dayInfo.day_gan;  const shiGan = this.panResult.hourGanZhi?.charAt(0);    const keMap: Record<string, string> = {    '甲': '庚', '乙': '辛', '丙': '壬', '丁': '癸', '戊': '甲',    '己': '乙', '庚': '丙', '辛': '丁', '壬': '戊', '癸': '己'  };    // 时干克日干  return keMap[riGan] === shiGan; }
```

### 2.2 UI 警告条

typescript

```
// 在顶部择日信息栏之前插入警告条 if (this.isWuBuGuoShi()) {  Row({ space: 8 }) {    Text('⚠️')      .fontSize(16)    Text('五不过时：时干克日干，损明不可行百事！')      .fontSize(13)      .fontWeight(FontWeight.Bold)      .fontColor('#FFFFFF')  }  .width('100%')  .padding(12)  .backgroundColor('#F44336')  .borderRadius(8) }
```

### 2.3 下卷其他规则预留

- **五不可击** → 需要在引擎中计算九天、九地宫，暂时不做
- **急则从神缓则从门** → 可在宫位详情中增加"应急建议/从容建议"双模式提示

------

## 📋 阶段三：知识库页面实现（完善研习体系 ⭐⭐⭐）

**目标**：实现"九星八门知识解读"和"格局识别与判断"两张卡片对应的页面。

### 3.1 九星八门知识解读页（`JiuxingBamenKnowledgePage.ets`）

**内容来源**：

- 上卷"九星所主"、"八门所主"
- 中卷"九星断语"（已在 `PalaceDetailPanel` 中有部分实现）

**页面结构**：

typescript

```
Tabs() {  TabContent() {    // 九星知识列表    List() {      ForEach(九星数据, (star) => {        // 星名 + 属性 + 旺相休囚 + 宜忌      })    }  }.tabBar('九星解读')    TabContent() {    // 八门知识列表    List() {      ForEach(八门数据, (door) => {        // 门名 + 吉凶分类 + 适用场景      })    }  }.tabBar('八门吉凶') }
```

### 3.2 格局识别与判断页（`GejuKnowledgePage.ets`）

**内容来源**：

- 中卷所有已拆出的格局 JSON
- 上卷"三奇得使""三奇之灵"

**页面结构**：

typescript

```
Tabs() {  TabContent() {    // 大吉格局列表（三遁、青龙返首、飞鸟跌穴等）  }.tabBar('大吉格局')    TabContent() {    // 强凶格局列表（六仪击刑、天网四张、五不过时等）  }.tabBar('强凶格局')    TabContent() {    // 对敌战术格局（太白入荧惑、荧惑入太白、五不可击等）  }.tabBar('对敌战术') }
```

------

## 📋 阶段四：古籍案例重演页（教学增强 ⭐⭐）

**目标**：从上卷/中卷/下卷中提取典型局例，一键重建盘面。

### 4.1 案例数据结构（JSON）

json

```
{  "cases": [    {      "id": "case_001",      "title": "冬至上元阳一局·青龙返首",      "source": "中卷·青龙返首条",      "datetime": {        "year": 2024,        "month": 12,        "day": 22,        "hour": 3,        "minute": 0      },      "expectedResult": {        "dunType": "阳遁",        "ju": 1,        "patterns": ["qing_long_fan_shou"]      },      "teachingPoints": [        "观察六甲与六丙的位置关系",        "理解'造举百事吉'的依据"      ]    }  ] }
```

### 4.2 页面交互

typescript

```
// 案例列表 → 点击案例卡片 → 自动传参跳转到九宫研习页 Button('查看此局盘面').onClick(() => {  router.pushUrl({    url: 'pages/DunjiaPalacePage',    params: {      dateTime: new Date(case.datetime.year, case.datetime.month-1, ...),      caseMode: true,      caseInfo: case    }  }) })
```

------

## 📋 阶段五：三胜宫 + 五不可击联动展示（战术增强 ⭐⭐）

**目标**：在九宫研习页增加"攻守宫位总览"模块。

### 5.1 引擎改造

typescript

```
// 在 DunjiaPanResult 中新增 export interface DunjiaPanResult {  // ...  tacticalPositions?: {    sanShengGong: number[];    // 三胜宫索引    wuBuKeJi: number[];        // 五不可击宫索引  } }
```

### 5.2 UI 展示（在九宫盘下方）

typescript

`Column({ space: 8 }) {  Text('攻守宫位总览')    .fontSize(16)    .fontWeight(FontWeight.Bold)    Row({ space: 12 }) {    // 三胜宫展示    Column() {      Text('三胜宫（优势位）')      Text(`第一胜：${天乙宫名}`)      Text(`第二胜：${九天宫名}`)      Text(`第三胜：${生门三奇宫名}`)    }    .padding(12)    .backgroundColor('#E8F5E9')        // 五不可击展示    Column() {      Text('五不可击（禁攻位）')      ForEach(五不可击宫位, (name) => {        Text(name)      })    }    .padding(12)    .backgroundColor('#FFEBEE')  } }`

------

## 📋 阶段六：月将体系预研（长期储备 ⭐）

**说明**：亭亭白奸、孤虚法等需要"月将加时"体系，目前引擎不支持。

**可行性研究**：

1. 查阅上卷是否有月将算法说明（初步判断：无）
2. 若需引入月将，需额外增加"六壬十二将"算法模块
3. 建议：**暂不实施**，优先完成前五个阶段

------

### 四、实施优先级总结（按时间线）

| 阶段                         | 工作量 | 依赖关系       | 建议启动时间 |
| :--------------------------- | :----- | :------------- | :----------- |
| **阶段一**：中卷格局接入引擎 | 3-5天  | 无前置依赖     | **立即开始** |
| **阶段二**：下卷强凶规则接入 | 1天    | 依赖阶段一     | 阶段一完成后 |
| **阶段三**：知识库页面实现   | 2-3天  | 可与阶段一并行 | **立即开始** |
| **阶段四**：古籍案例重演     | 1-2天  | 依赖阶段一     | 阶段一完成后 |
| **阶段五**：攻守宫位总览     | 1天    | 依赖阶段一+二  | 阶段二完成后 |
| **阶段六**：月将体系预研     | 待定   | 需独立算法模块 | **暂不启动** |

------

### 五、最终交付物预期

完成阶段一~五后，项目将具备：

✅ **完整的五页功能架构**：

1. 九宫排盘研习 ✅
2. 九星八门知识解读 ✅（新增）
3. 格局识别与判断 ✅（新增）
4. 三奇应验与择日 ✅（增强：五不过时警告）
5. 古籍案例重演 ✅（新增）

✅ **引擎能力提升**：

- 自动识别 10+ 中卷高级格局
- 强凶时段警告（五不过时）
- 三胜宫/五不可击定位

✅ **研习体系完善**：

- 知识库 + 实战盘 + 案例库三位一体
- 符合"学术研习"定位，不做个人预测