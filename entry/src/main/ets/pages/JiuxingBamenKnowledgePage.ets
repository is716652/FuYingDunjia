import { NavigationBar } from '../components/NavigationBar'

/**
 * ä¹æ˜ŸçŸ¥è¯†æ¡ç›®
 */
interface StarKnowledge {
  name: string;
  alias: string;
  element: string;
  season: string;
  tendency: 'auspicious' | 'inauspicious' | 'neutral';
  characteristics: string;
  suitable: string[];
  avoid: string[];
  wangxiang: string;
}

/**
 * å…«é—¨çŸ¥è¯†æ¡ç›®
 */
interface DoorKnowledge {
  name: string;
  element: string;
  tendency: 'auspicious' | 'inauspicious' | 'neutral';
  characteristics: string;
  suitable: string[];
  avoid: string[];
  menpo: string;
}

interface JiuxingJsonRule {
  id?: string;
  name?: string;
  category?: string;
  description?: string;
  meaning?: string;
  suitable?: string[];
  taboo?: string[];
  tips?: string;
}

interface JiuxingJsonFile {
  rules?: JiuxingJsonRule[];
}

/**
 * ä¹æ˜Ÿå…«é—¨çŸ¥è¯†è§£è¯»é¡µé¢
 * 
 * åŠŸèƒ½ï¼š
 * - ä¹æ˜ŸçŸ¥è¯†åº“ï¼šä¹æ˜Ÿå±æ€§ã€æ—ºç›¸ä¼‘å›šã€å®œå¿Œäº‹é¡¹
 * - å…«é—¨çŸ¥è¯†åº“ï¼šå…«é—¨å‰å‡¶ã€é€‚ç”¨åœºæ™¯ã€é—¨è¿«åˆ¤æ–­
 */
@Entry
@Component
struct JiuxingBamenKnowledgePage {
  @State currentTabIndex: number = 0
  @State starJsonSummary: Record<string, string> = {}
  
  // ä¹æ˜ŸçŸ¥è¯†åº“
  private stars: StarKnowledge[] = [
    {
      name: 'å¤©è“¬',
      alias: 'è´ªç‹¼æ˜Ÿ',
      element: 'æ°´',
      season: 'å†¬å­£æ—ºç›¸',
      tendency: 'inauspicious',
      characteristics: 'å¸ç›—è´¼ã€å¥¸è°‹ã€é˜´è°‹æš—å®³ä¹‹äº‹ã€‚å¤©è“¬ä¸ºæ°´è´¼ä¹‹æ˜Ÿï¼Œæ€§å–œæµåŠ¨éšåŒ¿ã€‚',
      suitable: ['æš—ä¸­è°‹åˆ’', 'éšè”½è¡ŒåŠ¨', 'æ•ç›—ç¼‰å‡¶', 'æ°´åˆ©å·¥ç¨‹'],
      avoid: ['å…¬å¼€æ¨è¿›', 'å©šå«å–œåº†', 'æ±‚åæ±‚å®˜', 'åˆä¼™ç»è¥'],
      wangxiang: 'å†¬æ—ºã€æ˜¥ç›¸ã€å¤ä¼‘ã€å››å­£å›šã€ç§‹æ­»'
    },
    {
      name: 'å¤©ä»»',
      alias: 'å·¦è¾…æ˜Ÿ',
      element: 'åœŸ',
      season: 'å››å­£æ—ºç›¸',
      tendency: 'auspicious',
      characteristics: 'å¸ç”°åœŸã€ä»“åº“ã€è¯šä¿¡åšé‡ä¹‹äº‹ã€‚å¤©ä»»ä¸ºåœŸå¾·ä¹‹æ˜Ÿï¼Œæ€§å–œç¨³å›ºåŠ¡å®ã€‚',
      suitable: ['ç½®ä¸šå»ºé€ ', 'å©šå«ç»“ç›Ÿ', 'æ±‚è´¢äº¤æ˜“', 'åŸ‹è‘¬ä¿®åŸ', 'å±¯ç²®å‚¨ç‰©'],
      avoid: ['è¿œè¡ŒèˆŸè½¦', 'æ€¥é€Ÿæ±‚å', 'è½»ä¸¾å¦„åŠ¨'],
      wangxiang: 'å››å­£æ—ºã€ç§‹ç›¸ã€å†¬ä¼‘ã€æ˜¥å›šã€å¤æ­»'
    },
    {
      name: 'å¤©å†²',
      alias: 'å»‰è´æ˜Ÿ',
      element: 'æœ¨',
      season: 'æ˜¥å­£æ—ºç›¸',
      tendency: 'inauspicious',
      characteristics: 'å¸å†²å‡»ã€äº‰æ–—ã€ä¸å®‰ä¹‹äº‹ã€‚å¤©å†²ä¸ºé›·éœ†ä¹‹æ˜Ÿï¼Œæ€§å–œåŠ¨è¡çªç ´ã€‚',
      suitable: ['ç ´æ—§ç«‹æ–°', 'ç«äº‰äº‰è®¼', 'è®¨å€ºå‚¬é€¼', 'ç ´åœŸåŠ¨å·¥'],
      avoid: ['å©šå«å’Œåˆ', 'æ±‚è´¢äº¤æ˜“', 'å®‰å±…é™å…»', 'è°‹æ±‚é•¿è¿œ'],
      wangxiang: 'æ˜¥æ—ºã€å¤ç›¸ã€å››å­£ä¼‘ã€ç§‹å›šã€å†¬æ­»'
    },
    {
      name: 'å¤©è¾…',
      alias: 'æ–‡æ›²æ˜Ÿ',
      element: 'æœ¨',
      season: 'æ˜¥å­£æ—ºç›¸',
      tendency: 'auspicious',
      characteristics: 'å¸æ–‡ä¹¦ã€ç§‘ä¸¾ã€æ•™åŒ–ä¹‹äº‹ã€‚å¤©è¾…ä¸ºæ–‡æ˜Œä¹‹æ˜Ÿï¼Œæ€§å–œæ–‡æ•™è°‹ç•¥ã€‚',
      suitable: ['æ±‚å­¦è€ƒè¯•', 'æ–‡ä¹¦å¥‘çº¦', 'è°‹åˆ’ç­–ç•¥', 'æ‹œå¸ˆæ±‚æ•™', 'ä¸Šä¹¦çŒ®ç­–'],
      avoid: ['æ­¦åŠ›å¾ä¼', 'ç²—æš´è¡Œäº‹', 'ä¸ä¹‰ä¹‹ä¸¾'],
      wangxiang: 'æ˜¥æ—ºã€å¤ç›¸ã€å››å­£ä¼‘ã€ç§‹å›šã€å†¬æ­»'
    },
    {
      name: 'å¤©è‹±',
      alias: 'ç¦„å­˜æ˜Ÿ',
      element: 'ç«',
      season: 'å¤å­£æ—ºç›¸',
      tendency: 'inauspicious',
      characteristics: 'å¸æ–‡æ˜ã€è¡€å…‰ã€ç«çƒ›ä¹‹äº‹ã€‚å¤©è‹±ä¸ºçƒˆç«ä¹‹æ˜Ÿï¼Œæ€§å–œå…‰æ˜æ¿€çƒˆã€‚',
      suitable: ['æ–‡ä¹¦å…¬å¼€', 'ç…§æ˜ç¥­ç¥€', 'æ˜¾æ‰¬åå£°', 'å¼€å¼ è¥ä¸š'],
      avoid: ['è¿œè¡Œæ±‚è´¢', 'å©šå«ç»“ç›Ÿ', 'åŠ¨åœŸä¿®é€ ', 'æ±‚åŒ»é—®è¯'],
      wangxiang: 'å¤æ—ºã€å››å­£ç›¸ã€ç§‹ä¼‘ã€å†¬å›šã€æ˜¥æ­»'
    },
    {
      name: 'å¤©èŠ®',
      alias: 'å·¨é—¨æ˜Ÿ',
      element: 'åœŸ',
      season: 'å››å­£æ—ºç›¸',
      tendency: 'inauspicious',
      characteristics: 'å¸ç–¾ç—…ã€æ­»ä¸§ã€è…çƒ‚ä¹‹äº‹ã€‚å¤©èŠ®ä¸ºç—…ç¬¦ä¹‹æ˜Ÿï¼Œæ€§å–œé˜´æš—æ½®æ¹¿ã€‚',
      suitable: ['æ±‚åŒ»æ²»ç—…', 'ä¸§è‘¬ä¹‹äº‹', 'é™¤æ—§æ¸…ç†', 'ä¿®è¡¥ç ´æŸ'],
      avoid: ['å©šå«å–œåº†', 'æ±‚è´¢äº¤æ˜“', 'è¿œè¡Œå‡ºå¸ˆ', 'å»ºé€ æ–°å®…'],
      wangxiang: 'å››å­£æ—ºã€ç§‹ç›¸ã€å†¬ä¼‘ã€æ˜¥å›šã€å¤æ­»'
    },
    {
      name: 'å¤©æŸ±',
      alias: 'ç ´å†›æ˜Ÿ',
      element: 'é‡‘',
      season: 'ç§‹å­£æ—ºç›¸',
      tendency: 'inauspicious',
      characteristics: 'å¸åˆšç¡¬ã€ç ´åã€é˜»æ»ä¹‹äº‹ã€‚å¤©æŸ±ä¸ºåˆšé‡‘ä¹‹æ˜Ÿï¼Œæ€§å–œåšç¡¬ç ´è´¥ã€‚',
      suitable: ['ç ´æ•Œæ”»åš', 'æ‹†é™¤æ—§ç‰©', 'åˆšå¼ºå†³æ–­', 'æ–©æ–­ç¾ç»Š'],
      avoid: ['å©šå«å’Œåˆ', 'æ±‚è´¢äº¤æ˜“', 'å»ºé€ æ–°å®…', 'æ–‡ä¹¦è€ƒè¯•'],
      wangxiang: 'ç§‹æ—ºã€å†¬ç›¸ã€æ˜¥ä¼‘ã€å¤å›šã€å››å­£æ­»'
    },
    {
      name: 'å¤©å¿ƒ',
      alias: 'æ­¦æ›²æ˜Ÿ',
      element: 'é‡‘',
      season: 'ç§‹å­£æ—ºç›¸',
      tendency: 'auspicious',
      characteristics: 'å¸åŒ»è¯ã€å°†å¸…ã€å†³æ–­ä¹‹äº‹ã€‚å¤©å¿ƒä¸ºè´µäººåŒ»æ˜Ÿï¼Œæ€§å–œæœå†³æ•‘æŠ¤ã€‚',
      suitable: ['æ±‚åŒ»æ²»ç—…', 'å°†å¸…å‡ºå¾', 'å†³æ–­å¤§äº‹', 'æ±‚è´µäººåŠ©', 'å…¬æ­£è£å†³'],
      avoid: ['é˜´è°‹è¯¡è®¡', 'å¥¸é‚ªä¸ä¹‰', 'æ‹–å»¶çŠ¹è±«'],
      wangxiang: 'ç§‹æ—ºã€å†¬ç›¸ã€æ˜¥ä¼‘ã€å¤å›šã€å››å­£æ­»'
    },
    {
      name: 'å¤©ç¦½',
      alias: 'å³å¼¼æ˜Ÿ',
      element: 'åœŸ',
      season: 'å››å­£æ—ºç›¸',
      tendency: 'auspicious',
      characteristics: 'å¸ä¸­æ­£ã€å’Œåˆã€ç¨³é‡ä¹‹äº‹ã€‚å¤©ç¦½ä¸ºä¸­å®«ä¹‹æ˜Ÿï¼Œæ€§å–œå¹³å’ŒåŒ…å®¹ã€‚',
      suitable: ['å©šå«ç»“ç›Ÿ', 'å’Œè§£çº çº·', 'æ±‚è´¢äº¤æ˜“', 'å±¯ç§¯å‚¨å¤‡', 'ä¸­ä»‹è°ƒåœ'],
      avoid: ['æ€¥é€Ÿçªè¿›', 'å†’é™©æŠ•æœº', 'èƒŒä¿¡å¼ƒä¹‰'],
      wangxiang: 'å››å­£æ—ºã€ç§‹ç›¸ã€å†¬ä¼‘ã€æ˜¥å›šã€å¤æ­»'
    }
  ]

  // å…«é—¨çŸ¥è¯†åº“
  private doors: DoorKnowledge[] = [
    {
      name: 'ä¼‘é—¨',
      element: 'æ°´',
      tendency: 'auspicious',
      characteristics: 'ä¼‘å…»ç”Ÿæ¯ä¹‹é—¨ï¼Œä¸»é™å…»ã€ä¼‘æ•´ã€ç§¯è“„ã€‚ä¸ºä¸Šå‰ä¹‹é—¨ã€‚',
      suitable: ['ä¼‘å…»è°ƒç†', 'å©šå«å–œåº†', 'æ±‚è´¢äº¤æ˜“', 'åŸ‹è‘¬ä¿®åŸ', 'å»ºå®…å®‰å±…', 'ä¸Šè¡¨æ±‚å®˜'],
      avoid: ['è¿œè¡Œå¾æˆ˜', 'æ€¥é€Ÿæ±‚æˆ', 'å†’é™©æŠ•æœº'],
      menpo: 'é—¨è¿«ï¼šä¼‘é—¨è½åå®«ï¼ˆæ°´å…¥æ°´ï¼‰ä¸ºé—¨è¿«ï¼Œä¸»ä¼‘å…»è¿‡åº¦ã€æ‡’æ•£æ‹–å»¶'
    },
    {
      name: 'ç”Ÿé—¨',
      element: 'åœŸ',
      tendency: 'auspicious',
      characteristics: 'ç”Ÿé•¿å‘å±•ä¹‹é—¨ï¼Œä¸»ç”Ÿæœºã€åˆ›é€ ã€å‘å±•ã€‚ä¸ºä¸Šå‰ä¹‹é—¨ã€‚',
      suitable: ['æ±‚è´¢äº¤æ˜“', 'å¼€ä¸šç«‹ä¸š', 'å©šå«ç»“ç›Ÿ', 'å»ºé€ ç§æ¤', 'ç”Ÿè‚²æ±‚å­', 'è¯·æ±‚å‡è¿'],
      avoid: ['ä¸§è‘¬ä¹‹äº‹', 'è®¨å€ºå‚¬é€¼', 'ç ´åæ‹†é™¤'],
      menpo: 'é—¨è¿«ï¼šç”Ÿé—¨è½è‰®å®«æˆ–å¤å®«ï¼ˆåœŸå…¥åœŸï¼‰ä¸ºé—¨è¿«ï¼Œä¸»ç”Ÿæœºå—é˜»ã€å‘å±•è¿Ÿç¼“'
    },
    {
      name: 'ä¼¤é—¨',
      element: 'æœ¨',
      tendency: 'inauspicious',
      characteristics: 'æŸä¼¤ç ´åä¹‹é—¨ï¼Œä¸»ä¼¤å®³ã€äº‰æ–—ã€ç ´è´¥ã€‚ä¸ºä¸­å‡¶ä¹‹é—¨ã€‚',
      suitable: ['è®¨å€ºå‚¬é€¼', 'æ•ç›—ç¼‰å‡¶', 'ç«äº‰äº‰è®¼', 'ç ´é™¤æ—§ç‰©', 'ä½“è‚²ç«æŠ€'],
      avoid: ['å©šå«å–œåº†', 'æ±‚è´¢äº¤æ˜“', 'è¿œè¡Œå‡ºå¸ˆ', 'ä¸Šè¡¨æ±‚å®˜', 'å»ºé€ æ–°å®…'],
      menpo: 'é—¨è¿«ï¼šä¼¤é—¨è½éœ‡å®«æˆ–å·½å®«ï¼ˆæœ¨å…¥æœ¨ï¼‰ä¸ºé—¨è¿«ï¼Œä¸»ä¼¤å®³åŠ é‡ã€è¯‰è®¼ç¼ èº«'
    },
    {
      name: 'æœé—¨',
      element: 'æœ¨',
      tendency: 'neutral',
      characteristics: 'é—­å¡éšè—ä¹‹é—¨ï¼Œä¸»éšè”½ã€é˜»å¡ã€å…³é—­ã€‚ä¸ºä¸­å¹³ä¹‹é—¨ã€‚',
      suitable: ['éšè”½è—åŒ¿', 'å®ˆå¯†é˜²æ³„', 'é—­å…³ä¿®ç‚¼', 'é˜²å®ˆåšå®ˆ', 'é¿éš¾èº²ç¥¸'],
      avoid: ['å…¬å¼€æ¨è¿›', 'è¿œè¡Œæ±‚è´¢', 'å©šå«å–œåº†', 'å¼€ä¸šç«‹ä¸š'],
      menpo: 'é—¨è¿«ï¼šæœé—¨è½éœ‡å®«æˆ–å·½å®«ï¼ˆæœ¨å…¥æœ¨ï¼‰ä¸ºé—¨è¿«ï¼Œä¸»é—­å¡åŠ é‡ã€éš¾ä»¥çªç ´'
    },
    {
      name: 'æ™¯é—¨',
      element: 'ç«',
      tendency: 'neutral',
      characteristics: 'å…‰æ˜æ˜¾éœ²ä¹‹é—¨ï¼Œä¸»æ–‡ä¹¦ã€æ˜¾æ‰¬ã€å…‰æ˜ã€‚ä¸ºä¸­å¹³ä¹‹é—¨ã€‚',
      suitable: ['æ–‡ä¹¦è€ƒè¯•', 'æ˜¾æ‰¬åå£°', 'å…¬å¼€å®£ä¼ ', 'ç…§æ˜ç¥­ç¥€', 'å¼€å¼ è¥ä¸š'],
      avoid: ['éšè”½è¡Œäº‹', 'é€ƒäº¡é¿éš¾', 'æ±‚åŒ»æ²»ç—…', 'åŸ‹è‘¬ä¿®åŸ'],
      menpo: 'é—¨è¿«ï¼šæ™¯é—¨è½ç¦»å®«ï¼ˆç«å…¥ç«ï¼‰ä¸ºé—¨è¿«ï¼Œä¸»å…‰èŠ’è¿‡ç››ã€é”‹èŠ’æ¯•éœ²'
    },
    {
      name: 'æ­»é—¨',
      element: 'åœŸ',
      tendency: 'inauspicious',
      characteristics: 'ç»ˆç»“æ­»äº¡ä¹‹é—¨ï¼Œä¸»æ­»äº¡ã€ç»ˆæ­¢ã€è¡°è´¥ã€‚ä¸ºå¤§å‡¶ä¹‹é—¨ã€‚',
      suitable: ['ä¸§è‘¬ä¹‹äº‹', 'åŠå”é€ç»ˆ', 'ç»ˆæ­¢åˆåŒ', 'é™¤æ—§ç ´è´¥', 'ç‹©çŒæ•é±¼'],
      avoid: ['å©šå«å–œåº†', 'æ±‚è´¢äº¤æ˜“', 'è¿œè¡Œå‡ºå¸ˆ', 'å¼€ä¸šç«‹ä¸š', 'å»ºé€ æ–°å®…'],
      menpo: 'é—¨è¿«ï¼šæ­»é—¨è½è‰®å®«æˆ–å¤å®«ï¼ˆåœŸå…¥åœŸï¼‰ä¸ºé—¨è¿«ï¼Œä¸»æ­»æ°”æ²‰æ²‰ã€è¡°è´¥åŠ å‰§'
    },
    {
      name: 'æƒŠé—¨',
      element: 'é‡‘',
      tendency: 'inauspicious',
      characteristics: 'æƒŠæä¸å®‰ä¹‹é—¨ï¼Œä¸»æƒŠæ‰°ã€äº‰æ–—ã€å£èˆŒã€‚ä¸ºä¸­å‡¶ä¹‹é—¨ã€‚',
      suitable: ['ç«äº‰äº‰è®¼', 'è®¨å€ºå‚¬é€¼', 'é¸£å†¤ç”³è¯‰', 'æ•ç›—ç¼‰å‡¶', 'æƒŠå“é©±é‚ª'],
      avoid: ['å©šå«å–œåº†', 'æ±‚è´¢äº¤æ˜“', 'è¿œè¡Œå‡ºå¸ˆ', 'å®‰å±…é™å…»'],
      menpo: 'é—¨è¿«ï¼šæƒŠé—¨è½ä¹¾å®«æˆ–å…‘å®«ï¼ˆé‡‘å…¥é‡‘ï¼‰ä¸ºé—¨è¿«ï¼Œä¸»æƒŠæåŠ å‰§ã€å£èˆŒä¸æ–­'
    },
    {
      name: 'å¼€é—¨',
      element: 'é‡‘',
      tendency: 'auspicious',
      characteristics: 'å¼€æ‹“è¿›å–ä¹‹é—¨ï¼Œä¸»å¼€åˆ›ã€å¼€æ”¾ã€é€šè¾¾ã€‚ä¸ºä¸Šå‰ä¹‹é—¨ã€‚',
      suitable: ['å¼€ä¸šç«‹ä¸š', 'è¿œè¡Œå‡ºå¸ˆ', 'æ±‚è´¢äº¤æ˜“', 'ç«äº‰äº‰è®¼', 'å©šå«ç»“ç›Ÿ', 'ä¸Šè¡¨æ±‚å®˜'],
      avoid: ['ä¸§è‘¬ä¹‹äº‹', 'é—­å…³éšå±…', 'ä¿å®ˆé˜²å®ˆ'],
      menpo: 'é—¨è¿«ï¼šå¼€é—¨è½ä¹¾å®«æˆ–å…‘å®«ï¼ˆé‡‘å…¥é‡‘ï¼‰ä¸ºé—¨è¿«ï¼Œä¸»å¼€æ‹“è¿‡åº¦ã€é”‹èŠ’å¤ªéœ²'
    }
  ]
    
  aboutToAppear() {
    this.loadJiuxingJson()
  }
  
  private loadJiuxingJson() {
    try {
      const context = getContext(this);
      if (!context || !context.resourceManager || !context.resourceManager.getRawFileContent) {
        console.error('[JiuxingBamenKnowledgePage] æ— æ³•è·å–èµ„æºç®¡ç†å™¨');
        return;
      }
  
      context.resourceManager.getRawFileContent('rules/jiuxing_duanyu_rules.json')
        .then((data: Uint8Array) => {
          const jsonStr = this.decodeUtf8(data);
          let parsed: JiuxingJsonFile | null = null;
          try {
            parsed = JSON.parse(jsonStr) as JiuxingJsonFile;
          } catch (e) {
            console.error('[JiuxingBamenKnowledgePage] è§£æä¹æ˜Ÿ JSON å¤±è´¥', JSON.stringify(e));
            return;
          }
      
          if (!parsed || !parsed.rules || !Array.isArray(parsed.rules)) {
            return;
          }
      
          const summaryMap: Record<string, string> = {};
          for (let i = 0; i < parsed.rules.length; i++) {
            const rule = parsed.rules[i];
            if (!rule || rule.category !== 'ä¹æ˜Ÿæ–­è¯­') {
              continue;
            }
            const ruleName: string = typeof rule.name === 'string' ? rule.name : '';
            const starName: string = this.extractStarNameFromRuleName(ruleName);
            if (!starName) {
              continue;
            }
  
            const parts: string[] = [];
            if (rule.description && typeof rule.description === 'string') {
              parts.push(rule.description);
            }
            if (rule.meaning && typeof rule.meaning === 'string') {
              parts.push('è±¡æ„ï¼š' + rule.meaning);
            }
            if (rule.suitable && Array.isArray(rule.suitable) && rule.suitable.length > 0) {
              parts.push('å®œï¼š' + rule.suitable.join('ã€'));
            }
            if (rule.taboo && Array.isArray(rule.taboo) && rule.taboo.length > 0) {
              parts.push('å¿Œï¼š' + rule.taboo.join('ã€'));
            }
            if (rule.tips && typeof rule.tips === 'string') {
              parts.push('æç¤ºï¼š' + rule.tips);
            }
  
            if (parts.length > 0) {
              summaryMap[starName] = parts.join('\n');
            }
          }
  
          this.starJsonSummary = summaryMap;
        })
        .catch((err: Error) => {
          console.error('[JiuxingBamenKnowledgePage] è¯»å–ä¹æ˜Ÿ JSON å¤±è´¥', JSON.stringify(err));
        });
    } catch (e) {
      console.error('[JiuxingBamenKnowledgePage] loadJiuxingJson å¼‚å¸¸', JSON.stringify(e));
    }
  }
  
  private decodeUtf8(bytes: Uint8Array): string {
    let out = '';
    let i = 0;
    while (i < bytes.length) {
      const c = bytes[i++];
      if (c < 0x80) {
        out += String.fromCharCode(c);
      } else if ((c & 0xe0) === 0xc0 && i < bytes.length) {
        const c2 = bytes[i++];
        const code = ((c & 0x1f) << 6) | (c2 & 0x3f);
        out += String.fromCharCode(code);
      } else if ((c & 0xf0) === 0xe0 && i + 1 < bytes.length) {
        const c2 = bytes[i++];
        const c3 = bytes[i++];
        const code = ((c & 0x0f) << 12) | ((c2 & 0x3f) << 6) | (c3 & 0x3f);
        out += String.fromCharCode(code);
      } else if ((c & 0xf8) === 0xf0 && i + 2 < bytes.length) {
        const c2 = bytes[i++];
        const c3 = bytes[i++];
        const c4 = bytes[i++];
        let codePoint = ((c & 0x07) << 18) | ((c2 & 0x3f) << 12) | ((c3 & 0x3f) << 6) | (c4 & 0x3f);
        codePoint -= 0x10000;
        const high = 0xd800 + (codePoint >> 10);
        const low = 0xdc00 + (codePoint & 0x3ff);
        out += String.fromCharCode(high, low);
      } else {
        out += '?';
      }
    }
    return out;
  }
  
  private extractStarNameFromRuleName(ruleName: string): string {
    if (!ruleName) {
      return '';
    }
    if (ruleName.endsWith('æ˜Ÿæ–­è¯­')) {
      const length: number = ruleName.length - 3;
      if (length > 0) {
        return ruleName.substring(0, length);
      }
    }
    if (ruleName.endsWith('æ˜Ÿ')) {
      const length2: number = ruleName.length - 1;
      if (length2 > 0) {
        return ruleName.substring(0, length2);
      }
    }
    return ruleName;
  }
  
  /**
   * è·å–å€¾å‘æ ‡ç­¾
   */
  private getTendencyLabel(tendency: string): string {
    const map: Record<string, string> = {
      'auspicious': 'å‰',
      'inauspicious': 'å‡¶',
      'neutral': 'å¹³'
    }
    return map[tendency] || 'æœªçŸ¥'
  }

  /**
   * è·å–å€¾å‘é¢œè‰²
   */
  private getTendencyColor(tendency: string): string {
    const map: Record<string, string> = {
      'auspicious': '#4CAF50',
      'inauspicious': '#F44336',
      'neutral': '#FF9800'
    }
    return map[tendency] || '#999999'
  }

  /**
   * æ¸²æŸ“ä¹æ˜Ÿå¡ç‰‡
   */
  @Builder
  buildStarCard(star: StarKnowledge) {
    Column({ space: 8 }) {
      // æ ‡é¢˜è¡Œ
      Row({ space: 8 }) {
        Text(star.name)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C2416')
        
        Text(star.alias)
          .fontSize(13)
          .fontColor('#888888')
        
        Blank()
        
        Text(this.getTendencyLabel(star.tendency))
          .fontSize(12)
          .fontColor('#FFFFFF')
          .backgroundColor(this.getTendencyColor(star.tendency))
          .padding({ left: 8, right: 8, top: 3, bottom: 3 })
          .borderRadius(4)
      }
      .width('100%')

      // å±æ€§ä¿¡æ¯
      Row({ space: 12 }) {
        Text(`äº”è¡Œï¼š${star.element}`)
          .fontSize(12)
          .fontColor('#666666')
        Text(`æ—ºå­£ï¼š${star.season}`)
          .fontSize(12)
          .fontColor('#666666')
      }
      .width('100%')

      Divider().color('#E0E0E0').strokeWidth(1)

      // ç‰¹æ€§
      Text(star.characteristics)
        .fontSize(13)
        .fontColor('#2C2416')
        .lineHeight(20)
        .width('100%')

      // ä¸­å·ä¹æ˜Ÿæ–­è¯­ï¼ˆæ¥è‡ª JSONï¼‰
      if (this.starJsonSummary[star.name]) {
        Text(this.starJsonSummary[star.name])
          .fontSize(12)
          .fontColor('#4A3B20')
          .lineHeight(18)
          .width('100%')
          .padding({ top: 4 })
          .backgroundColor('#FFFDF5')
          .borderRadius(4)
      }

      // å®œ
      Column({ space: 4 }) {
        Text('âœ“ é€‚å®œï¼š')
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor('#4CAF50')
        
        Text(star.suitable.join('ã€'))
          .fontSize(12)
          .fontColor('#666666')
          .lineHeight(18)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // å¿Œ
      Column({ space: 4 }) {
        Text('âœ— ä¸å®œï¼š')
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor('#F44336')
        
        Text(star.avoid.join('ã€'))
          .fontSize(12)
          .fontColor('#666666')
          .lineHeight(18)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // æ—ºç›¸ä¼‘å›šæ­»
      Text(`ğŸ“… ${star.wangxiang}`)
        .fontSize(11)
        .fontColor('#999999')
        .width('100%')
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .shadow({ radius: 4, color: '#22000000', offsetX: 0, offsetY: 2 })
  }

  /**
   * æ¸²æŸ“å…«é—¨å¡ç‰‡
   */
  @Builder
  buildDoorCard(door: DoorKnowledge) {
    Column({ space: 8 }) {
      // æ ‡é¢˜è¡Œ
      Row({ space: 8 }) {
        Text(door.name)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C2416')
        
        Text(`äº”è¡Œï¼š${door.element}`)
          .fontSize(13)
          .fontColor('#888888')
        
        Blank()
        
        Text(this.getTendencyLabel(door.tendency))
          .fontSize(12)
          .fontColor('#FFFFFF')
          .backgroundColor(this.getTendencyColor(door.tendency))
          .padding({ left: 8, right: 8, top: 3, bottom: 3 })
          .borderRadius(4)
      }
      .width('100%')

      Divider().color('#E0E0E0').strokeWidth(1)

      // ç‰¹æ€§
      Text(door.characteristics)
        .fontSize(13)
        .fontColor('#2C2416')
        .lineHeight(20)
        .width('100%')

      // å®œ
      Column({ space: 4 }) {
        Text('âœ“ é€‚å®œï¼š')
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor('#4CAF50')
        
        Text(door.suitable.join('ã€'))
          .fontSize(12)
          .fontColor('#666666')
          .lineHeight(18)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // å¿Œ
      Column({ space: 4 }) {
        Text('âœ— ä¸å®œï¼š')
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor('#F44336')
        
        Text(door.avoid.join('ã€'))
          .fontSize(12)
          .fontColor('#666666')
          .lineHeight(18)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // é—¨è¿«è¯´æ˜
      Text(`âš ï¸ ${door.menpo}`)
        .fontSize(11)
        .fontColor('#FF9800')
        .lineHeight(16)
        .width('100%')
        .padding(8)
        .backgroundColor('#FFF8F0')
        .borderRadius(6)
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .shadow({ radius: 4, color: '#22000000', offsetX: 0, offsetY: 2 })
  }

  build() {
    Column({ space: 0 }) {
      // é¡¶éƒ¨å¯¼èˆªæ 
      NavigationBar({ title: 'ä¹æ˜Ÿå…«é—¨çŸ¥è¯†è§£è¯»' })

      // æ ‡ç­¾é¡µ
      Tabs({ index: this.currentTabIndex }) {
        // ä¹æ˜Ÿè§£è¯»æ ‡ç­¾é¡µ
        TabContent() {
          Scroll() {
            Column({ space: 12 }) {
              // è¯´æ˜å¡ç‰‡
              Text('ä¹æ˜Ÿæºè‡ªåŒ—æ–—ä¸ƒæ˜ŸåŠ å·¦è¾…å³å¼¼ï¼Œé…åˆæ´›ä¹¦ä¹å®«ï¼Œå¸æŒå¤©æ—¶ã€äººäº‹ã€å‰å‡¶ã€‚ä»¥ä¸‹æŒ‰ä¹æ˜Ÿé¡ºåºæ’åˆ—ï¼ˆå¤©è“¬ã€å¤©ä»»ã€å¤©å†²ã€å¤©è¾…ã€å¤©è‹±ã€å¤©èŠ®ã€å¤©æŸ±ã€å¤©å¿ƒã€å¤©ç¦½ï¼‰ã€‚')
                .fontSize(13)
                .fontColor('#666666')
                .lineHeight(20)
                .width('100%')
                .padding(12)
                .backgroundColor('#FFF8F0')
                .borderRadius(8)

              // åŸå…¸ä¹æ˜Ÿåœ†å¼ï¼ˆç¼©ç•¥é¢„è§ˆï¼‰
              Column({ space: 6 }) {
                Text('åŸå…¸ä¹æ˜Ÿåœ†å¼ï¼ˆç¼©ç•¥é¢„è§ˆï¼‰')
                  .fontSize(12)
                  .fontColor('#888888')
                  .width('100%')

                Image($r('app.media.jiuxingyuantu'))
                  .width('100%')
                  .height(140)
                  .objectFit(ImageFit.Contain)
                  .borderRadius(8)
              }
              .width('100%')
              .padding({ top: 4, bottom: 4 })

              // ä¹æ˜Ÿåˆ—è¡¨
              ForEach(this.stars, (star: StarKnowledge) => {
                this.buildStarCard(star)
              })
            }
            .width('100%')
            .padding(16)
          }
          .width('100%')
          .height('100%')
          .scrollBar(BarState.Auto)
        }
        .tabBar('ä¹æ˜Ÿè§£è¯»')

        // å…«é—¨è§£è¯»æ ‡ç­¾é¡µ
        TabContent() {
          Scroll() {
            Column({ space: 12 }) {
              // è¯´æ˜å¡ç‰‡
              Text('å…«é—¨æºè‡ªå…«å¦æ–¹ä½ï¼Œå¸æŒåœ°åˆ©ã€è¡Œäº‹ã€å¼€é˜–ã€‚åˆ†ä¸ºä¸‰å‰é—¨ï¼ˆå¼€ä¼‘ç”Ÿï¼‰ã€ä¸‰å¹³é—¨ï¼ˆæœæ™¯æƒŠï¼‰ã€äºŒå‡¶é—¨ï¼ˆä¼¤æ­»ï¼‰ã€‚ä»¥ä¸‹æŒ‰å…«å¦é¡ºåºæ’åˆ—ã€‚')
                .fontSize(13)
                .fontColor('#666666')
                .lineHeight(20)
                .width('100%')
                .padding(12)
                .backgroundColor('#FFF8F0')
                .borderRadius(8)

              // å…«é—¨åˆ—è¡¨
              ForEach(this.doors, (door: DoorKnowledge) => {
                this.buildDoorCard(door)
              })
            }
            .width('100%')
            .padding(16)
          }
          .width('100%')
          .height('100%')
          .scrollBar(BarState.Auto)
        }
        .tabBar('å…«é—¨å‰å‡¶')
      }
      .width('100%')
      .layoutWeight(1)
      .onChange((index: number) => {
        this.currentTabIndex = index
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F1E8')
  }
}
