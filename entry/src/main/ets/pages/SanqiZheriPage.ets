import { DunjiaPanResult, DunjiaEngine, DunjiaInput, DunjiaSceneType } from '../utils/DunjiaEngine'
import router from '@ohos.router'
import { SanqiNineGrid } from '../components/SanqiNineGrid'
import { SanqiPalaceDetailPanel } from '../components/SanqiPalaceDetailPanel'

/**
 * å¹²æ”¯ç±»å‹ä¿¡æ¯
 */
interface GanzhiTypeInfo {
  type: string;
  level: number;
  color: string;
}

/**
 * æ—¶è¾°ç±»å‹ä¿¡æ¯
 */
interface ShichenTypeInfo {
  type: string;
  desc: string;
  color: string;
}

/**
 * ä¸‰å¥‡åº”éªŒæ‹©æ—¥é¡µé¢
 * 
 * åŠŸèƒ½:
 * - ä¸“ä¸ºæ‹©æ—¥è®¾è®¡çš„æ’ç›˜é¡µé¢
 * - å®«ä½å¡ç‰‡æ˜¾ç¤ºä¸‰å¥‡åº”éªŒä¿¡æ¯
 * - é¡¶éƒ¨æ˜¾ç¤ºå¹²æ”¯æ‹©æ—¥ä¿¡æ¯
 * - å®šåˆ¶åŒ–å®«ä½è¯¦æƒ…é¢æ¿
 */

@Entry
@Component
struct SanqiZheriPage {
  @State panResult: DunjiaPanResult | null = null
  @State selectedPalace: number | null = null
  @State loading: boolean = true
  @State currentDateTime: Date = new Date()
  private scroller: Scroller = new Scroller()
  private engine: DunjiaEngine = DunjiaEngine.getInstance()

  aboutToAppear() {
    // ä»è·¯ç”±å‚æ•°è·å–æ—¶é—´ä¿¡æ¯
    const params = router.getParams() as Record<string, Object>;
    if (params && params['dateTime']) {
      this.currentDateTime = params['dateTime'] as Date;
    }
    
    // æ‰§è¡Œæ’ç›˜è®¡ç®—
    this.computePan();
  }

  /**
   * æ’ç›˜è®¡ç®—
   */
  private async computePan() {
    try {
      this.loading = true;
      
      const input: DunjiaInput = {
        dateTime: this.currentDateTime,
        longitude: 116.4074,  // åŒ—äº¬ç»åº¦
        sceneType: DunjiaSceneType.GENERAL_STUDY
      };
      
      this.panResult = await this.engine.computePan(input);
      
      this.loading = false;
    } catch (err) {
      console.error('æ’ç›˜è®¡ç®—å¤±è´¥', err);
      this.loading = false;
    }
  }

  /**
   * è·å–æ—¥å¹²æ”¯ç±»å‹(å®æ—¥/ä¹‰æ—¥/åˆ¶æ—¥/å’Œæ—¥/ä¼æ—¥)
   */
  private getRiGanzhiType(): GanzhiTypeInfo {
    if (!this.panResult || !this.panResult.dayInfo) return { type: 'æœªçŸ¥', level: 0, color: '#999999' };
    
    const ganzhiTypes: Record<string, GanzhiTypeInfo> = {
      // å®æ—¥(å¹²ç”Ÿæ”¯)
      'ç”²åˆ': { type: 'å®æ—¥', level: 5, color: '#FFD700' },
      'ä¹™å·³': { type: 'å®æ—¥', level: 5, color: '#FFD700' },
      'ä¸™è¾°': { type: 'å®æ—¥', level: 5, color: '#FFD700' },
      'ä¸æœª': { type: 'å®æ—¥', level: 5, color: '#FFD700' },
      'æˆŠç”³': { type: 'å®æ—¥', level: 5, color: '#FFD700' },
      'å·±é…‰': { type: 'å®æ—¥', level: 5, color: '#FFD700' },
      'åºšå­': { type: 'å®æ—¥', level: 5, color: '#FFD700' },
      'è¾›äº¥': { type: 'å®æ—¥', level: 5, color: '#FFD700' },
      'å£¬å¯…': { type: 'å®æ—¥', level: 5, color: '#FFD700' },
      'ç™¸å¯': { type: 'å®æ—¥', level: 5, color: '#FFD700' },
      
      // ä¼æ—¥(æ”¯å…‹å¹²)
      'ç”²ç”³': { type: 'ä¼æ—¥', level: 0, color: '#F44336' },
      'ä¹™é…‰': { type: 'ä¼æ—¥', level: 0, color: '#F44336' },
      'ä¸™å­': { type: 'ä¼æ—¥', level: 0, color: '#F44336' },
      'ä¸äº¥': { type: 'ä¼æ—¥', level: 0, color: '#F44336' },
      'æˆŠå¯…': { type: 'ä¼æ—¥', level: 0, color: '#F44336' },
      'å·±å¯': { type: 'ä¼æ—¥', level: 0, color: '#F44336' },
      'åºšåˆ': { type: 'ä¼æ—¥', level: 0, color: '#F44336' },
      'è¾›å·³': { type: 'ä¼æ—¥', level: 0, color: '#F44336' },
      'å£¬è¾°': { type: 'ä¼æ—¥', level: 0, color: '#F44336' },
      'ç™¸æœª': { type: 'ä¼æ—¥', level: 0, color: '#F44336' }
    };
      
    // ä»æ’ç›˜ç»“æœè·å–çœŸå®æ—¥å¹²æ”¯
    const riGanzhi = `${this.panResult.dayInfo.day_gan}${this.panResult.dayInfo.day_zhi}`;
    return ganzhiTypes[riGanzhi] || { type: 'å’Œæ—¥', level: 3, color: '#4CAF50' };
  }
  
  /**
   * è·å–æ—¶è¾°å±æ€§(äº”é˜³æ—¶/äº”é˜´æ—¶)
   */
  private getShichenType(): ShichenTypeInfo {
    if (!this.panResult || !this.panResult.hourGanZhi) return { type: 'æœªçŸ¥', desc: '', color: '#999999' };
      
    // ä»æ’ç›˜ç»“æœè·å–çœŸå®æ—¶è¾°å¤©å¹²
    const shiGan = this.panResult.hourGanZhi.charAt(0);
    const yangGan = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ'];
      
    if (yangGan.includes(shiGan)) {
      return {
        type: 'äº”é˜³æ—¶',
        desc: 'åˆ©å®¢å…ˆå‘,é«˜æ——é¸£é¼“',
        color: '#FF9800'
      };
    } else {
      return {
        type: 'äº”é˜´æ—¶',
        desc: 'åˆ©ä¸»ååŠ¨,ä½æ——è¡”æ•',
        color: '#3F51B5'
      };
    }
  }

  /**
   * è·å–æ‹©æ—¥å»ºè®®
   */
  private getZheriSuggestion(): string {
    const riType = this.getRiGanzhiType();
    const shiType = this.getShichenType();
    
    if (riType.level === 5) {
      return `ä»Šæ—¥${riType.type},ç™¾äº‹çš†å®œã€‚${shiType.desc}ã€‚`;
    } else if (riType.level === 0) {
      return `ä»Šæ—¥${riType.type},ç™¾äº‹å¿Œç”¨!å°¤å…¶ä¸å¯å‡ºå†›ã€‚`;
    } else {
      return `ä»Šæ—¥${riType.type},å¯åŠä¸€èˆ¬äº‹åŠ¡ã€‚${shiType.desc}ã€‚`;
    }
  }

  build() {
    Column() {
      if (this.loading) {
        Column() {
          Text('æ’ç›˜è®¡ç®—ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // é¡¶éƒ¨æ‹©æ—¥ä¿¡æ¯æ 
        Column({ space: 12 }) {
        // æ ‡é¢˜
        Text('ä¸‰å¥‡åº”éªŒæ‹©æ—¥')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C2416')
        
        // æ—¥æœŸé€‰æ‹©æŒ‰é’®
        Button() {
          Row({ space: 8 }) {
            Text('ğŸ“…')
              .fontSize(16)
            if (this.panResult && this.panResult.dayInfo) {
              Text(`${this.panResult.dayInfo.year}å¹´${this.panResult.dayInfo.month}æœˆ${this.panResult.dayInfo.day}æ—¥`)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
            } else {
              Text('é€‰æ‹©æ—¥æœŸ')
                .fontSize(14)
            }
          }
        }
        .backgroundColor('#F5F5F5')
        .borderRadius(8)
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .onClick(() => {
          DatePickerDialog.show({
            start: new Date('1900-1-1'),
            end: new Date('2100-12-31'),
            selected: this.currentDateTime,
            onAccept: (value: DatePickerResult) => {
              this.currentDateTime = new Date(value.year!, value.month! + 1, value.day!);
              this.computePan();
            }
          })
        })
        
        // æ—¥å¹²æ”¯ä¿¡æ¯
        Row({ space: 16 }) {
          Row({ space: 8 }) {
            Text('æ—¥å¹²æ”¯:')
              .fontSize(13)
              .fontColor('#666666')
            if (this.panResult && this.panResult.dayInfo) {
              Text(`${this.panResult.dayInfo.day_gan}${this.panResult.dayInfo.day_zhi}`)
                .fontSize(15)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.getRiGanzhiType().color)
            }
            Text(`(${this.getRiGanzhiType().type})`)
              .fontSize(12)
              .fontColor(this.getRiGanzhiType().color)
              .padding({ left: 2, right: 6, top: 2, bottom: 2 })
              .backgroundColor(this.getRiGanzhiType().color + '22')
              .borderRadius(4)
          }
          
          Row({ space: 8 }) {
            Text('æ—¶è¾°:')
              .fontSize(13)
              .fontColor('#666666')
            if (this.panResult && this.panResult.hourGanZhi) {
              Text(`${this.panResult.hourGanZhi}æ—¶`)
                .fontSize(15)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.getShichenType().color)
            }
            Text(`(${this.getShichenType().type})`)
              .fontSize(12)
              .fontColor(this.getShichenType().color)
              .padding({ left: 2, right: 6, top: 2, bottom: 2 })
              .backgroundColor(this.getShichenType().color + '22')
              .borderRadius(4)
          }
        }
        .width('100%')
        
        // æ‹©æ—¥å»ºè®®
        Text(this.getZheriSuggestion())
          .fontSize(13)
          .fontColor('#2C2416')
          .lineHeight(20)
          .width('100%')
          .padding(12)
          .backgroundColor('#FFF8F0')
          .borderRadius(8)
          .border({ width: 1, color: '#FFE4B5' })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 4, color: '#22000000', offsetX: 0, offsetY: 2 })

      Scroll(this.scroller) {
        Column({ space: 16 }) {
          // ä¹å®«æ’ç›˜(ä¸“ç”¨æ‹©æ—¥ç»„ä»¶)
          if (this.panResult) {
            SanqiNineGrid({
              panResult: this.panResult,
              selectedPalace: this.selectedPalace,
              onPalaceClick: (index: number) => {
                this.selectedPalace = index;
              }
            })
          }

          // ä¸‰å¥‡åº”éªŒå®«ä½è¯¦æƒ…é¢æ¿
          if (this.selectedPalace !== null) {
            SanqiPalaceDetailPanel({
              panResult: this.panResult,
              selectedPalace: this.selectedPalace
            })
          }
        }
        .width('100%')
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
