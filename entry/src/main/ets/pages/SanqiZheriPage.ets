import { DunjiaPanResult, DunjiaEngine, DunjiaInput, DunjiaSceneType } from '../utils/DunjiaEngine'
import router from '@ohos.router'
import { SanqiNineGrid } from '../components/SanqiNineGrid'
import { SanqiPalaceDetailPanel } from '../components/SanqiPalaceDetailPanel'

/**
 * å¹²æ”¯ç±»å‹ä¿¡æ¯
 */
interface GanzhiTypeInfo {
  type: string;
  level: number;
  color: string;
}

/**
 * æ—¶è¾°ç±»å‹ä¿¡æ¯
 */
interface ShichenTypeInfo {
  type: string;
  desc: string;
  color: string;
}

interface ZeriRiType {
  type?: string;
  alias?: string;
  level?: string;
  relation?: string;
  examples?: string[];
  suitable?: string[];
  taboo?: string[];
  mnemonic?: string;
}

interface WuyangTimeBlock {
  scope?: string;
  stems?: string[];
  attribute?: string;
  strategy?: string;
  suitable?: string[];
  taboo?: string[];
  special?: string;
}

interface RulesJsonRule {
  id?: string;
  name?: string;
  summary?: string;
  types?: ZeriRiType[];
  yangTime?: WuyangTimeBlock;
  yinTime?: WuyangTimeBlock;
}

interface RulesJsonFile {
  rules?: RulesJsonRule[];
}

/**
 * ä¸‰å¥‡åº”éªŒæ‹©æ—¥é¡µé¢
 * 
 * åŠŸèƒ½:
 * - ä¸“ä¸ºæ‹©æ—¥è®¾è®¡çš„æ’ç›˜é¡µé¢
 * - å®«ä½å¡ç‰‡æ˜¾ç¤ºä¸‰å¥‡åº”éªŒä¿¡æ¯
 * - é¡¶éƒ¨æ˜¾ç¤ºå¹²æ”¯æ‹©æ—¥ä¿¡æ¯
 * - å®šåˆ¶åŒ–å®«ä½è¯¦æƒ…é¢æ¿
 */

@Entry
@Component
struct SanqiZheriPage {
  @State panResult: DunjiaPanResult | null = null
  @State selectedPalace: number | null = null
  @State loading: boolean = true
  @State currentDateTime: Date = new Date()
  @State sanqiJsonSummary: string = ''
  @State zeriJsonSummary: string = ''
  @State shenshaJsonSummary: string = ''
  private riTypeMapFromJson: Record<string, GanzhiTypeInfo> = {}
  private yangTimeInfoFromJson: WuyangTimeBlock | null = null
  private yinTimeInfoFromJson: WuyangTimeBlock | null = null
  private scroller: Scroller = new Scroller()
  private engine: DunjiaEngine = DunjiaEngine.getInstance()

  aboutToAppear() {
    // ä»è·¯ç”±å‚æ•°è·å–æ—¶é—´ä¿¡æ¯
    const params = router.getParams() as Record<string, Object>;
    if (params && params['dateTime']) {
      this.currentDateTime = params['dateTime'] as Date;
    }
    
    // æ‰§è¡Œæ’ç›˜è®¡ç®—
    this.computePan();
    // åŠ è½½ä¸­å·/ä¸‹å· JSON è§„åˆ™æ‘˜è¦
    this.loadZeriAndSanqiJson();
  }

  /**
   * æ’ç›˜è®¡ç®—
   */
  private async computePan() {
    try {
      this.loading = true;
      
      const input: DunjiaInput = {
        dateTime: this.currentDateTime,
        longitude: 116.4074,  // åŒ—äº¬ç»åº¦
        sceneType: DunjiaSceneType.GENERAL_STUDY
      };
      
      this.panResult = await this.engine.computePan(input);
      
      this.loading = false;
    } catch (err) {
      console.error('æ’ç›˜è®¡ç®—å¤±è´¥', err);
      this.loading = false;
    }
  }

  private loadZeriAndSanqiJson() {
    try {
      const context = getContext(this);
      if (!context || !context.resourceManager || !context.resourceManager.getRawFileContent) {
        console.error('[SanqiZheriPage] æ— æ³•è·å–èµ„æºç®¡ç†å™¨');
        return;
      }

      context.resourceManager.getRawFileContent('rules/sanqi_yingyan_rules.json')
        .then((data: Uint8Array) => {
          const jsonStr = this.decodeUtf8(data);
          let parsed: RulesJsonFile | null = null;
          try {
            parsed = JSON.parse(jsonStr) as RulesJsonFile;
          } catch (e) {
            console.error('[SanqiZheriPage] è§£æä¸‰å¥‡åº”éªŒ JSON å¤±è´¥', JSON.stringify(e));
            return;
          }
          if (parsed && parsed.rules && Array.isArray(parsed.rules)) {
            const names: string[] = [];
            for (let i = 0; i < parsed.rules.length; i++) {
              const rule = parsed.rules[i];
              if (rule && typeof rule.name === 'string') {
                names.push(rule.name);
              }
            }
            if (names.length > 0) {
              this.sanqiJsonSummary = 'ä¸‰å¥‡åº”éªŒ JSON åŒ…å«ï¼š' + names.join('ã€') + ' ç­‰è§„åˆ™ã€‚';
            }
          }
        })
        .catch((err: Error) => {
          console.error('[SanqiZheriPage] è¯»å–ä¸‰å¥‡åº”éªŒ JSON å¤±è´¥', JSON.stringify(err));
        });

      context.resourceManager.getRawFileContent('rules/zeri_yingyong_rules.json')
        .then((data: Uint8Array) => {
          const jsonStr = this.decodeUtf8(data);
          let parsed: RulesJsonFile | null = null;
          try {
            parsed = JSON.parse(jsonStr) as RulesJsonFile;
          } catch (e) {
            console.error('[SanqiZheriPage] è§£ææ‹©æ—¥åº”ç”¨ JSON å¤±è´¥', JSON.stringify(e));
            return;
          }
          if (parsed && parsed.rules && Array.isArray(parsed.rules)) {
            let summary: string = '';
            const riTypeMap: Record<string, GanzhiTypeInfo> = {};
            for (let i = 0; i < parsed.rules.length; i++) {
              const rule: RulesJsonRule | undefined = parsed.rules[i];
              if (!rule || !rule.id) {
                continue;
              }
              if (rule.id === 'wulei_ri_ji_xiong') {
                if (rule.summary && typeof rule.summary === 'string') {
                  summary = rule.summary;
                }
                if (rule.types && Array.isArray(rule.types)) {
                  for (let j = 0; j < rule.types.length; j++) {
                    const typeInfo: ZeriRiType | undefined = rule.types[j];
                    if (!typeInfo || !typeInfo.type || !typeInfo.examples || !Array.isArray(typeInfo.examples)) {
                      continue;
                    }
                    const typeName: string = typeInfo.type;
                    let level: number = 3;
                    let color: string = '#4CAF50';
                    if (typeName === 'å®æ—¥') {
                      level = 5;
                      color = '#FFD700';
                    } else if (typeName === 'ä¼æ—¥') {
                      level = 0;
                      color = '#F44336';
                    } else if (typeName === 'åˆ¶æ—¥') {
                      level = 3;
                      color = '#FF9800';
                    } else if (typeName === 'ä¹‰æ—¥' || typeName === 'å’Œæ—¥') {
                      level = 4;
                      color = '#4CAF50';
                    }
                    for (let k = 0; k < typeInfo.examples.length; k++) {
                      const exampleGanzhi: string = typeInfo.examples[k];
                      if (typeof exampleGanzhi === 'string' && exampleGanzhi !== '') {
                        riTypeMap[exampleGanzhi] = {
                          type: typeName,
                          level: level,
                          color: color
                        };
                      }
                    }
                  }
                }
              }
              if (rule.id === 'wuyang_wuyin_shi') {
                const yangInfo: WuyangTimeBlock | undefined = rule.yangTime;
                const yinInfo: WuyangTimeBlock | undefined = rule.yinTime;
                if (yangInfo) {
                  this.yangTimeInfoFromJson = yangInfo;
                }
                if (yinInfo) {
                  this.yinTimeInfoFromJson = yinInfo;
                }
              }
            }
            if (summary !== '') {
              this.zeriJsonSummary = summary;
            }
            if (Object.keys(riTypeMap).length > 0) {
              this.riTypeMapFromJson = riTypeMap;
            }
          }
        })
        .catch((err: Error) => {
          console.error('[SanqiZheriPage] è¯»å–æ‹©æ—¥åº”ç”¨ JSON å¤±è´¥', JSON.stringify(err));
        });

      context.resourceManager.getRawFileContent('rules/shensha_rules.json')
        .then((data: Uint8Array) => {
          const jsonStr = this.decodeUtf8(data);
          let parsed: RulesJsonFile | null = null;
          try {
            parsed = JSON.parse(jsonStr) as RulesJsonFile;
          } catch (e) {
            console.error('[SanqiZheriPage] è§£æç¥ç… JSON å¤±è´¥', JSON.stringify(e));
            return;
          }
          if (parsed && parsed.rules && Array.isArray(parsed.rules)) {
            const names: string[] = [];
            for (let i = 0; i < parsed.rules.length; i++) {
              const rule = parsed.rules[i];
              if (rule && typeof rule.name === 'string') {
                names.push(rule.name);
              }
            }
            if (names.length > 0) {
              this.shenshaJsonSummary = 'ç¥ç… JSON åŒ…å«ï¼š' + names.join('ã€') + ' ç­‰è§„åˆ™ã€‚';
            }
          }
        })
        .catch((err: Error) => {
          console.error('[SanqiZheriPage] è¯»å–ç¥ç… JSON å¤±è´¥', JSON.stringify(err));
        });
    } catch (e) {
      console.error('[SanqiZheriPage] loadZeriAndSanqiJson å¼‚å¸¸', JSON.stringify(e));
    }
  }

  private decodeUtf8(bytes: Uint8Array): string {
    let out = '';
    let i = 0;
    while (i < bytes.length) {
      const c = bytes[i++];
      if (c < 0x80) {
        out += String.fromCharCode(c);
      } else if ((c & 0xe0) === 0xc0 && i < bytes.length) {
        const c2 = bytes[i++];
        const code = ((c & 0x1f) << 6) | (c2 & 0x3f);
        out += String.fromCharCode(code);
      } else if ((c & 0xf0) === 0xe0 && i + 1 < bytes.length) {
        const c2 = bytes[i++];
        const c3 = bytes[i++];
        const code = ((c & 0x0f) << 12) | ((c2 & 0x3f) << 6) | (c3 & 0x3f);
        out += String.fromCharCode(code);
      } else if ((c & 0xf8) === 0xf0 && i + 2 < bytes.length) {
        const c2 = bytes[i++];
        const c3 = bytes[i++];
        const c4 = bytes[i++];
        let codePoint = ((c & 0x07) << 18) | ((c2 & 0x3f) << 12) | ((c3 & 0x3f) << 6) | (c4 & 0x3f);
        codePoint -= 0x10000;
        const high = 0xd800 + (codePoint >> 10);
        const low = 0xdc00 + (codePoint & 0x3ff);
        out += String.fromCharCode(high, low);
      } else {
        out += '?';
      }
    }
    return out;
  }

  /**
   * è·å–æ—¥å¹²æ”¯ç±»å‹(å®æ—¥/ä¹‰æ—¥/åˆ¶æ—¥/å’Œæ—¥/ä¼æ—¥)
   */
  private getRiGanzhiType(): GanzhiTypeInfo {
    if (!this.panResult || !this.panResult.dayInfo) return { type: 'æœªçŸ¥', level: 0, color: '#999999' };

    const riGanzhi = `${this.panResult.dayInfo.day_gan}${this.panResult.dayInfo.day_zhi}`;
    if (this.riTypeMapFromJson && this.riTypeMapFromJson[riGanzhi]) {
      return this.riTypeMapFromJson[riGanzhi];
    }
    return { type: 'å’Œæ—¥', level: 3, color: '#4CAF50' };
  }
    
  /**
   * è·å–æ—¶è¾°å±æ€§(äº”é˜³æ—¶/äº”é˜´æ—¶)
   */
  private getShichenType(): ShichenTypeInfo {
    if (!this.panResult || !this.panResult.hourGanZhi) return { type: 'æœªçŸ¥', desc: '', color: '#999999' };

    const shiGan: string = this.panResult.hourGanZhi.charAt(0);
    let isYang: boolean | null = null;

    if (this.yangTimeInfoFromJson && this.yangTimeInfoFromJson.stems && Array.isArray(this.yangTimeInfoFromJson.stems)) {
      if (this.yangTimeInfoFromJson.stems.indexOf(shiGan) >= 0) {
        isYang = true;
      }
    }
    if (isYang === null && this.yinTimeInfoFromJson && this.yinTimeInfoFromJson.stems && Array.isArray(this.yinTimeInfoFromJson.stems)) {
      if (this.yinTimeInfoFromJson.stems.indexOf(shiGan) >= 0) {
        isYang = false;
      }
    }

    // å¦‚æœ JSON æ²¡æœ‰è¦†ç›–åˆ°å½“å‰æ—¶å¹², é€€å›åˆ°åŸæ¥çš„å¹²ç±»åˆ¤æ–­
    if (isYang === null) {
      const yangGanFallback: string[] = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ'];
      isYang = yangGanFallback.includes(shiGan);
    }

    if (isYang) {
      let descParts: string[] = [];
      if (this.yangTimeInfoFromJson) {
        if (this.yangTimeInfoFromJson.attribute && typeof this.yangTimeInfoFromJson.attribute === 'string') {
          descParts.push(this.yangTimeInfoFromJson.attribute);
        }
        if (this.yangTimeInfoFromJson.strategy && typeof this.yangTimeInfoFromJson.strategy === 'string') {
          descParts.push(this.yangTimeInfoFromJson.strategy);
        }
      }
      const desc: string = descParts.length > 0 ? descParts.join('ï¼Œ') : 'åˆ©å®¢å…ˆå‘,é«˜æ——é¸£é¼“';
      return {
        type: 'äº”é˜³æ—¶',
        desc: desc,
        color: '#FF9800'
      };
    } else {
      let descParts2: string[] = [];
      if (this.yinTimeInfoFromJson) {
        if (this.yinTimeInfoFromJson.attribute && typeof this.yinTimeInfoFromJson.attribute === 'string') {
          descParts2.push(this.yinTimeInfoFromJson.attribute);
        }
        if (this.yinTimeInfoFromJson.strategy && typeof this.yinTimeInfoFromJson.strategy === 'string') {
          descParts2.push(this.yinTimeInfoFromJson.strategy);
        }
      }
      const desc2: string = descParts2.length > 0 ? descParts2.join('ï¼Œ') : 'åˆ©ä¸»ååŠ¨,ä½æ——è¡”æ•';
      return {
        type: 'äº”é˜´æ—¶',
        desc: desc2,
        color: '#3F51B5'
      };
    }
  }
    
  /**
   * æ£€æŸ¥äº”ä¸è¿‡æ—¶æ ¼å±€
   */
  private checkWuBuGuoShi(): boolean {
    if (!this.panResult || !this.panResult.dayInfo || !this.panResult.hourGanZhi) return false;
      
    const dayGan = this.panResult.dayInfo.day_gan;
    const hourGan = this.panResult.hourGanZhi.charAt(0);
      
    // äº”ä¸è¿‡æ—¶:æ—¶å¹²å…‹æ—¥å¹²
    const keMap: Record<string, string> = {
      'ç”²': 'åºš',  // ç”²æ—¥åºšæ—¶(åºšå…‹ç”²)
      'ä¹™': 'è¾›',  // ä¹™æ—¥è¾›æ—¶(è¾›å…‹ä¹™)
      'ä¸™': 'å£¬',  // ä¸™æ—¥å£¬æ—¶(å£¬å…‹ä¸™)
      'ä¸': 'ç™¸',  // ä¸æ—¥ç™¸æ—¶(ç™¸å…‹ä¸)
      'æˆŠ': 'ç”²',  // æˆŠæ—¥ç”²æ—¶(ç”²å…‹æˆŠ)
      'å·±': 'ä¹™',  // å·±æ—¥ä¹™æ—¶(ä¹™å…‹å·±)
      'åºš': 'ä¸™',  // åºšæ—¥ä¸™æ—¶(ä¸™å…‹åºš)
      'è¾›': 'ä¸',  // è¾›æ—¥ä¸æ—¶(ä¸å…‹è¾›)
      'å£¬': 'æˆŠ',  // å£¬æ—¥æˆŠæ—¶(æˆŠå…‹å£¬)
      'ç™¸': 'å·±'   // ç™¸æ—¥å·±æ—¶(å·±å…‹ç™¸)
    };
      
    return keMap[dayGan] === hourGan;
  }
    
  /**
   * æ£€æŸ¥äº”ä¸å¯å‡»å®«ä½(å¤©ä¹™/ä¹å¤©/ç”Ÿé—¨/ä¹åœ°/ç›´ä½¿)
   */
  private getWuBuKeJiPalaces(): number[] {
    if (!this.panResult) return [];
      
    const forbiddenPalaces: number[] = [];
      
    // 1. å¤©ä¹™å®«(å€¼ç¬¦å®«)
    forbiddenPalaces.push(this.panResult.zhiFuPalace);
      
    // 2. ç›´ä½¿å®«
    forbiddenPalaces.push(this.panResult.zhiShiPalace);
      
    // 3. ä¹å¤©å®«
    const jiuTianPalace = this.panResult.palaces.findIndex(p => p.deityName === 'ä¹å¤©');
    if (jiuTianPalace !== -1) forbiddenPalaces.push(jiuTianPalace);
      
    // 4. ä¹åœ°å®«
    const jiuDiPalace = this.panResult.palaces.findIndex(p => p.deityName === 'ä¹åœ°');
    if (jiuDiPalace !== -1) forbiddenPalaces.push(jiuDiPalace);
      
    // 5. ç”Ÿé—¨å®«
    const shengMenPalace = this.panResult.palaces.findIndex(p => p.doorName === 'ç”Ÿé—¨');
    if (shengMenPalace !== -1) forbiddenPalaces.push(shengMenPalace);
      
    // å»é‡
    const uniquePalaces: number[] = [];
    for (const palace of forbiddenPalaces) {
      if (!uniquePalaces.includes(palace)) {
        uniquePalaces.push(palace);
      }
    }
    return uniquePalaces;
  }
  
  /**
   * è·å–æ‹©æ—¥å»ºè®®
   */
  private getZheriSuggestion(): string {
    const riType = this.getRiGanzhiType();
    const shiType = this.getShichenType();
    const wuBuGuoShi = this.checkWuBuGuoShi();
      
    // äº”ä¸è¿‡æ—¶å¼ºå‡¶è­¦å‘Š
    if (wuBuGuoShi) {
      return `ä»Šæ—¥ä»Šæ—¶çŠ¯äº”ä¸è¿‡æ—¶æ ¼å±€ï¼æ—¶å¹²å…‹æ—¥å¹²,çºµæœ‰å‰é—¨äº¦å‡¶,ç™¾äº‹ä¸å®œã€‚`;
    }
      
    if (riType.level === 5) {
      return `ä»Šæ—¥${riType.type},ç™¾äº‹çš†å®œã€‚${shiType.desc}ã€‚`;
    } else if (riType.level === 0) {
      return `ä»Šæ—¥${riType.type},ç™¾äº‹å¿Œç”¨!å°¤å…¶ä¸å¯å‡ºå†›ã€‚`;
    } else {
      return `ä»Šæ—¥${riType.type},å¯åŠä¸€èˆ¬äº‹åŠ¡ã€‚${shiType.desc}ã€‚`;
    }
  }

  build() {
    Column() {
      if (this.loading) {
        Column() {
          Text('æ’ç›˜è®¡ç®—ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // é¡¶éƒ¨æ‹©æ—¥ä¿¡æ¯æ 
        Column({ space: 12 }) {
        // æ ‡é¢˜
        Text('ä¸‰å¥‡åº”éªŒæ‹©æ—¥')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C2416')
        
        // æ—¥æœŸé€‰æ‹©æŒ‰é’®
        Button() {
          Row({ space: 8 }) {
            Text('ğŸ“…')
              .fontSize(16)
            if (this.panResult && this.panResult.dayInfo) {
              Text(`${this.panResult.dayInfo.year}å¹´${this.panResult.dayInfo.month}æœˆ${this.panResult.dayInfo.day}æ—¥`)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
            } else {
              Text('é€‰æ‹©æ—¥æœŸ')
                .fontSize(14)
            }
          }
        }
        .backgroundColor('#F5F5F5')
        .borderRadius(8)
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .onClick(() => {
          DatePickerDialog.show({
            start: new Date('1900-1-1'),
            end: new Date('2100-12-31'),
            selected: this.currentDateTime,
            onAccept: (value: DatePickerResult) => {
              this.currentDateTime = new Date(value.year!, value.month! + 1, value.day!);
              this.computePan();
            }
          })
        })
        
        // æ—¥å¹²æ”¯ä¿¡æ¯
        Row({ space: 16 }) {
          Row({ space: 8 }) {
            Text('æ—¥å¹²æ”¯:')
              .fontSize(13)
              .fontColor('#666666')
            if (this.panResult && this.panResult.dayInfo) {
              Text(`${this.panResult.dayInfo.day_gan}${this.panResult.dayInfo.day_zhi}`)
                .fontSize(15)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.getRiGanzhiType().color)
            }
            Text(`(${this.getRiGanzhiType().type})`)
              .fontSize(12)
              .fontColor(this.getRiGanzhiType().color)
              .padding({ left: 2, right: 6, top: 2, bottom: 2 })
              .backgroundColor(this.getRiGanzhiType().color + '22')
              .borderRadius(4)
          }
          
          Row({ space: 8 }) {
            Text('æ—¶è¾°:')
              .fontSize(13)
              .fontColor('#666666')
            if (this.panResult && this.panResult.hourGanZhi) {
              Text(`${this.panResult.hourGanZhi}æ—¶`)
                .fontSize(15)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.getShichenType().color)
            }
            Text(`(${this.getShichenType().type})`)
              .fontSize(12)
              .fontColor(this.getShichenType().color)
              .padding({ left: 2, right: 6, top: 2, bottom: 2 })
              .backgroundColor(this.getShichenType().color + '22')
              .borderRadius(4)
          }
        }
        .width('100%')
        
        // æ‹©æ—¥å»ºè®®
        Column({ space: 8 }) {
          Text(this.getZheriSuggestion())
            .fontSize(13)
            .fontColor(this.checkWuBuGuoShi() ? '#F44336' : '#2C2416')
            .lineHeight(20)
            .width('100%')
            .padding(12)
            .backgroundColor(this.checkWuBuGuoShi() ? '#FFEBEE' : '#FFF8F0')
            .borderRadius(8)
            .border({ width: 1, color: this.checkWuBuGuoShi() ? '#FFCDD2' : '#FFE4B5' })
                   
          // äº”ä¸å¯å‡»å®«ä½æç¤º
          if (this.getWuBuKeJiPalaces().length > 0) {
            Row({ space: 4 }) {
              Text('âš ï¸')
                .fontSize(12)
              Text('äº”ä¸å¯å‡»å®«ä½:')
                .fontSize(12)
                .fontColor('#666666')
              ForEach(this.getWuBuKeJiPalaces(), (palaceIndex: number) => {
                if (this.panResult && this.panResult.palaces[palaceIndex]) {
                  Text(this.panResult.palaces[palaceIndex].palaceName)
                    .fontSize(11)
                    .fontColor('#FF9800')
                    .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                    .backgroundColor('#FFF3E0')
                    .borderRadius(4)
                }
              })
            }
            .width('100%')
            .padding(10)
            .backgroundColor('#FFFBF5')
            .borderRadius(6)
          }
        
          // ä¸­å·/ä¸‹å· JSON è§„åˆ™æ¦‚è§ˆ
          if (this.sanqiJsonSummary !== '' || this.zeriJsonSummary !== '' || this.shenshaJsonSummary !== '') {
            Column({ space: 4 }) {
              if (this.sanqiJsonSummary !== '') {
                Text(this.sanqiJsonSummary)
                  .fontSize(12)
                  .fontColor('#4A3B20')
                  .lineHeight(18)
                  .width('100%')
              }
              if (this.zeriJsonSummary !== '') {
                Text(this.zeriJsonSummary)
                  .fontSize(12)
                  .fontColor('#4A3B20')
                  .lineHeight(18)
                  .width('100%')
              }
              if (this.shenshaJsonSummary !== '') {
                Text(this.shenshaJsonSummary)
                  .fontSize(12)
                  .fontColor('#4A3B20')
                  .lineHeight(18)
                  .width('100%')
              }
            }
            .width('100%')
            .padding(10)
            .backgroundColor('#F7F5ED')
            .borderRadius(6)
          }
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 4, color: '#22000000', offsetX: 0, offsetY: 2 })

      Scroll(this.scroller) {
        Column({ space: 16 }) {
          // ä¹å®«æ’ç›˜(ä¸“ç”¨æ‹©æ—¥ç»„ä»¶)
          if (this.panResult) {
            SanqiNineGrid({
              panResult: this.panResult,
              selectedPalace: this.selectedPalace,
              onPalaceClick: (index: number) => {
                this.selectedPalace = index;
              }
            })
          }

          // ä¸‰å¥‡åº”éªŒå®«ä½è¯¦æƒ…é¢æ¿
          if (this.selectedPalace !== null) {
            SanqiPalaceDetailPanel({
              panResult: this.panResult,
              selectedPalace: this.selectedPalace
            })
          }
        }
        .width('100%')
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
