import router from '@ohos.router'
import { DunjiaEngine, DunjiaPanResult, DunjiaInput, DunjiaSceneType } from '../utils/DunjiaEngine'
import { DunjiaNineGrid } from '../components/DunjiaNineGrid'
import { DunjiaPalaceDetail } from '../components/DunjiaPalaceDetail'
import { NavigationBar } from '../components/NavigationBar'

/**
 * ç”¨ç¥ä¿¡æ¯æ¥å£
 */
interface YongshenElement {
  element: string;
  elementType: string;
  reason: string;
}

interface AffairCategory {
  id: string;
  name: string;
  icon?: string;
  description?: string;
  primaryYongshen?: YongshenElement[];
  secondaryYongshen?: YongshenElement[];
  judgmentLogic?: string[];
  directionRule?: string;
  timingHints?: string[];
}

interface YongshenMappingFile {
  title?: string;
  categories?: AffairCategory[];
}

/**
 * ä¸‰å¥‡åº”éªŒè§„åˆ™æ¥å£
 */
interface AffairSpecificMeanings {
  find_person?: string;
  find_object?: string;
  travel?: string;
  marriage?: string;
  job_interview?: string;
  wealth?: string;
  exam?: string;
  health?: string;
}

interface SanqiPosition {
  qi: string;
  palace: string;
}

interface SanqiSubRule {
  subId: string;
  palace: string;
  direction: string;
  signs: string[];
  timeWindow: string;
  fortune: string;
  tips: string;
  affairSpecificMeanings?: AffairSpecificMeanings;
}

interface SanqiRule {
  id: string;
  name: string;
  category: string;
  ruleSource: string;
  description: string;
  sub_rules?: SanqiSubRule[];
}

interface SanqiRulesFile {
  volume?: string;
  title?: string;
  rules?: SanqiRule[];
}

/**
 * å¥‡é—¨éç”²ä¹å®«ç›˜é¡µé¢
 * èŒè´£ï¼šé¡µé¢çŠ¶æ€ç®¡ç†ã€ç»„ä»¶ç»„åˆã€ç”¨ç¥å æ–­æŒ‡å¼•
 */
@Entry
@Component
struct DunjiaPalacePage {
  @State panResult: DunjiaPanResult | null = null
  @State selectedPalace: number | null = null
  @State loading: boolean = true
  @State currentDateTime: Date = new Date()
  @State selectedAffair: string | null = null
  @State currentAffairInfo: AffairCategory | null = null
  @State showYongshenPanel: boolean = false
  @State affairCategories: AffairCategory[] = []
  @State sanqiRules: SanqiRule[] = []
  @State currentSanqiMeanings: SanqiSubRule[] = []
  
  private engine: DunjiaEngine = DunjiaEngine.getInstance()

  aboutToAppear() {
    // ä»è·¯ç”±å‚æ•°è·å–æ—¶é—´ä¿¡æ¯
    const params = router.getParams() as Record<string, Object>
    if (params && params['timestamp']) {
      // æ¥æ”¶æ—¶é—´æˆ³å¹¶é‡å»º Date å¯¹è±¡
      const timestamp = params['timestamp'] as number
      this.currentDateTime = new Date(timestamp)
    }
    
    // åŠ è½½ç”¨ç¥æ˜ å°„è§„åˆ™
    this.loadYongshenRules()
    
    // åŠ è½½ä¸‰å¥‡åº”éªŒè§„åˆ™
    this.loadSanqiRules()
    
    // æ‰§è¡Œæ’ç›˜è®¡ç®—
    this.computePan()
  }

  /**
   * åŠ è½½ç”¨ç¥æ˜ å°„è§„åˆ™
   */
  private loadYongshenRules() {
    try {
      const context = getContext(this);
      if (!context || !context.resourceManager || !context.resourceManager.getRawFileContent) {
        console.error('[DunjiaPalacePage] æ— æ³•è·å–èµ„æºç®¡ç†å™¨');
        return;
      }

      context.resourceManager.getRawFileContent('rules/yongshen_mapping_rules.json')
        .then((data: Uint8Array) => {
          const jsonStr = this.decodeUtf8(data);
          let parsed: YongshenMappingFile | null = null;
          try {
            parsed = JSON.parse(jsonStr) as YongshenMappingFile;
          } catch (e) {
            console.error('[DunjiaPalacePage] è§£æç”¨ç¥è§„åˆ™ JSON å¤±è´¥', JSON.stringify(e));
            return;
          }
          if (parsed && parsed.categories && Array.isArray(parsed.categories)) {
            this.affairCategories = parsed.categories;
          }
        })
        .catch((err: Error) => {
          console.error('[DunjiaPalacePage] è¯»å–ç”¨ç¥è§„åˆ™ JSON å¤±è´¥', JSON.stringify(err));
        });
    } catch (e) {
      console.error('[DunjiaPalacePage] loadYongshenRules å¼‚å¸¸', JSON.stringify(e));
    }
  }

  /**
   * åŠ è½½ä¸‰å¥‡åº”éªŒè§„åˆ™
   */
  private loadSanqiRules() {
    try {
      const context = getContext(this);
      if (!context || !context.resourceManager || !context.resourceManager.getRawFileContent) {
        console.error('[DunjiaPalacePage] æ— æ³•è·å–èµ„æºç®¡ç†å™¨');
        return;
      }

      context.resourceManager.getRawFileContent('rules/sanqi_yingyan_rules.json')
        .then((data: Uint8Array) => {
          const jsonStr = this.decodeUtf8(data);
          let parsed: SanqiRulesFile | null = null;
          try {
            parsed = JSON.parse(jsonStr) as SanqiRulesFile;
          } catch (e) {
            console.error('[DunjiaPalacePage] è§£æä¸‰å¥‡è§„åˆ™ JSON å¤±è´¥', JSON.stringify(e));
            return;
          }
          if (parsed && parsed.rules && Array.isArray(parsed.rules)) {
            this.sanqiRules = parsed.rules;
          }
        })
        .catch((err: Error) => {
          console.error('[DunjiaPalacePage] è¯»å–ä¸‰å¥‡è§„åˆ™ JSON å¤±è´¥', JSON.stringify(err));
        });
    } catch (e) {
      console.error('[DunjiaPalacePage] loadSanqiRules å¼‚å¸¸', JSON.stringify(e));
    }
  }

  private decodeUtf8(bytes: Uint8Array): string {
    let out = '';
    let i = 0;
    while (i < bytes.length) {
      const c = bytes[i++];
      if (c < 0x80) {
        out += String.fromCharCode(c);
      } else if ((c & 0xe0) === 0xc0 && i < bytes.length) {
        const c2 = bytes[i++];
        const code = ((c & 0x1f) << 6) | (c2 & 0x3f);
        out += String.fromCharCode(code);
      } else if ((c & 0xf0) === 0xe0 && i + 1 < bytes.length) {
        const c2 = bytes[i++];
        const c3 = bytes[i++];
        const code = ((c & 0x0f) << 12) | ((c2 & 0x3f) << 6) | (c3 & 0x3f);
        out += String.fromCharCode(code);
      } else if ((c & 0xf8) === 0xf0 && i + 2 < bytes.length) {
        const c2 = bytes[i++];
        const c3 = bytes[i++];
        const c4 = bytes[i++];
        let codePoint = ((c & 0x07) << 18) | ((c2 & 0x3f) << 12) | ((c3 & 0x3f) << 6) | (c4 & 0x3f);
        codePoint -= 0x10000;
        const high = 0xd800 + (codePoint >> 10);
        const low = 0xdc00 + (codePoint & 0x3ff);
        out += String.fromCharCode(high, low);
      } else {
        out += '?';
      }
    }
    return out;
  }

  /**
   * æ’ç›˜è®¡ç®—
   */
  private async computePan() {
    try {
      this.loading = true
      
      const input: DunjiaInput = {
        dateTime: this.currentDateTime,
        longitude: 116.4074,  // åŒ—äº¬ç»åº¦ï¼Œå®é™…åº”ä»é…ç½®æˆ–å®šä½è·å–
        sceneType: DunjiaSceneType.GENERAL_STUDY  // æ™®é€šç ”ä¹ 
      }
      
      // è°ƒç”¨æ’ç›˜å¼•æ“ï¼ˆå¼‚æ­¥ï¼‰
      this.panResult = await this.engine.computePan(input)
      
      this.loading = false
    } catch (err) {
      console.error('æ’ç›˜è®¡ç®—å¤±è´¥', err)
      this.loading = false
    }
  }

  /**
   * å®«ä½ç‚¹å‡»å›è°ƒ
   */
  private onPalaceClick = (index: number) => {
    if (this.selectedPalace === index) {
      this.selectedPalace = null  // å†æ¬¡ç‚¹å‡»å–æ¶ˆé€‰ä¸­
    } else {
      this.selectedPalace = index
    }
  }

  /**
   * è°ƒæ•´æ—¶é—´
   */
  private adjustTime(hours: number) {
    const newDateTime = new Date(this.currentDateTime.getTime() + hours * 60 * 60 * 1000);
    this.currentDateTime = newDateTime;
    this.selectedPalace = null; // æ¸…é™¤é€‰ä¸­çŠ¶æ€
    this.computePan();
  }

  /**
   * æ¢å¤åˆ°å½“å‰ç³»ç»Ÿæ—¶é—´
   */
  private resetToCurrentTime() {
    this.currentDateTime = new Date();
    this.selectedPalace = null;
    this.computePan();
  }

  /**
   * åˆ‡æ¢æ—¶è¾°ï¼ˆè·³è½¬åˆ°æŒ‡å®šæ—¶è¾°çš„èµ·å§‹æ—¶åˆ»ï¼‰
   */
  private switchToShichen(shiIndex: number) {
    interface ShichenInfo {
      name: string;
      hour: number;
    }

    const shiMap: ShichenInfo[] = [
      { name: 'å­æ—¶', hour: 23 },
      { name: 'ä¸‘æ—¶', hour: 1 },
      { name: 'å¯…æ—¶', hour: 3 },
      { name: 'å¯æ—¶', hour: 5 },
      { name: 'è¾°æ—¶', hour: 7 },
      { name: 'å·³æ—¶', hour: 9 },
      { name: 'åˆæ—¶', hour: 11 },
      { name: 'æœªæ—¶', hour: 13 },
      { name: 'ç”³æ—¶', hour: 15 },
      { name: 'é…‰æ—¶', hour: 17 },
      { name: 'æˆŒæ—¶', hour: 19 },
      { name: 'äº¥æ—¶', hour: 21 }
    ];
    
    if (shiIndex >= 0 && shiIndex < shiMap.length) {
      const targetHour = shiMap[shiIndex].hour;
      const newDateTime = new Date(this.currentDateTime);
      newDateTime.setHours(targetHour, 0, 0, 0); // è®¾ç½®ä¸ºæ—¶è¾°èµ·å§‹æ—¶åˆ»
      this.currentDateTime = newDateTime;
      this.selectedPalace = null;
      this.computePan();
    }
  }

  /**
   * é€‰æ‹©å æ–­äº‹ç±»
   */
  private selectAffair(affairId: string) {
    this.selectedAffair = affairId;
    const affair = this.affairCategories.find(a => a.id === affairId);
    if (affair) {
      this.currentAffairInfo = affair;
      this.showYongshenPanel = true;
      this.filterSanqiMeanings(affairId);
    }
  }

  /**
   * ç­›é€‰ä¸‰å¥‡è±¡æ„ï¼šæ ¹æ®å½“å‰äº‹ç±»å’Œç›˜é¢ä¸­çš„ä¸‰å¥‡ä½ç½®
   */
  private filterSanqiMeanings(affairId: string) {
    this.currentSanqiMeanings = [];
    
    if (!this.panResult || !this.panResult.palaces) {
      return;
    }
    
    // è·å–å½“å‰ç›˜é¢ä¸­çš„ä¸‰å¥‡ä½ç½®
    const sanqiPositions: SanqiPosition[] = [];
    
    this.panResult.palaces.forEach(palace => {
      if (palace.tianGan) {
        const gan = palace.tianGan;
        if (gan === 'ä¹™' || gan === 'ä¸™' || gan === 'ä¸') {
          // å°†å®«ä½åè½¬æ¢ä¸ºè§„åˆ™ä¸­çš„æ ¼å¼ï¼ˆå¦‚"ä¸€å®«å"è½¬ä¸º"åä¸€"ï¼‰
          let palaceName = '';
          switch(palace.palaceName) {
            case 'ä¸€å®«å': palaceName = 'åä¸€'; break;
            case 'äºŒå®«å¤': palaceName = 'å¤äºŒ'; break;
            case 'ä¸‰å®«éœ‡': palaceName = 'éœ‡ä¸‰'; break;
            case 'å››å®«å·½': palaceName = 'å·½å››'; break;
            case 'äº”å®«ä¸­': palaceName = 'ä¸­äº”'; break;
            case 'å…­å®«ä¹¾': palaceName = 'ä¹¾å…­'; break;
            case 'ä¸ƒå®«å…‘': palaceName = 'å…‘ä¸ƒ'; break;
            case 'å…«å®«è‰®': palaceName = 'è‰®å…«'; break;
            case 'ä¹å®«ç¦»': palaceName = 'ç¦»ä¹'; break;
          }
          
          if (palaceName) {
            const pos: SanqiPosition = { qi: gan, palace: palaceName };
            sanqiPositions.push(pos);
          }
        }
      }
    });
    
    if (sanqiPositions.length === 0) {
      return;
    }
    
    // æ ¹æ®ä¸‰å¥‡ä½ç½®ç­›é€‰å¯¹åº”çš„è±¡æ„
    this.sanqiRules.forEach(rule => {
      if (!rule.sub_rules) return;
      
      // ç¡®å®šè§„åˆ™ç±»å‹ï¼šæ—¥å¥‡ã€æœˆå¥‡ã€æ˜Ÿå¥‡
      let qiType = '';
      if (rule.id === 'riqi_yingyan') {
        qiType = 'ä¹™'; // æ—¥å¥‡
      } else if (rule.id === 'yueqi_yingyan') {
        qiType = 'ä¸™'; // æœˆå¥‡
      } else if (rule.id === 'dingqi_yingyan') {
        qiType = 'ä¸'; // æ˜Ÿå¥‡
      }
      
      // æ£€æŸ¥è¯¥ç±»å¥‡æ˜¯å¦åœ¨å½“å‰ç›˜é¢ä¸­
      const qiPosition = sanqiPositions.find(p => p.qi === qiType);
      if (!qiPosition) return;
      
      const subRule = rule.sub_rules.find(sr => sr.palace === qiPosition.palace);
      if (subRule && subRule.affairSpecificMeanings) {
        const meaning = this.getMeaningByAffairId(subRule.affairSpecificMeanings, affairId);
        if (meaning) {
          this.currentSanqiMeanings.push(subRule);
        }
      }
    });
  }

  /**
   * æ ¹æ®subIdè·å–ä¸‰å¥‡åç§°
   */
  private getSanqiName(subId: string): string {
    if (subId.startsWith('riqi_')) {
      return 'ğŸŒ æ—¥å¥‡ï¼ˆä¹™ï¼‰';
    } else if (subId.startsWith('yueqi_')) {
      return 'ğŸŒ™ æœˆå¥‡ï¼ˆä¸™ï¼‰';
    } else if (subId.startsWith('dingqi_')) {
      return 'â­ æ˜Ÿå¥‡ï¼ˆä¸ï¼‰';
    }
    return 'ä¸‰å¥‡';
  }

  /**
   * æ ¹æ®äº‹ç±»IDè·å–è±¡æ„æ–‡æœ¬
   */
  private getMeaningByAffairId(meanings: AffairSpecificMeanings, affairId: string): string | undefined {
    switch(affairId) {
      case 'find_person': return meanings.find_person;
      case 'find_object': return meanings.find_object;
      case 'travel': return meanings.travel;
      case 'marriage': return meanings.marriage;
      case 'job_interview': return meanings.job_interview;
      case 'wealth': return meanings.wealth;
      case 'exam': return meanings.exam;
      case 'health': return meanings.health;
      default: return undefined;
    }
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰è±¡æ„
   */
  private hasMeaning(sanqi: SanqiSubRule): boolean {
    if (!sanqi.affairSpecificMeanings || !this.selectedAffair) {
      return false;
    }
    const meaning = this.getMeaningByAffairId(sanqi.affairSpecificMeanings, this.selectedAffair);
    return meaning !== undefined && meaning.length > 0;
  }

  /**
   * æ„å»ºä¸‰å¥‡è±¡æ„å†…å®¹
   */
  @Builder
  buildSanqiMeaning(sanqi: SanqiSubRule) {
    if (sanqi.affairSpecificMeanings && this.selectedAffair) {
      Text(this.getMeaningByAffairId(sanqi.affairSpecificMeanings, this.selectedAffair) || '')
        .fontSize(12)
        .fontColor('#333333')
        .lineHeight(20)
        .width('100%')
        .padding(10)
        .backgroundColor('#FFF8E1')
        .borderRadius(6)
        .visibility(this.hasMeaning(sanqi) ? Visibility.Visible : Visibility.None)
    }
  }

  /**
   * æ„å»ºä¸‰å¥‡æç¤º
   */
  @Builder
  buildSanqiTips(sanqi: SanqiSubRule) {
    if (sanqi.tips && !this.hasMeaning(sanqi)) {
      Row({ space: 6 }) {
        Text('ğŸ’¡')
          .fontSize(12)
        Text(sanqi.tips)
          .fontSize(11)
          .fontColor('#666666')
          .lineHeight(18)
          .layoutWeight(1)
      }
      .width('100%')
    }
  }

  /**
   * æ„å»ºäº‹ç±»é€‰æ‹©å™¨
   */
  @Builder
  buildAffairSelector() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('ğŸ¯ é€‰æ‹©å æ–­äº‹ç±»')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C2416')
          .layoutWeight(1)
        
        if (this.showYongshenPanel) {
          Button('æ”¶èµ·')
            .fontSize(12)
            .backgroundColor('#F5F1E8')
            .fontColor('#666666')
            .height(28)
            .onClick(() => {
              this.showYongshenPanel = false;
            })
        }
      }
      .width('100%')
      
      // å¸¸ç”¨äº‹ç±»å¿«æ·æŒ‰é’®
      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
        ForEach(this.affairCategories.slice(0, 8), (affair: AffairCategory) => {
          Button() {
            Row({ space: 4 }) {
              if (affair.icon) {
                Text(affair.icon)
                  .fontSize(14)
              }
              Text(affair.name)
                .fontSize(13)
                .fontColor(this.selectedAffair === affair.id ? '#FFFFFF' : '#2C2416')
            }
          }
          .backgroundColor(this.selectedAffair === affair.id ? '#FFD700' : '#FFFFFF')
          .borderRadius(8)
          .padding({ left: 10, right: 10, top: 6, bottom: 6 })
          .margin({ right: 8, bottom: 8 })
          .onClick(() => {
            this.selectAffair(affair.id);
          })
        })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 8, color: '#22000000', offsetX: 0, offsetY: 2 })
  }

  /**
   * æ„å»ºç”¨ç¥æŒ‡å¼•é¢æ¿
   */
  @Builder
  buildYongshenGuidance() {
    if (this.currentAffairInfo && this.showYongshenPanel) {
      Column({ space: 16 }) {
        // äº‹ç±»è¯´æ˜
        Row({ space: 8 }) {
          Text(this.currentAffairInfo.icon || 'ğŸ”®')
            .fontSize(20)
          Column({ space: 4 }) {
            Text(this.currentAffairInfo.name)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2C2416')
            if (this.currentAffairInfo.description) {
              Text(this.currentAffairInfo.description)
                .fontSize(12)
                .fontColor('#666666')
            }
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        
        // ä¸»ç”¨ç¥
        if (this.currentAffairInfo.primaryYongshen && this.currentAffairInfo.primaryYongshen.length > 0) {
          Column({ space: 8 }) {
            Text('ğŸ“ ä¸»ç”¨ç¥ï¼ˆé‡ç‚¹è§‚å¯Ÿï¼‰')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2C2416')
            
            ForEach(this.currentAffairInfo.primaryYongshen, (yong: YongshenElement) => {
              Row({ space: 10 }) {
                Text(yong.element)
                  .fontSize(13)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FF6B35')
                  .width(80)
                Text(yong.reason)
                  .fontSize(12)
                  .fontColor('#666666')
                  .lineHeight(18)
                  .layoutWeight(1)
              }
              .width('100%')
              .padding(10)
              .backgroundColor('#FFF8F0')
              .borderRadius(6)
            })
          }
          .width('100%')
        }
        
        // æ¬¡ç”¨ç¥
        if (this.currentAffairInfo.secondaryYongshen && this.currentAffairInfo.secondaryYongshen.length > 0) {
          Column({ space: 8 }) {
            Text('ğŸ” æ¬¡ç”¨ç¥ï¼ˆè¾…åŠ©å‚è€ƒï¼‰')
              .fontSize(13)
              .fontWeight(FontWeight.Bold)
              .fontColor('#666666')
            
            ForEach(this.currentAffairInfo.secondaryYongshen, (yong: YongshenElement) => {
              Row({ space: 10 }) {
                Text(yong.element)
                  .fontSize(12)
                  .fontColor('#3F51B5')
                  .width(80)
                Text(yong.reason)
                  .fontSize(11)
                  .fontColor('#999999')
                  .lineHeight(16)
                  .layoutWeight(1)
              }
              .width('100%')
              .padding(8)
              .backgroundColor('#F5F5F5')
              .borderRadius(6)
            })
          }
          .width('100%')
        }
        
        // åˆ¤æ–­é€»è¾‘
        if (this.currentAffairInfo.judgmentLogic && this.currentAffairInfo.judgmentLogic.length > 0) {
          Column({ space: 8 }) {
            Text('âš–ï¸ åˆ¤æ–­é€»è¾‘')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2C2416')
            
            ForEach(this.currentAffairInfo.judgmentLogic, (logic: string) => {
              Row({ space: 6 }) {
                Text('â€¢')
                  .fontSize(12)
                  .fontColor('#FF9800')
                Text(logic)
                  .fontSize(12)
                  .fontColor('#666666')
                  .lineHeight(20)
                  .layoutWeight(1)
              }
              .width('100%')
            })
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#FFFBF0')
          .borderRadius(8)
        }
        
        // æ–¹ä½æç¤º
        if (this.currentAffairInfo.directionRule) {
          Row({ space: 8 }) {
            Text('ğŸ§­')
              .fontSize(16)
            Text(this.currentAffairInfo.directionRule)
              .fontSize(12)
              .fontColor('#4A90E2')
              .lineHeight(18)
              .layoutWeight(1)
          }
          .width('100%')
          .padding(10)
          .backgroundColor('#E3F2FD')
          .borderRadius(6)
        }
        
        // ä¸‰å¥‡è±¡æ„ï¼ˆæ ¹æ®äº‹ç±»åŠ¨æ€å±•ç¤ºï¼‰
        if (this.currentSanqiMeanings.length > 0) {
          Column({ space: 12 }) {
            Text('âœ¨ ä¸‰å¥‡è±¡æ„æŒ‡å¼•')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2C2416')
            
            ForEach(this.currentSanqiMeanings, (sanqi: SanqiSubRule) => {
              Column({ space: 8 }) {
                // æ ‡é¢˜è¡Œï¼šä¸‰å¥‡åç§° + å®«ä½æ–¹ä½
                Row({ space: 8 }) {
                  // ç¡®å®šä¸‰å¥‡ç±»å‹
                  Text(this.getSanqiName(sanqi.subId))
                    .fontSize(14)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#FF6B35')
                  
                  Text(`${sanqi.palace}ï¼ˆ${sanqi.direction}ï¼‰`)
                    .fontSize(12)
                    .fontColor('#666666')
                  
                  Blank()
                  
                  Text(sanqi.fortune)
                    .fontSize(12)
                    .fontColor(sanqi.fortune === 'å¤§å‰' ? '#4CAF50' : sanqi.fortune === 'å‰' ? '#8BC34A' : '#FFC107')
                    .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                    .backgroundColor(sanqi.fortune === 'å¤§å‰' ? '#E8F5E9' : sanqi.fortune === 'å‰' ? '#F1F8E9' : '#FFF9C4')
                    .borderRadius(4)
                }
                .width('100%')
                
                // åº”éªŒå¾å…†
                if (sanqi.signs && sanqi.signs.length > 0) {
                  Row({ space: 6 }) {
                    Text('å¾å…†ï¼š')
                      .fontSize(11)
                      .fontColor('#999999')
                    Text(sanqi.signs.join('ã€'))
                      .fontSize(11)
                      .fontColor('#666666')
                      .layoutWeight(1)
                  }
                  .width('100%')
                }
                
                // æ—¶é—´çª—å£
                Row({ space: 6 }) {
                  Text('â±ï¸')
                    .fontSize(12)
                  Text(`æ—¶é—´çª—å£ï¼š${sanqi.timeWindow}`)
                    .fontSize(11)
                    .fontColor('#4A90E2')
                }
                .width('100%')
                
                // å…·ä½“äº‹ç±»è±¡æ„ï¼ˆä»affairSpecificMeaningsä¸­æå–ï¼‰
                this.buildSanqiMeaning(sanqi)
                
                // æ€»ä½“æç¤ºï¼ˆå¦‚æœæ²¡æœ‰å…·ä½“äº‹ç±»è±¡æ„åˆ™æ˜¾ç¤ºtipsï¼‰
                this.buildSanqiTips(sanqi)
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#FFFBF0')
              .borderRadius(8)
              .border({ width: 1, color: '#FFE082' })
            })
          }
          .width('100%')
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#ffffff')
      .borderRadius(12)
      .shadow({ radius: 8, color: '#22000000', offsetX: 0, offsetY: 2 })
    }
  }

  build() {
    Column({ space: 0 }) {
      // é¡¶éƒ¨å¯¼èˆªæ 
      NavigationBar({ title: 'ä¹å®«æ—¶ç©ºç›˜' })
  
      if (this.loading) {
        Column() {
          Text('æ’ç›˜è®¡ç®—ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // ä¸»å†…å®¹åŒºåŸŸï¼šä½¿ç”¨ScrollåŒ…è£¹ï¼Œä¹å®«ç›˜å’Œå®«ä½è¯¦æƒ…å‚ç›´æ’åˆ—
        Scroll() {
          Column({ space: 16 }) {
            // å æ–­äº‹ç±»é€‰æ‹©å™¨
            this.buildAffairSelector()
            
            // ç”¨ç¥æŒ‡å¼•é¢æ¿
            this.buildYongshenGuidance()
            
            // æ—¶é—´è°ƒæ•´æŒ‰é’®ç»„
            Column({ space: 12 }) {
              Row({ space: 8 }) {
                Text('â° æ—¶é—´å¾®è°ƒ')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#2C2416')
                  .layoutWeight(1)
                
                Button('æ¢å¤å½“å‰')
                  .fontSize(12)
                  .backgroundColor('#4A90E2')
                  .fontColor('#FFFFFF')
                  .height(32)
                  .padding({ left: 12, right: 12 })
                  .onClick(() => this.resetToCurrentTime())
              }
              .width('100%')
              
              // ç¬¬ä¸€è¡Œï¼šå‡å°‘æ—¶é—´
              Row({ space: 8 }) {
                Button('-2æ—¶è¾°')
                  .fontSize(13)
                  .backgroundColor('#F5F1E8')
                  .fontColor('#666666')
                  .layoutWeight(1)
                  .height(38)
                  .onClick(() => this.adjustTime(-4))
                
                Button('-1æ—¶è¾°')
                  .fontSize(13)
                  .backgroundColor('#F5F1E8')
                  .fontColor('#666666')
                  .layoutWeight(1)
                  .height(38)
                  .onClick(() => this.adjustTime(-2))
                
                Button('-1å°æ—¶')
                  .fontSize(13)
                  .backgroundColor('#F5F1E8')
                  .fontColor('#666666')
                  .layoutWeight(1)
                  .height(38)
                  .onClick(() => this.adjustTime(-1))
              }
              .width('100%')
              
              // ç¬¬äºŒè¡Œï¼šå¢åŠ æ—¶é—´
              Row({ space: 8 }) {
                Button('+1å°æ—¶')
                  .fontSize(13)
                  .backgroundColor('#D4A574')
                  .fontColor('#FFFFFF')
                  .layoutWeight(1)
                  .height(38)
                  .onClick(() => this.adjustTime(1))
                
                Button('+1æ—¶è¾°')
                  .fontSize(13)
                  .backgroundColor('#D4A574')
                  .fontColor('#FFFFFF')
                  .layoutWeight(1)
                  .height(38)
                  .onClick(() => this.adjustTime(2))
                
                Button('+2æ—¶è¾°')
                  .fontSize(13)
                  .backgroundColor('#D4A574')
                  .fontColor('#FFFFFF')
                  .layoutWeight(1)
                  .height(38)
                  .onClick(() => this.adjustTime(4))
              }
              .width('100%')
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 12 })
            .backgroundColor('#ffffff')
            .borderRadius(12)
            .shadow({ radius: 8, color: '#22000000', offsetX: 0, offsetY: 2 })

            // åŠŸèƒ½å¯¼èˆªæŒ‰é’®
            Row({ space: 8 }) {
              Button('æ”»å®ˆæ–¹ä½')
                .fontSize(13)
                .backgroundColor('#4ECDC4')
                .fontColor('#FFFFFF')
                .layoutWeight(1)
                .height(40)
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/AttackDefensePage',
                    params: {
                      timestamp: this.currentDateTime.getTime()
                    }
                  })
                })
              
              Button('å€¼ç¬¦å€¼ä½¿å†å²')
                .fontSize(13)
                .backgroundColor('#9B59B6')
                .fontColor('#FFFFFF')
                .layoutWeight(1)
                .height(40)
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/ZhiFuZhiShiHistoryPage',
                    params: {
                      timestamp: this.currentDateTime.getTime()
                    }
                  })
                })
            }
            .width('100%')
            .padding({ left: 16, right: 16 })

            // ä¹å®«æ ¼ç»„ä»¶
            DunjiaNineGrid({
              panResult: this.panResult,
              selectedPalace: this.selectedPalace,
              onPalaceClick: this.onPalaceClick
            })

            // å®«ä½è¯¦æƒ…ç»„ä»¶
            DunjiaPalaceDetail({
              panResult: this.panResult,
              selectedPalace: this.selectedPalace
            })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)  // æ°´å¹³å·¦å¯¹é½
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Auto)
        .align(Alignment.TopStart)  // Scrollå†…å®¹ä»é¡¶éƒ¨å¼€å§‹
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F1E8')
  }
}
