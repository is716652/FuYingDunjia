import { NavigationBar } from '../components/NavigationBar'

/**
 * æ ¼å±€çŸ¥è¯†åº“ç±»åˆ«
 */
interface GejuCategory {
  id: string;
  title: string;
  description: string;
  patterns: GejuKnowledgeItem[];
}

/**
 * æ ¼å±€çŸ¥è¯†æ¡ç›®
 */
interface GejuKnowledgeItem {
  id: string;
  name: string;
  type: 'major_auspicious' | 'minor_auspicious' | 'major_inauspicious' | 'minor_inauspicious' | 'neutral';
  description: string;
  conditions: string[];
  effect: string;
  source: string;
}

interface GejuJsonEffects {
  good?: string[];
  bad?: string[];
}

interface GejuJsonConditions {
  core?: string;
  door?: string;
  ganCombination?: string[];
  deity?: string;
  notes?: string;
}

interface GejuJsonSubRule {
  subId?: string;
  name?: string;
  palace?: string;
  direction?: string;
  description?: string;
  effects?: GejuJsonEffects;
}

interface GejuJsonRule {
  id?: string;
  name?: string;
  category?: string;
  ruleSource?: string;
  description?: string;
  conditions?: GejuJsonConditions;
  effects?: GejuJsonEffects;
  sub_rules?: GejuJsonSubRule[];
}

interface GejuJsonFile {
  rules?: GejuJsonRule[];
}

/**
 * æ ¼å±€è¯†åˆ«ä¸åˆ¤æ–­é¡µé¢
 * 
 * åŠŸèƒ½ï¼š
 * - åˆ†ç±»å±•ç¤ºæ‰€æœ‰æ ¼å±€çŸ¥è¯†
 * - å¤§å‰æ ¼å±€ã€å¼ºå‡¶æ ¼å±€ã€å¯¹æ•Œæˆ˜æœ¯ç­‰åˆ†ç±»
 * - æ¯ä¸ªæ ¼å±€æ˜¾ç¤ºåˆ¤å®šæ¡ä»¶ã€æ•ˆåº”ã€æ¥æº
 */
@Entry
@Component
struct GejuKnowledgePage {
  @State currentTabIndex: number = 0
  @State showDetailDialog: boolean = false
  @State selectedPattern: GejuKnowledgeItem | null = null
  @State categories: GejuCategory[] = [
    {
      id: 'major_auspicious',
      title: 'å¤§å‰æ ¼å±€',
      description: 'ä¸‰éã€ä¸‰å¥‡å¾—ä½¿ã€é’é¾™è¿”é¦–ç­‰ä¸Šä½³æ ¼å±€',
      patterns: [
        {
          id: 'sanqi_deshi',
          name: 'ä¸‰å¥‡å¾—ä½¿',
          type: 'major_auspicious',
          description: 'ä¸‰å¥‡ï¼ˆä¹™ä¸™ä¸ï¼‰ä¸´å€¼ä½¿é—¨ï¼Œä¸ºå¤§å‰æ ¼å±€',
          conditions: [
            'ä¹™å¥‡ä¸´å€¼ä½¿é—¨ï¼ˆæ—¥å¥‡å¾—ä½¿ï¼‰',
            'ä¸™å¥‡ä¸´å€¼ä½¿é—¨ï¼ˆæœˆå¥‡å¾—ä½¿ï¼‰',
            'ä¸å¥‡ä¸´å€¼ä½¿é—¨ï¼ˆæ˜Ÿå¥‡å¾—ä½¿ï¼‰'
          ],
          effect: 'ä¸»è´µäººæ‰¶åŠ©ï¼Œäº‹åŠåŠŸå€ï¼Œæ¨è¿›é¡ºåˆ©',
          source: 'ä¸Šå·Â·ä¸‰å¥‡å¾—ä½¿æ¡'
        },
        {
          id: 'tian_dun',
          name: 'å¤©é',
          type: 'major_auspicious',
          description: 'ä¸™å¥‡ä¸´å‰é—¨ï¼ˆç”Ÿé—¨/å¼€é—¨/ä¼‘é—¨ï¼‰ï¼Œå¾—æ—¥ç²¾ä¹‹è”½',
          conditions: [
            'ä¸™å¥‡åœ¨æŸå®«',
            'è¯¥å®«é—¨ä¸ºç”Ÿé—¨ã€å¼€é—¨æˆ–ä¼‘é—¨ä¹‹ä¸€'
          ],
          effect: 'å¾—å¤©æ—¶ä¹‹åˆ©ï¼Œå®œäº‰è®¼ã€é™ˆè¯‰ã€ä¸Šä¹¦ã€çŒ®ç­–ç­‰å…¬å¼€æ¨è¿›äº‹é¡¹',
          source: 'ä¸­å·Â·é‡Šå¤©éæ¡'
        },
        {
          id: 'di_dun',
          name: 'åœ°é',
          type: 'major_auspicious',
          description: 'ä¹™å¥‡ä¸´å¼€é—¨æˆ–æœé—¨ï¼Œå¾—æœˆç²¾ä¹‹è”½',
          conditions: [
            'ä¹™å¥‡åœ¨æŸå®«',
            'è¯¥å®«é—¨ä¸ºå¼€é—¨æˆ–æœé—¨'
          ],
          effect: 'å¾—åœ°åˆ©ä¹‹ä¾¿ï¼Œå®œåŸ‹è‘¬ã€ä¿®é€ ã€å»ºå‚ã€è—å…µç­‰ç¨³å›ºæ€§äº‹é¡¹',
          source: 'ä¸­å·Â·é‡Šåœ°éæ¡'
        },
        {
          id: 'ren_dun',
          name: 'äººé',
          type: 'major_auspicious',
          description: 'ä¸å¥‡ä¸´æœé—¨ï¼Œå¾—æ˜Ÿç²¾ä¹‹è”½',
          conditions: [
            'ä¸å¥‡åœ¨æŸå®«',
            'è¯¥å®«é—¨ä¸ºæœé—¨'
          ],
          effect: 'å¾—äººå’Œä¹‹åŠ©ï¼Œå®œæ½œè—ã€åŒ¿å½¢ã€å’Œè°ˆã€å¯†è°‹ç­‰éšç§˜æ€§äº‹é¡¹',
          source: 'ä¸­å·Â·é‡Šäººéæ¡'
        },
        {
          id: 'qinglong_huishou',
          name: 'é’é¾™è¿”é¦–',
          type: 'major_auspicious',
          description: 'å…­ç”²åŠ å…­ä¸™ï¼Œé¾™å›é¦–ä¹‹è±¡',
          conditions: [
            'å¤©ç›˜ä¸ºç”²ï¼ˆå«æˆŠå·±ä»£ç”²ï¼‰',
            'åœ°ç›˜ä¸ºä¸™'
          ],
          effect: 'é€ ä¸¾ç™¾äº‹çš†å‰ï¼Œä¸»å£°åŠ¿å¤§æŒ¯ï¼Œå°¤åˆ©æ–‡ä¹¦ã€ç«äº‰',
          source: 'ä¸­å·Â·é’é¾™è¿”é¦–æ¡'
        },
        {
          id: 'feiniao_diexue',
          name: 'é£é¸Ÿè·Œç©´',
          type: 'major_auspicious',
          description: 'å…­ä¸™åŠ å…­ç”²ï¼Œé¸Ÿå½’å·¢ä¹‹è±¡',
          conditions: [
            'å¤©ç›˜ä¸ºä¸™',
            'åœ°ç›˜ä¸ºç”²ï¼ˆå«æˆŠå·±ä»£ç”²ï¼‰'
          ],
          effect: 'ç™¾äº‹çš†å‰ï¼Œä¸»è®¡åˆ’è½åœ°ã€ç¨³å¥æ¨è¿›',
          source: 'ä¸­å·Â·é£é¸Ÿè·Œç©´æ¡'
        }
      ]
    },
    {
      id: 'major_inauspicious',
      title: 'å¼ºå‡¶æ ¼å±€',
      description: 'å…­ä»ªå‡»åˆ‘ã€å¤©ç½‘å››å¼ ã€äº”ä¸è¿‡æ—¶ç­‰å¼ºå‡¶æ—¶æ®µ',
      patterns: [
        {
          id: 'liuyi_jixing',
          name: 'å…­ä»ªå‡»åˆ‘',
          type: 'major_inauspicious',
          description: 'ä¸‰åˆ‘ä¹‹æ—¶ï¼Œå¤©åœ°ä¸é¡º',
          conditions: [
            'å¯…å·³ç”³ä¸‰åˆ‘ï¼ˆæ—¶æ”¯ä¸ºå¯…/å·³/ç”³ï¼‰',
            'ä¸‘æˆŒæœªä¸‰åˆ‘ï¼ˆæ—¶æ”¯ä¸ºä¸‘/æˆŒ/æœªï¼‰',
            'å­å¯ç›¸åˆ‘ï¼ˆæ—¶æ”¯ä¸ºå­/å¯ï¼‰'
          ],
          effect: 'ç™¾äº‹ä¸å®œï¼Œä¸»åå¤ã€é˜»æ»ã€åˆ‘ä¼¤',
          source: 'ä¸­å·Â·å…­ä»ªå‡»åˆ‘æ¡'
        },
        {
          id: 'tianwang_sizhang',
          name: 'å¤©ç½‘å››å¼ ',
          type: 'major_inauspicious',
          description: 'å››å­£å°¾æœˆï¼ˆè¾°æˆŒä¸‘æœªæœˆï¼‰æˆŠå·±æ—¥ï¼Œå¤©ç½—åœ°ç½‘',
          conditions: [
            'æœˆæ”¯ä¸ºè¾°/æˆŒ/ä¸‘/æœª',
            'æ—¥å¹²ä¸ºæˆŠæˆ–å·±'
          ],
          effect: 'å¼ºå‡¶æ—¶æ®µï¼Œè¯¸äº‹ä¸å®œï¼Œä¸»å›°é¡¿ã€ç¾ç»Š',
          source: 'ä¸­å·Â·å¤©ç½‘å››å¼ æ¡'
        },
        {
          id: 'wubu_guoshi',
          name: 'äº”ä¸è¿‡æ—¶',
          type: 'major_inauspicious',
          description: 'æ—¶å¹²å…‹æ—¥å¹²ï¼ŒæŸæ˜ä¸å¯è¡Œç™¾äº‹',
          conditions: [
            'æ—¶å¹²å…‹æ—¥å¹²ï¼ˆå¦‚ç”²æ—¥åºšæ—¶ã€ä¹™æ—¥è¾›æ—¶ç­‰ï¼‰'
          ],
          effect: 'å¼ºå‡¶ç¦å¿Œï¼Œä¸å¯å‡ºå†›ã€ä¸å¯è¡Œäº‹ï¼Œä¸»æŸæŠ˜',
          source: 'ä¸‹å·Â·äº”ä¸è¿‡æ—¶æ¡'
        },
        {
          id: 'sanqi_rumu',
          name: 'ä¸‰å¥‡å…¥å¢“',
          type: 'major_inauspicious',
          description: 'ä¸‰å¥‡è½å…¥å¢“åœ°ï¼Œç²¾åè¢«æ©',
          conditions: [
            'ä¹™å¥‡åœ¨è¾°å®«ï¼ˆæœ¨å¢“ï¼‰',
            'ä¸™ä¸å¥‡åœ¨æˆŒå®«ï¼ˆç«å¢“ï¼‰'
          ],
          effect: 'å‰åŠ›å¤§å‡ï¼Œä¸»è°‹äº‹ä¸é‚ã€è´µäººéš¾å¾—',
          source: 'ä¸­å·Â·ä¸‰å¥‡å…¥å¢“æ¡'
        }
      ]
    },
    {
      id: 'tactical',
      title: 'å¯¹æ•Œæˆ˜æœ¯',
      description: 'å¤ªç™½å…¥è§æƒ‘ã€äº”ä¸å¯å‡»ç­‰æ”»å®ˆæ¨æ¼”è§„åˆ™',
      patterns: [
        {
          id: 'taibai_ru_yinghuo',
          name: 'å¤ªç™½å…¥è§æƒ‘',
          type: 'minor_auspicious',
          description: 'åºšåŠ ä¸™ï¼Œç™½è™å…¥èµ¤åœ°',
          conditions: [
            'å¤©ç›˜ä¸ºåºš',
            'åœ°ç›˜ä¸ºä¸™'
          ],
          effect: 'åˆ©åå‡»ã€åˆ©çªè¢­ï¼Œä¸»å®¢å¿«é€Ÿå‡»æºƒæ•Œæ–¹',
          source: 'ä¸­å·Â·å¤ªç™½å…¥è§æƒ‘æ¡'
        },
        {
          id: 'yinghuo_ru_taibai',
          name: 'è§æƒ‘å…¥å¤ªç™½',
          type: 'minor_inauspicious',
          description: 'ä¸™åŠ åºšï¼Œèµ¤ç‚é‡åˆšé‡‘',
          conditions: [
            'å¤©ç›˜ä¸ºä¸™',
            'åœ°ç›˜ä¸ºåºš'
          ],
          effect: 'æ•Œæ–¹é€€å´ä¹‹è±¡ï¼Œå®œè§‚æœ›ã€ä¸å®œæ€¥æ”»',
          source: 'ä¸­å·Â·è§æƒ‘å…¥å¤ªç™½æ¡'
        },
        {
          id: 'wubu_keji',
          name: 'äº”ä¸å¯å‡»',
          type: 'neutral',
          description: 'æ”»å®ˆæˆ˜æœ¯ä¸­çš„äº”ä¸ªç¦æ”»å®«ä½',
          conditions: [
            'å¤©ä¹™å®«ï¼ˆå€¼ç¬¦æ‰€åœ¨ï¼‰',
            'ä¹å¤©å®«ï¼ˆå¯¹åº”æ˜Ÿå®«ï¼‰',
            'ç”Ÿé—¨ä¸‰å¥‡å®«',
            'ä¹åœ°å®«ï¼ˆå¯¹åº”æ˜Ÿå®«ï¼‰',
            'ç›´ä½¿å®«ï¼ˆå€¼ä½¿æ‰€åœ¨ï¼‰'
          ],
          effect: 'æ­¤äº”å®«ä¸ºæˆ˜æœ¯ç¦åŒºï¼Œä¸å¯ä¸»åŠ¨æ”»å‡»ï¼Œå®œå®ˆä¸å®œæ”»',
          source: 'ä¸‹å·Â·äº”ä¸å¯å‡»æ¡'
        }
      ]
    },
    {
      id: 'minor',
      title: 'å…¶ä»–æ ¼å±€',
      description: 'ä¼åŸã€ååŸç­‰å˜åŠ¨æ ¼å±€',
      patterns: [
        {
          id: 'fu_yin',
          name: 'ä¼åŸ',
          type: 'neutral',
          description: 'å¤©ç›˜åœ°ç›˜ç›¸åŒï¼Œé™å®ˆä¹‹è±¡',
          conditions: [
            'æŸå®«å¤©ç›˜å¤©å¹²ä¸åœ°ç›˜å¤©å¹²ç›¸åŒ'
          ],
          effect: 'ä¸»é™å®ˆä¸ºå®œï¼Œä¸å®œè½»ä¸¾å¦„åŠ¨ï¼Œäº‹å¤šè¿Ÿæ»',
          source: 'ä¸Šå·Â·ä¼åŸæ¡'
        },
        {
          id: 'fan_yin',
          name: 'ååŸ',
          type: 'neutral',
          description: 'å¯¹å†²æ ¼å±€ï¼Œå˜åŠ¨ä¹‹è±¡',
          conditions: [
            'ç”²å­ä¸ç”²åˆå¯¹å†²',
            'ç”²æˆŒä¸ç”²è¾°å¯¹å†²',
            'ç”²ç”³ä¸ç”²å¯…å¯¹å†²'
          ],
          effect: 'ä¸»å˜åŠ¨ã€åå¤ï¼Œå®œè°¨æ…è¡Œäº‹ï¼Œäº‹å¤šæ³¢æŠ˜',
          source: 'ä¸Šå·Â·ååŸæ¡'
        }
      ]
    }
  ]
  
  aboutToAppear() {
    this.loadGejuJson()
  }
  
  private loadGejuJson() {
    try {
      const context = getContext(this);
      if (!context || !context.resourceManager || !context.resourceManager.getRawFileContent) {
        console.error('[GejuKnowledgePage] æ— æ³•è·å–èµ„æºç®¡ç†å™¨');
        return;
      }
  
      context.resourceManager.getRawFileContent('rules/geju_jixiong_rules.json')
        .then((data: Uint8Array) => {
          const jsonStr = this.decodeUtf8(data);
          let parsed: GejuJsonFile | null = null;
          try {
            parsed = JSON.parse(jsonStr) as GejuJsonFile;
          } catch (e) {
            console.error('[GejuKnowledgePage] è§£ææ ¼å±€ JSON å¤±è´¥', JSON.stringify(e));
            return;
          }
  
          if (!parsed || !parsed.rules || !Array.isArray(parsed.rules)) {
            return;
          }
  
          let newCategories: GejuCategory[] = [];
          for (let i = 0; i < this.categories.length; i++) {
            const category = this.categories[i];
            const copiedPatterns: GejuKnowledgeItem[] = [];
            for (let j = 0; j < category.patterns.length; j++) {
              const p = category.patterns[j];
              copiedPatterns.push({
                id: p.id,
                name: p.name,
                type: p.type,
                description: p.description,
                conditions: p.conditions.slice(),
                effect: p.effect,
                source: p.source
              });
            }
            newCategories.push({
              id: category.id,
              title: category.title,
              description: category.description,
              patterns: copiedPatterns
            });
          }
  
          for (let i = 0; i < parsed.rules.length; i++) {
            const rule = parsed.rules[i];
            if (!rule || !rule.id) {
              continue;
            }
            if (rule.sub_rules && Array.isArray(rule.sub_rules) && rule.sub_rules.length > 0) {
              for (let j = 0; j < rule.sub_rules.length; j++) {
                const subRule = rule.sub_rules[j];
                newCategories = this.addOrUpdatePatternFromJson(rule, subRule, newCategories);
              }
            } else {
              newCategories = this.addOrUpdatePatternFromJson(rule, null, newCategories);
            }
          }
  
          this.categories = newCategories;
        })
        .catch((err: Error) => {
          console.error('[GejuKnowledgePage] è¯»å–æ ¼å±€ JSON å¤±è´¥', JSON.stringify(err));
        });
    } catch (e) {
      console.error('[GejuKnowledgePage] loadGejuJson å¼‚å¸¸', JSON.stringify(e));
    }
  }
  
  private addOrUpdatePatternFromJson(rule: GejuJsonRule, subRule: GejuJsonSubRule | null, categories: GejuCategory[]): GejuCategory[] {
    const targetCategoryId: string = this.mapGejuCategoryId(rule.category);
    if (!targetCategoryId) {
      return categories;
    }
  
    const itemId: string = (subRule && subRule.subId ? subRule.subId : (rule.id ? rule.id : ''));
    const itemName: string = (subRule && subRule.name ? subRule.name : (rule.name ? rule.name : ''));
  
    const conditions: string[] = [];
    if (rule.description && typeof rule.description === 'string') {
      conditions.push(rule.description);
    }
    if (rule.conditions) {
      const cond = rule.conditions;
      if (cond.core) {
        conditions.push(cond.core);
      }
      if (cond.door) {
        conditions.push('é—¨ï¼š' + cond.door);
      }
      if (cond.ganCombination && Array.isArray(cond.ganCombination) && cond.ganCombination.length > 0) {
        conditions.push('å¹²ç»„åˆï¼š' + cond.ganCombination.join('ã€'));
      }
      if (cond.deity) {
        conditions.push('ç¥ï¼š' + cond.deity);
      }
      if (cond.notes) {
        conditions.push(cond.notes);
      }
    }
    if (subRule) {
      if (subRule.palace) {
        conditions.push('å®«ä½ï¼š' + subRule.palace);
      }
      if (subRule.direction) {
        conditions.push('æ–¹ä½ï¼š' + subRule.direction);
      }
      if (subRule.description && typeof subRule.description === 'string') {
        conditions.push(subRule.description);
      }
    }
  
    const effectsList: string[] = [];
    if (rule.effects) {
      if (rule.effects.good && Array.isArray(rule.effects.good) && rule.effects.good.length > 0) {
        effectsList.push('å‰ï¼š' + rule.effects.good.join('ã€'));
      }
      if (rule.effects.bad && Array.isArray(rule.effects.bad) && rule.effects.bad.length > 0) {
        effectsList.push('å‡¶ï¼š' + rule.effects.bad.join('ã€'));
      }
    }
    if (subRule && subRule.effects) {
      if (subRule.effects.good && Array.isArray(subRule.effects.good) && subRule.effects.good.length > 0) {
        effectsList.push('å‰ï¼š' + subRule.effects.good.join('ã€'));
      }
      if (subRule.effects.bad && Array.isArray(subRule.effects.bad) && subRule.effects.bad.length > 0) {
        effectsList.push('å‡¶ï¼š' + subRule.effects.bad.join('ã€'));
      }
    }
    const effectText: string = effectsList.join('ï¼›');
  
    const item: GejuKnowledgeItem = {
      id: itemId,
      name: itemName,
      type: this.mapGejuType(rule.category),
      description: rule.description && typeof rule.description === 'string' ? rule.description : '',
      conditions: conditions,
      effect: effectText,
      source: rule.ruleSource || ''
    };
  
    for (let i = 0; i < categories.length; i++) {
      const category = categories[i];
      if (category.id === targetCategoryId) {
        const updatedPatterns: GejuKnowledgeItem[] = [];
        let found: boolean = false;
        for (let j = 0; j < category.patterns.length; j++) {
          const existing = category.patterns[j];
          if (existing.id === item.id) {
            updatedPatterns.push(item);
            found = true;
          } else {
            updatedPatterns.push(existing);
          }
        }
        if (!found) {
          updatedPatterns.push(item);
        }
        categories[i] = {
          id: category.id,
          title: category.title,
          description: category.description,
          patterns: updatedPatterns
        };
        break;
      }
    }
  
    return categories;
  }
  
  private mapGejuCategoryId(category: string | undefined): string {
    if (category === 'å‰æ ¼') {
      return 'major_auspicious';
    }
    if (category === 'å‡¶æ ¼') {
      return 'major_inauspicious';
    }
    if (category === 'ç‰¹æ®Šå‡¶è±¡') {
      return 'minor';
    }
    return '';
  }
  
  private mapGejuType(category: string | undefined): 'major_auspicious' | 'minor_auspicious' | 'major_inauspicious' | 'minor_inauspicious' | 'neutral' {
    if (category === 'å‰æ ¼') {
      return 'major_auspicious';
    }
    if (category === 'å‡¶æ ¼') {
      return 'major_inauspicious';
    }
    if (category === 'ç‰¹æ®Šå‡¶è±¡') {
      return 'minor_inauspicious';
    }
    return 'neutral';
  }
  
  private decodeUtf8(bytes: Uint8Array): string {
    let out = '';
    let i = 0;
    while (i < bytes.length) {
      const c = bytes[i++];
      if (c < 0x80) {
        out += String.fromCharCode(c);
      } else if ((c & 0xe0) === 0xc0 && i < bytes.length) {
        const c2 = bytes[i++];
        const code = ((c & 0x1f) << 6) | (c2 & 0x3f);
        out += String.fromCharCode(code);
      } else if ((c & 0xf0) === 0xe0 && i + 1 < bytes.length) {
        const c2 = bytes[i++];
        const c3 = bytes[i++];
        const code = ((c & 0x0f) << 12) | ((c2 & 0x3f) << 6) | (c3 & 0x3f);
        out += String.fromCharCode(code);
      } else if ((c & 0xf8) === 0xf0 && i + 2 < bytes.length) {
        const c2 = bytes[i++];
        const c3 = bytes[i++];
        const c4 = bytes[i++];
        let codePoint = ((c & 0x07) << 18) | ((c2 & 0x3f) << 12) | ((c3 & 0x3f) << 6) | (c4 & 0x3f);
        codePoint -= 0x10000;
        const high = 0xd800 + (codePoint >> 10);
        const low = 0xdc00 + (codePoint & 0x3ff);
        out += String.fromCharCode(high, low);
      } else {
        out += '?';
      }
    }
    return out;
  }
  
  /**
   * è·å–æ ¼å±€ç±»å‹æ ‡ç­¾
   */
  private getTypeLabel(type: string): string {
    const typeMap: Record<string, string> = {
      'major_auspicious': 'å¤§å‰',
      'minor_auspicious': 'åå‰',
      'major_inauspicious': 'å¤§å‡¶',
      'minor_inauspicious': 'åå‡¶',
      'neutral': 'ä¸­æ€§'
    }
    return typeMap[type] || 'æœªçŸ¥'
  }

  /**
   * è·å–æ ¼å±€ç±»å‹é¢œè‰²
   */
  private getTypeColor(type: string): string {
    const colorMap: Record<string, string> = {
      'major_auspicious': '#4CAF50',
      'minor_auspicious': '#8BC34A',
      'major_inauspicious': '#F44336',
      'minor_inauspicious': '#FF9800',
      'neutral': '#9E9E9E'
    }
    return colorMap[type] || '#999999'
  }

  /**
   * æ¸²æŸ“æ ¼å±€å¡ç‰‡
   */
  @Builder
  buildPatternCard(pattern: GejuKnowledgeItem) {
    Column({ space: 8 }) {
      // æ ‡é¢˜è¡Œ
      Row({ space: 8 }) {
        Text(pattern.name)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C2416')
          .layoutWeight(1)
        
        Text(this.getTypeLabel(pattern.type))
          .fontSize(12)
          .fontColor('#FFFFFF')
          .backgroundColor(this.getTypeColor(pattern.type))
          .padding({ left: 8, right: 8, top: 3, bottom: 3 })
          .borderRadius(4)
      }
      .width('100%')

      // æè¿°
      Text(pattern.description)
        .fontSize(13)
        .fontColor('#666666')
        .lineHeight(20)
        .width('100%')

      // åˆ¤å®šæ¡ä»¶
      Column({ space: 4 }) {
        Text('åˆ¤å®šæ¡ä»¶ï¼š')
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor('#888888')
        
        ForEach(pattern.conditions, (condition: string) => {
          Row({ space: 6 }) {
            Text('â€¢')
              .fontSize(12)
              .fontColor('#999999')
            Text(condition)
              .fontSize(12)
              .fontColor('#666666')
              .layoutWeight(1)
          }
          .width('100%')
        })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // æ•ˆåº”
      Row({ space: 6 }) {
        Text('æ•ˆåº”ï¼š')
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor('#888888')
        Text(pattern.effect)
          .fontSize(12)
          .fontColor('#2C2416')
          .layoutWeight(1)
      }
      .width('100%')

      // æ¥æº
      Text(`ğŸ“– ${pattern.source}`)
        .fontSize(11)
        .fontColor('#999999')
        .width('100%')
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .shadow({ radius: 4, color: '#22000000', offsetX: 0, offsetY: 2 })
    .onClick(() => {
      this.selectedPattern = pattern
      this.showDetailDialog = true
    })
  }

  /**
   * æ ¼å±€è¯¦æƒ…å¼¹çª—
   */
  @Builder
  buildDetailDialog() {
    if (this.showDetailDialog && this.selectedPattern) {
      Column({ space: 0 }) {
        // é®ç½©å±‚
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('#80000000')
          .onClick(() => {
            this.showDetailDialog = false
          })
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .position({ x: 0, y: 0 })
      .zIndex(1000)

      // å¼¹çª—å†…å®¹
      Column({ space: 16 }) {
        // æ ‡é¢˜åŒº
        Row({ space: 12 }) {
          Text(this.selectedPattern.name)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#2C2416')
            .layoutWeight(1)
          
          Text('Ã—')
            .fontSize(28)
            .fontColor('#666666')
            .onClick(() => {
              this.showDetailDialog = false
            })
        }
        .width('100%')

        Divider().color('#EEEEEE')

        // æ»šåŠ¨åŒºåŸŸ
        Scroll() {
          Column({ space: 16 }) {
            // ç±»å‹æ ‡ç­¾
            Row() {
              Text(this.getTypeLabel(this.selectedPattern.type))
                .fontSize(13)
                .fontColor('#FFFFFF')
                .backgroundColor(this.getTypeColor(this.selectedPattern.type))
                .padding({ left: 10, right: 10, top: 5, bottom: 5 })
                .borderRadius(6)
            }
            .width('100%')

            // æè¿°
            Column({ space: 8 }) {
              Text('æ ¼å±€æè¿°')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
              Text(this.selectedPattern.description)
                .fontSize(14)
                .fontColor('#4A3B20')
                .lineHeight(22)
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .padding(12)
            .backgroundColor('#FFF8F0')
            .borderRadius(8)

            // åˆ¤å®šæ¡ä»¶
            Column({ space: 8 }) {
              Text('åˆ¤å®šæ¡ä»¶')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
              
              ForEach(this.selectedPattern.conditions, (condition: string, index: number) => {
                Row({ space: 8 }) {
                  Text(`${index + 1}.`)
                    .fontSize(13)
                    .fontColor('#888888')
                    .width(24)
                  Text(condition)
                    .fontSize(13)
                    .fontColor('#4A3B20')
                    .lineHeight(20)
                    .layoutWeight(1)
                }
                .width('100%')
              })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .padding(12)
            .backgroundColor('#F7F5ED')
            .borderRadius(8)

            // æ•ˆåº”è¯´æ˜
            Column({ space: 8 }) {
              Text('æ•ˆåº”è¯´æ˜')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
              Text(this.selectedPattern.effect)
                .fontSize(14)
                .fontColor('#4A3B20')
                .lineHeight(22)
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .padding(12)
            .backgroundColor('#FFF8F0')
            .borderRadius(8)

            // æ¥æºå‡ºå¤„
            Column({ space: 8 }) {
              Text('æ¥æºå‡ºå¤„')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
              Text(`ğŸ“– ${this.selectedPattern.source}`)
                .fontSize(13)
                .fontColor('#666666')
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .padding(12)
            .backgroundColor('#F7F5ED')
            .borderRadius(8)
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Auto)
      }
      .width('85%')
      .height('75%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({ radius: 16, color: '#44000000', offsetX: 0, offsetY: 4 })
      .position({ x: '7.5%', y: '12.5%' })
      .zIndex(1001)
    }
  }

  build() {
    Column({ space: 0 }) {
      // é¡¶éƒ¨å¯¼èˆªæ 
      NavigationBar({ title: 'æ ¼å±€è¯†åˆ«ä¸åˆ¤æ–­' })

      // æ ‡ç­¾é¡µ
      Tabs({ index: this.currentTabIndex }) {
        ForEach(this.categories, (category: GejuCategory) => {
          TabContent() {
            Scroll() {
              Column({ space: 12 }) {
                // ç±»åˆ«è¯´æ˜
                Text(category.description)
                  .fontSize(13)
                  .fontColor('#666666')
                  .lineHeight(20)
                  .width('100%')
                  .padding(12)
                  .backgroundColor('#FFF8F0')
                  .borderRadius(8)

                // æ ¼å±€åˆ—è¡¨
                ForEach(category.patterns, (pattern: GejuKnowledgeItem) => {
                  this.buildPatternCard(pattern)
                })
              }
              .width('100%')
              .padding(16)
            }
            .width('100%')
            .height('100%')
            .scrollBar(BarState.Auto)
          }
          .tabBar(category.title)
        })
      }
      .width('100%')
      .layoutWeight(1)
      .barMode(BarMode.Scrollable)
      .onChange((index: number) => {
        this.currentTabIndex = index
      })

      // æ ¼å±€è¯¦æƒ…å¼¹çª—
      this.buildDetailDialog()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F1E8')
  }
}
