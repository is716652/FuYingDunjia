import { CalendarManager, CalendarDayInfo } from '../utils/CalendarManager';
import { ShichenHelper } from '../utils/ShichenHelper';
import { SolarTimeHelper, CHINA_CITY_LONGITUDES } from '../utils/SolarTimeHelper';
import { router } from '@kit.ArkUI';
import { NavigationBar } from '../components/NavigationBar';
import { CalendarHeader } from '../components/CalendarHeader';
import { CalendarGrid, DayCell } from '../components/CalendarGrid';
import { ShichenSelector } from '../components/ShichenSelector';
import { LunarInfoPanel } from '../components/LunarInfoPanel';

interface DateFullInfo {
  lunarDay: string;
  solarTerm?: string;
  hasFestival: boolean;
}

@Entry
@Component
struct CalendarPage {
  @State dayInfo: CalendarDayInfo | null = null;
  @State selectedShichenIndex: number = 0;
  @State shichenTexts: string[] = [];
  @State selectedDate: Date = new Date();
  @State currentYear: number = new Date().getFullYear();
  @State currentMonth: number = new Date().getMonth() + 1;
  @State calendarDays: DayCell[] = [];
  @State currentShizhu: string = 'æš‚æ— ';  // å½“å‰æ—¶æŸ±ï¼Œç”¨äºå“åº”å¼æ›´æ–°
  @State showYearPicker: boolean = false;
  @State showMonthPicker: boolean = false;
  private solarTimeHelper: SolarTimeHelper = new SolarTimeHelper(CHINA_CITY_LONGITUDES.BEIJING);

  aboutToAppear() {
    CalendarManager.getInstance().init(getContext(this));
    // é»˜è®¤åŠ è½½å½“å¤©æ—¥æœŸ
    const now = new Date();
    this.selectedDate = now;
    this.currentYear = now.getFullYear();
    this.currentMonth = now.getMonth() + 1;
    this.generateCalendar(this.currentYear, this.currentMonth);
    // åˆå§‹åŒ–æ—¶è®¾ç½®ä¸ºå½“å‰ç³»ç»Ÿæ—¶è¾°
    this.selectedShichenIndex = ShichenHelper.getCurrentShichenIndex();
    this.loadDateInfo(now.getFullYear(), now.getMonth() + 1, now.getDate());
  }

  // ç”Ÿæˆæ—¥å†æ•°æ®
  async generateCalendar(year: number, month: number) {
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const daysInMonth = lastDay.getDate();
      
    let firstWeekDay = firstDay.getDay();
    firstWeekDay = firstWeekDay === 0 ? 6 : firstWeekDay - 1;
      
    const days: DayCell[] = [];
        
    // æ”¶é›†æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„æ—¥æœŸ
    const datesToQuery: Date[] = [];
      
    // ä¸Šæœˆå°¾éƒ¨æ—¥æœŸ
    if (firstWeekDay > 0) {
      const prevMonthLastDay = new Date(year, month - 1, 0).getDate();
      for (let i = firstWeekDay - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const date = new Date(year, month - 2, day);
        datesToQuery.push(date);
      }
    }
      
    // å½“æœˆæ—¥æœŸ
    for (let i = 1; i <= daysInMonth; i++) {
      const date = new Date(year, month - 1, i);
      datesToQuery.push(date);
    }
      
    // ä¸‹æœˆå¼€å¤´æ—¥æœŸ
    const remainingCells = 42 - datesToQuery.length;
    for (let i = 1; i <= remainingCells; i++) {
      const date = new Date(year, month, i);
      datesToQuery.push(date);
    }
      
    // æ‰¹é‡è·å–æ‰€æœ‰æ—¥æœŸçš„å®Œæ•´ä¿¡æ¯
    const dateInfos = await Promise.all(
      datesToQuery.map(date => this.getDateInfo(date))
    );
      
    // ç»„è£…æ•°æ®
    let index = 0;
      
    // ä¸Šæœˆå°¾éƒ¨
    if (firstWeekDay > 0) {
      const prevMonthLastDay = new Date(year, month - 1, 0).getDate();
      for (let i = firstWeekDay - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const date = new Date(year, month - 2, day);
        const info = dateInfos[index++];
        days.push({ 
          day, 
          isCurrentMonth: false, 
          date, 
          lunarDay: info.lunarDay,
          solarTerm: info.solarTerm,
          hasFestival: info.hasFestival
        });
      }
    }
      
    // å½“æœˆ
    for (let i = 1; i <= daysInMonth; i++) {
      const date = new Date(year, month - 1, i);
      const info = dateInfos[index++];
      days.push({ 
        day: i, 
        isCurrentMonth: true, 
        date, 
        lunarDay: info.lunarDay,
        solarTerm: info.solarTerm,
        hasFestival: info.hasFestival
      });
    }
      
    // ä¸‹æœˆå¼€å¤´
    for (let i = 1; i <= remainingCells; i++) {
      const date = new Date(year, month, i);
      const info = dateInfos[index++];
      days.push({ 
        day: i, 
        isCurrentMonth: false, 
        date, 
        lunarDay: info.lunarDay,
        solarTerm: info.solarTerm,
        hasFestival: info.hasFestival
      });
    }
      
    this.calendarDays = days;
  }
  
  // è·å–å†œå†æ—¥æœŸæ–‡æœ¬
  async getLunarDayText(date: Date): Promise<string> {
    const info = await CalendarManager.getInstance().getDayInfo(
      date.getFullYear(),
      date.getMonth() + 1,
      date.getDate()
    );
    if (!info) return '';
      
    const days = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'åˆå››', 'åˆäº”', 'åˆå…­', 'åˆä¸ƒ', 'åˆå…«', 'åˆä¹', 'åˆå',
                  'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”', 'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå',
                  'å»¿ä¸€', 'å»¿äºŒ', 'å»¿ä¸‰', 'å»¿å››', 'å»¿äº”', 'å»¿å…­', 'å»¿ä¸ƒ', 'å»¿å…«', 'å»¿ä¹', 'ä¸‰å'];
    return days[info.lunar_day - 1] || '';
  }

  // è·å–å®Œæ•´çš„æ—¥æœŸä¿¡æ¯ï¼ˆå†œå†+èŠ‚æ°”+èŠ‚æ—¥ï¼‰
  async getDateInfo(date: Date): Promise<DateFullInfo> {
    const info = await CalendarManager.getInstance().getDayInfo(
      date.getFullYear(),
      date.getMonth() + 1,
      date.getDate()
    );
    
    if (!info) {
      return { lunarDay: '', hasFestival: false };
    }
    
    const days = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'åˆå››', 'åˆäº”', 'åˆå…­', 'åˆä¸ƒ', 'åˆå…«', 'åˆä¹', 'åˆå',
                  'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”', 'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå',
                  'å»¿ä¸€', 'å»¿äºŒ', 'å»¿ä¸‰', 'å»¿å››', 'å»¿äº”', 'å»¿å…­', 'å»¿ä¸ƒ', 'å»¿å…«', 'å»¿ä¹', 'ä¸‰å'];
    
    const months = ['æ­£æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'å†¬æœˆ', 'è…Šæœˆ'];
    
    const hasFestival = (info.festivals && info.festivals.length > 0) ? true : false;
    
    // åˆä¸€æ˜¾ç¤ºæœˆä»½åç§°
    const lunarDayText = info.lunar_day === 1 ? months[info.lunar_month - 1] : (days[info.lunar_day - 1] || '');
    
    return {
      lunarDay: lunarDayText,
      solarTerm: info.solar_term || undefined,
      hasFestival: hasFestival
    };
  }

  // åˆ‡æ¢æœˆä»½
  changeMonth(offset: number) {
    let newMonth = this.currentMonth + offset;
    let newYear = this.currentYear;
    
    if (newMonth > 12) {
      newMonth = 1;
      newYear++;
    } else if (newMonth < 1) {
      newMonth = 12;
      newYear--;
    }
    
    this.currentMonth = newMonth;
    this.currentYear = newYear;
    this.generateCalendar(newYear, newMonth);
  }

  // è¿”å›ä»Šå¤©
  backToToday() {
    const now = new Date();
    this.selectedDate = now;
    this.currentYear = now.getFullYear();
    this.currentMonth = now.getMonth() + 1;
    this.selectedShichenIndex = ShichenHelper.getCurrentShichenIndex();
    this.generateCalendar(this.currentYear, this.currentMonth);
    this.loadDateInfo(now.getFullYear(), now.getMonth() + 1, now.getDate());
  }

  // åˆ‡æ¢å¹´ä»½
  changeYear(newYear: number) {
    this.currentYear = newYear;
    this.showYearPicker = false;
    this.generateCalendar(newYear, this.currentMonth);
  }

  // åˆ‡æ¢æœˆä»½ï¼ˆç›´æ¥è·³è½¬ï¼‰
  changeMonthDirect(newMonth: number) {
    this.currentMonth = newMonth;
    this.showMonthPicker = false;
    this.generateCalendar(this.currentYear, newMonth);
  }

  // é€‰ä¸­æ—¥æœŸ
  async onDaySelected(dayCell: DayCell) {
    if (!dayCell.isCurrentMonth) {
      // å¦‚æœç‚¹å‡»çš„æ˜¯ä¸Š/ä¸‹æœˆçš„æ—¥æœŸï¼Œåˆ‡æ¢æœˆä»½
      const offset = dayCell.date.getMonth() + 1 > this.currentMonth ? 1 : -1;
      this.changeMonth(offset);
    }
    
    this.selectedDate = dayCell.date;
    const year = dayCell.date.getFullYear();
    const month = dayCell.date.getMonth() + 1;
    const day = dayCell.date.getDate();
    await this.loadDateInfo(year, month, day);
  }

  // åŒå‡»æ—¥æœŸå¿«é€Ÿè¿›å…¥æ’ç›˜
  onDayDoubleClick(dayCell: DayCell) {
    if (!dayCell.isCurrentMonth) {
      return; // éå½“æœˆæ—¥æœŸä¸å“åº”åŒå‡»
    }
    this.navigateToDunjia();
  }

  async loadDateInfo(year: number, month: number, day: number) {
    const info = await CalendarManager.getInstance().getDayInfo(year, month, day);
    if (info) {
      this.dayInfo = info;
      this.currentShizhu = ShichenHelper.getShizhuInfo(this.dayInfo.day_gan, this.selectedShichenIndex);
      this.updateShichenOptions();
    }
  }

  updateShichenOptions() {
    if (!this.dayInfo) return;
    const allShichen = ShichenHelper.getAllShichen();
    this.shichenTexts = allShichen.map((sc, index) => 
      ShichenHelper.getShichenDisplayText(index, this.dayInfo!.day_gan)
    );
  }

  getShizhu(): string {
    if (!this.dayInfo) return 'æš‚æ— ';
    return ShichenHelper.getShizhuInfo(this.dayInfo.day_gan, this.selectedShichenIndex);
  }

  navigateToDunjia() {
    if (!this.dayInfo) return;
    router.pushUrl({
      url: 'pages/DunjiaPanel',
      params: {
        date: this.dayInfo.date,
        year_gan: this.dayInfo.year_gan,
        year_zhi: this.dayInfo.year_zhi,
        month_gan: this.dayInfo.month_gan,
        month_zhi: this.dayInfo.month_zhi,
        day_gan: this.dayInfo.day_gan,
        day_zhi: this.dayInfo.day_zhi,
        shizhu: this.getShizhu(),
        shichen_index: this.selectedShichenIndex
      }
    });
  }

  build() {
    Column({ space: 0 }) {
      // é¡¶éƒ¨å¯¼èˆªæ 
      NavigationBar({
        title: 'éç”²ç¬¦åº”ç»',
        rightActionText: 'è¯´æ˜',
        onRightAction: () => {
          router.pushUrl({
            url: 'pages/DocsPage'
          });
        }
      });

      Scroll() {
        Column({ space: 16 }) {
          // æœˆä»½åˆ‡æ¢æ 
          CalendarHeader({
            year: this.currentYear,
            month: this.currentMonth,
            onPrevMonth: () => {
              this.changeMonth(-1);
            },
            onNextMonth: () => {
              this.changeMonth(1);
            },
            onToday: () => {
              this.backToToday();
            },
            onYearClick: () => {
              this.showYearPicker = true;
            },
            onMonthClick: () => {
              this.showMonthPicker = true;
            }
          });

          // æ—¥å†ç½‘æ ¼ç»„ä»¶
          CalendarGrid({
            calendarDays: this.calendarDays,
            selectedDate: this.selectedDate,
            onDaySelected: (dayCell: DayCell) => {
              this.onDaySelected(dayCell);
            },
            onDayDoubleClick: (dayCell: DayCell) => {
              this.onDayDoubleClick(dayCell);
            }
          });

          if (this.dayInfo) {
            // é€‰ä¸­æ—¥æœŸè¯¦æƒ…åŒº
            Column({ space: 12 }) {
              // æ—¥æœŸä¿¡æ¯æ ‡é¢˜
              Column({ space: 8 }) {
                Text(`${this.dayInfo.year}å¹´${this.dayInfo.month}æœˆ${this.dayInfo.day}æ—¥  ${this.dayInfo.week_name}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#2C2416')
                
                // çœŸå¤ªé˜³æ—¶æ˜¾ç¤º - é†’ç›®æ ·å¼
                Row({ space: 8 }) {
                  Text('âš¡')
                    .fontSize(18)
                  Column({ space: 2 }) {
                    Row({ space: 4 }) {
                      Text('çœŸå¤ªé˜³æ—¶')
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#999999')
                      Text(this.solarTimeHelper.formatTrueSolarTime(this.selectedDate))
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#D4A574')
                    }
                    Text(`æœ¬åœ°æ—¶é—´${this.solarTimeHelper.getTimeDifferenceDescription(this.selectedDate)}`)
                      .fontSize(12)
                      .fontColor('#999999')
                    Text('çœŸå¤ªé˜³æ—¶è¯´æ˜')
                      .fontSize(12)
                      .fontColor('#D4A574')
                      .onClick(() => {
                        router.pushUrl({
                          url: 'pages/DocsPage'
                        });
                      })
                  }
                }
                .padding(10)
                .backgroundColor('#FFF8F0')
                .borderRadius(8)
                .width('100%')
              }

              // æ—¶è¾°é€‰æ‹©å™¨ç»„ä»¶
              ShichenSelector({
                shichenTexts: this.shichenTexts,
                selectedIndex: this.selectedShichenIndex,
                onShichenChanged: (index: number) => {
                  this.selectedShichenIndex = index;
                  // æ›´æ–°æ—¶æŸ±
                  if (this.dayInfo) {
                    this.currentShizhu = ShichenHelper.getShizhuInfo(this.dayInfo.day_gan, index);
                  }
                }
              });

              // å†œå†ä¿¡æ¯ç»„ä»¶
              LunarInfoPanel({
                lunarYear: this.dayInfo.lunar_year.toString(),
                lunarMonth: this.dayInfo.lunar_month,
                lunarDay: this.dayInfo.lunar_day,
                zodiac: this.dayInfo.zodiac,
                yearGan: this.dayInfo.year_gan,
                yearZhi: this.dayInfo.year_zhi,
                monthGan: this.dayInfo.month_gan,
                monthZhi: this.dayInfo.month_zhi,
                dayGan: this.dayInfo.day_gan,
                dayZhi: this.dayInfo.day_zhi,
                shiGan: this.currentShizhu.substring(0, 1),
                shiZhi: this.currentShizhu.substring(1, 2),
                solarTerm: this.dayInfo.solar_term,
                solarTermTime: this.dayInfo.solar_term_time,
                festivals: this.dayInfo.festivals
              });
            }
            .width('90%')

            // åº•éƒ¨æ“ä½œåŒº
            Column({ space: 12 }) {
              Button() {
                Row({ space: 8 }) {
                  Text('ğŸ”®')
                    .fontSize(20)
                  Text('è¿›å…¥å†æ³•æ¨æ¼”')
                    .fontSize(18)
                    .fontColor('#ffffff')
                }
              }
              .width('100%')
              .height(50)
              .backgroundColor('#D4A574')
              .borderRadius(25)
              .onClick(() => {
                this.navigateToDunjia();
              })

              Text(`åŸºäº ${this.dayInfo.year}.${this.dayInfo.month}.${this.dayInfo.day} ${ShichenHelper.getAllShichen()[this.selectedShichenIndex].name}`)
                .fontSize(12)
                .fontColor('#999999')
                .textAlign(TextAlign.Center)
            }
            .width('90%')
            .padding({ top: 10, bottom: 30 })
          }
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FAFAFA')
    .bindContentCover(this.showYearPicker, this.buildYearPicker(), {
      modalTransition: ModalTransition.DEFAULT
    })
    .bindContentCover(this.showMonthPicker, this.buildMonthPicker(), {
      modalTransition: ModalTransition.DEFAULT
    })
  }

  @Builder buildYearPicker() {
    Column({ space: 20 }) {
      Text('é€‰æ‹©å¹´ä»½')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#2C2416')
        .margin({ top: 20 })

      Grid() {
        ForEach([0, 1, 2, 3, 4, 5, 6, 7, 8], (row: number) => {
          ForEach([0, 1, 2], (col: number) => {
            GridItem() {
              Text((this.currentYear - (row * 3 + col) + 4).toString())
                .fontSize(16)
                .fontColor((this.currentYear - (row * 3 + col) + 4) === this.currentYear ? '#FFFFFF' : '#2C2416')
                .fontWeight((this.currentYear - (row * 3 + col) + 4) === this.currentYear ? FontWeight.Bold : FontWeight.Normal)
                .width('100%')
                .height(50)
                .textAlign(TextAlign.Center)
                .backgroundColor((this.currentYear - (row * 3 + col) + 4) === this.currentYear ? '#D4A574' : '#FFFFFF')
                .borderRadius(8)
                .border({ width: 1, color: (this.currentYear - (row * 3 + col) + 4) === this.currentYear ? '#D4A574' : '#eeeeee' })
                .onClick(() => {
                  this.changeYear(this.currentYear - (row * 3 + col) + 4);
                })
            }
          })
        })
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsTemplate('repeat(9, 1fr)')
      .rowsGap(10)
      .columnsGap(10)
      .width('90%')
      .height(500)

      Button('å–æ¶ˆ')
        .fontSize(16)
        .fontColor('#666666')
        .backgroundColor('#F5F5F5')
        .width('90%')
        .onClick(() => {
          this.showYearPicker = false;
        })
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius({ topLeft: 16, topRight: 16 })
  }

  @Builder buildMonthPicker() {
    Column({ space: 20 }) {
      Text('é€‰æ‹©æœˆä»½')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#2C2416')
        .margin({ top: 20 })

      Grid() {
        ForEach([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], (month: number) => {
          GridItem() {
            Text(`${month}æœˆ`)
              .fontSize(16)
              .fontColor(month === this.currentMonth ? '#FFFFFF' : '#2C2416')
              .fontWeight(month === this.currentMonth ? FontWeight.Bold : FontWeight.Normal)
              .width('100%')
              .height(60)
              .textAlign(TextAlign.Center)
              .backgroundColor(month === this.currentMonth ? '#D4A574' : '#FFFFFF')
              .borderRadius(8)
              .border({ width: 1, color: month === this.currentMonth ? '#D4A574' : '#eeeeee' })
              .onClick(() => {
                this.changeMonthDirect(month);
              })
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsTemplate('1fr 1fr 1fr 1fr')
      .rowsGap(10)
      .columnsGap(10)
      .width('90%')
      .height(300)

      Button('å–æ¶ˆ')
        .fontSize(16)
        .fontColor('#666666')
        .backgroundColor('#F5F5F5')
        .width('90%')
        .onClick(() => {
          this.showMonthPicker = false;
        })
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius({ topLeft: 16, topRight: 16 })
  }
}
