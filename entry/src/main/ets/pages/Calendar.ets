import { CalendarManager, CalendarDayInfo } from '../utils/CalendarManager';
import { ShichenHelper } from '../utils/ShichenHelper';
import { SolarTimeHelper, CHINA_CITY_LONGITUDES } from '../utils/SolarTimeHelper';
import { router } from '@kit.ArkUI';
import { NavigationBar } from '../components/NavigationBar';
import { CalendarHeader } from '../components/CalendarHeader';
import { CalendarGrid, DayCell } from '../components/CalendarGrid';
import { ShichenSelector } from '../components/ShichenSelector';
import { LunarInfoPanel } from '../components/LunarInfoPanel';

@Entry
@Component
struct CalendarPage {
  @State dayInfo: CalendarDayInfo | null = null;
  @State selectedShichenIndex: number = 0;
  @State shichenTexts: string[] = [];
  @State selectedDate: Date = new Date();
  @State currentYear: number = new Date().getFullYear();
  @State currentMonth: number = new Date().getMonth() + 1;
  @State calendarDays: DayCell[] = [];
  @State currentShizhu: string = 'æš‚æ— ';  // å½“å‰æ—¶æŸ±ï¼Œç”¨äºŽå“åº”å¼æ›´æ–°
  private solarTimeHelper: SolarTimeHelper = new SolarTimeHelper(CHINA_CITY_LONGITUDES.BEIJING);

  aboutToAppear() {
    CalendarManager.getInstance().init(getContext(this));
    // é»˜è®¤åŠ è½½å½“å¤©æ—¥æœŸ
    const now = new Date();
    this.selectedDate = now;
    this.currentYear = now.getFullYear();
    this.currentMonth = now.getMonth() + 1;
    this.generateCalendar(this.currentYear, this.currentMonth);
    // åˆå§‹åŒ–æ—¶è®¾ç½®ä¸ºå½“å‰ç³»ç»Ÿæ—¶è¾°
    this.selectedShichenIndex = ShichenHelper.getCurrentShichenIndex();
    this.loadDateInfo(now.getFullYear(), now.getMonth() + 1, now.getDate());
  }

  // ç”Ÿæˆæ—¥åŽ†æ•°æ®
  generateCalendar(year: number, month: number) {
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const daysInMonth = lastDay.getDate();
    
    // èŽ·å–æœˆä»½ç¬¬ä¸€å¤©æ˜¯å‘¨å‡  (0=å‘¨æ—¥, 1=å‘¨ä¸€...6=å‘¨å…­)
    let firstWeekDay = firstDay.getDay();
    // è½¬æ¢ä¸ºå‘¨ä¸€å¼€å§‹ (0=å‘¨ä¸€, 6=å‘¨æ—¥)
    firstWeekDay = firstWeekDay === 0 ? 6 : firstWeekDay - 1;
    
    const days: DayCell[] = [];
    
    // å¡«å……ä¸Šæœˆçš„å°¾éƒ¨æ—¥æœŸ
    if (firstWeekDay > 0) {
      const prevMonthLastDay = new Date(year, month - 1, 0).getDate();
      for (let i = firstWeekDay - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const date = new Date(year, month - 2, day);
        days.push({ day, isCurrentMonth: false, date });
      }
    }
    
    // å¡«å……å½“æœˆæ—¥æœŸ
    for (let i = 1; i <= daysInMonth; i++) {
      const date = new Date(year, month - 1, i);
      days.push({ day: i, isCurrentMonth: true, date });
    }
    
    // å¡«å……ä¸‹æœˆçš„å¼€å¤´æ—¥æœŸï¼Œå‡‘æˆ’42ä¸ªæ ¼å­(6å‘¨)
    const remainingCells = 42 - days.length;
    for (let i = 1; i <= remainingCells; i++) {
      const date = new Date(year, month, i);
      days.push({ day: i, isCurrentMonth: false, date });
    }
    
    this.calendarDays = days;
  }

  // åˆ‡æ¢æœˆä»½
  changeMonth(offset: number) {
    let newMonth = this.currentMonth + offset;
    let newYear = this.currentYear;
    
    if (newMonth > 12) {
      newMonth = 1;
      newYear++;
    } else if (newMonth < 1) {
      newMonth = 12;
      newYear--;
    }
    
    this.currentMonth = newMonth;
    this.currentYear = newYear;
    this.generateCalendar(newYear, newMonth);
  }

  // é€‰ä¸­æ—¥æœŸ
  async onDaySelected(dayCell: DayCell) {
    if (!dayCell.isCurrentMonth) {
      // å¦‚æžœç‚¹å‡»çš„æ˜¯ä¸Š/ä¸‹æœˆçš„æ—¥æœŸï¼Œåˆ‡æ¢æœˆä»½
      const offset = dayCell.date.getMonth() + 1 > this.currentMonth ? 1 : -1;
      this.changeMonth(offset);
    }
    
    this.selectedDate = dayCell.date;
    const year = dayCell.date.getFullYear();
    const month = dayCell.date.getMonth() + 1;
    const day = dayCell.date.getDate();
    await this.loadDateInfo(year, month, day);
  }

  async loadDateInfo(year: number, month: number, day: number) {
    console.log(`[Calendar] loadDateInfo: ${year}-${month}-${day}`);
    const info = await CalendarManager.getInstance().getDayInfo(year, month, day);
    console.log(`[Calendar] getDayInfo result:`, JSON.stringify(info));
    if (info) {
      // ç›´æŽ¥èµ‹å€¼ï¼Œä¸å†ç½®null
      this.dayInfo = info;
      // æ›´æ–°æ—¶æŸ±
      this.currentShizhu = ShichenHelper.getShizhuInfo(this.dayInfo.day_gan, this.selectedShichenIndex);
      console.log(`[Calendar] dayInfo updated:`, 
        `${this.dayInfo.year_gan}${this.dayInfo.year_zhi} ` +
        `${this.dayInfo.month_gan}${this.dayInfo.month_zhi} ` +
        `${this.dayInfo.day_gan}${this.dayInfo.day_zhi}`);
      // ä¸å†è‡ªåŠ¨é‡ç½®æ—¶è¾°ï¼Œä¿æŒç”¨æˆ·å·²é€‰æ‹©çš„æ—¶è¾°
      this.updateShichenOptions();
    } else {
      console.error(`[Calendar] Failed to load date info for ${year}-${month}-${day}`);
    }
  }

  async loadTodayInfo() {
    const now = new Date();
    this.selectedDate = now;
    // è¿”å›žä»Šå¤©æ—¶ï¼Œé‡ç½®ä¸ºå½“å‰ç³»ç»Ÿæ—¶è¾°
    this.selectedShichenIndex = ShichenHelper.getCurrentShichenIndex();
    await this.loadDateInfo(now.getFullYear(), now.getMonth() + 1, now.getDate());
  }

  updateShichenOptions() {
    if (!this.dayInfo) return;
    const allShichen = ShichenHelper.getAllShichen();
    this.shichenTexts = allShichen.map((sc, index) => 
      ShichenHelper.getShichenDisplayText(index, this.dayInfo!.day_gan)
    );
    console.log(`[Calendar] updateShichenOptions: dayGan=${this.dayInfo.day_gan}, ` +
      `selectedIndex=${this.selectedShichenIndex}, ` +
      `currentDisplay=${this.shichenTexts[this.selectedShichenIndex]}`);
  }

  getShizhu(): string {
    if (!this.dayInfo) return 'æš‚æ— ';
    return ShichenHelper.getShizhuInfo(this.dayInfo.day_gan, this.selectedShichenIndex);
  }

  navigateToDunjia() {
    if (!this.dayInfo) return;
    router.pushUrl({
      url: 'pages/DunjiaPanel',
      params: {
        date: this.dayInfo.date,
        year_gan: this.dayInfo.year_gan,
        year_zhi: this.dayInfo.year_zhi,
        month_gan: this.dayInfo.month_gan,
        month_zhi: this.dayInfo.month_zhi,
        day_gan: this.dayInfo.day_gan,
        day_zhi: this.dayInfo.day_zhi,
        shizhu: this.getShizhu(),
        shichen_index: this.selectedShichenIndex
      }
    });
  }

  build() {
    Column({ space: 0 }) {
      // é¡¶éƒ¨å¯¼èˆªæ 
      NavigationBar({
        title: 'éç”²ç¬¦åº”ç»',
        rightActionText: 'è¯´æ˜Ž',
        onRightAction: () => {
          router.pushUrl({
            url: 'pages/DocsPage'
          });
        }
      });

      Scroll() {
        Column({ space: 16 }) {
          // æœˆä»½åˆ‡æ¢æ 
          CalendarHeader({
            year: this.currentYear,
            month: this.currentMonth,
            onPrevMonth: () => {
              this.changeMonth(-1);
            },
            onNextMonth: () => {
              this.changeMonth(1);
            }
          });

          // æ—¥åŽ†ç½‘æ ¼ç»„ä»¶
          CalendarGrid({
            calendarDays: this.calendarDays,
            selectedDate: this.selectedDate,
            onDaySelected: (dayCell: DayCell) => {
              this.onDaySelected(dayCell);
            }
          });

          if (this.dayInfo) {
            // é€‰ä¸­æ—¥æœŸè¯¦æƒ…åŒº
            Column({ space: 12 }) {
              // æ—¥æœŸä¿¡æ¯æ ‡é¢˜
              Column({ space: 8 }) {
                Text(`${this.dayInfo.year}å¹´${this.dayInfo.month}æœˆ${this.dayInfo.day}æ—¥  ${this.dayInfo.week_name}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#2C2416')
                
                // çœŸå¤ªé˜³æ—¶æ˜¾ç¤º - é†’ç›®æ ·å¼
                Row({ space: 8 }) {
                  Text('âš¡')
                    .fontSize(18)
                  Column({ space: 2 }) {
                    Row({ space: 4 }) {
                      Text('çœŸå¤ªé˜³æ—¶')
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#999999')
                      Text(this.solarTimeHelper.formatTrueSolarTime(this.selectedDate))
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#D4A574')
                    }
                    Text(`æœ¬åœ°æ—¶é—´${this.solarTimeHelper.getTimeDifferenceDescription(this.selectedDate)}`)
                      .fontSize(12)
                      .fontColor('#999999')
                    Text('çœŸå¤ªé˜³æ—¶è¯´æ˜Ž')
                      .fontSize(12)
                      .fontColor('#D4A574')
                      .onClick(() => {
                        router.pushUrl({
                          url: 'pages/DocsPage'
                        });
                      })
                  }
                }
                .padding(10)
                .backgroundColor('#FFF8F0')
                .borderRadius(8)
                .width('100%')
              }

              // æ—¶è¾°é€‰æ‹©å™¨ç»„ä»¶
              ShichenSelector({
                shichenTexts: this.shichenTexts,
                selectedIndex: this.selectedShichenIndex,
                onShichenChanged: (index: number) => {
                  this.selectedShichenIndex = index;
                  // æ›´æ–°æ—¶æŸ±
                  if (this.dayInfo) {
                    this.currentShizhu = ShichenHelper.getShizhuInfo(this.dayInfo.day_gan, index);
                  }
                }
              });

              // å†œåŽ†ä¿¡æ¯ç»„ä»¶
              LunarInfoPanel({
                lunarYear: this.dayInfo.lunar_year.toString(),
                lunarMonth: this.dayInfo.lunar_month,
                lunarDay: this.dayInfo.lunar_day,
                zodiac: this.dayInfo.zodiac,
                yearGan: this.dayInfo.year_gan,
                yearZhi: this.dayInfo.year_zhi,
                monthGan: this.dayInfo.month_gan,
                monthZhi: this.dayInfo.month_zhi,
                dayGan: this.dayInfo.day_gan,
                dayZhi: this.dayInfo.day_zhi,
                shiGan: this.currentShizhu.substring(0, 1),
                shiZhi: this.currentShizhu.substring(1, 2),
                solarTerm: this.dayInfo.solar_term,
                solarTermTime: this.dayInfo.solar_term_time,
                festivals: this.dayInfo.festivals
              });
            }
            .width('90%')

            // åº•éƒ¨æ“ä½œåŒº
            Column({ space: 12 }) {
              Button() {
                Row({ space: 8 }) {
                  Text('ðŸ”®')
                    .fontSize(20)
                  Text('è¿›å…¥åŽ†æ³•æŽ¨æ¼”')
                    .fontSize(18)
                    .fontColor('#ffffff')
                }
              }
              .width('100%')
              .height(50)
              .backgroundColor('#D4A574')
              .borderRadius(25)
              .onClick(() => {
                this.navigateToDunjia();
              })

              Text(`åŸºäºŽ ${this.dayInfo.year}.${this.dayInfo.month}.${this.dayInfo.day} ${ShichenHelper.getAllShichen()[this.selectedShichenIndex].name}`)
                .fontSize(12)
                .fontColor('#999999')
                .textAlign(TextAlign.Center)
            }
            .width('90%')
            .padding({ top: 10, bottom: 30 })
          }
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FAFAFA')
  }
}
