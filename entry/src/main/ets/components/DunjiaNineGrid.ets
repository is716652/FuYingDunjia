import { DunjiaPanResult } from '../utils/DunjiaEngine'
import { GejuPattern } from '../utils/DunjiaEngine'
import { PalaceInfoCard, PalaceCardConfig } from './PalaceInfoCard'

/**
 * ‰πùÂÆ´Ê†ºÊòæÁ§∫ÁªÑ‰ª∂
 * 
 * ÂäüËÉΩÔºö
 * - Â±ïÁ§∫‰πùÂÆ¨Ê†ºÊéíÁõòÁªìÊûú
 * - ÊòæÁ§∫Êó∂Èó¥‰ø°ÊÅØÔºàÈò≥ÂéÜ„ÄÅÂÜúÂéÜ„ÄÅÁúüÂ§™Èò≥Êó∂Ôºâ
 * - ÊòæÁ§∫Â±ÄÊï∞‰ø°ÊÅØ
 * - Â§ÑÁêÜÂÆ¨‰ΩçÁÇπÂáª‰∫ã‰ª∂
 * 
 * ‰ΩøÁî®ÊñπÂºèÔºö
 * ```typescript
 * DunjiaNineGrid({
 *   panResult: this.panResult,
 *   selectedPalace: this.selectedPalace,
 *   onPalaceClick: (index) => { // Â§ÑÁêÜÁÇπÂáª }
 * })
 * ```
 */
@Component
export struct DunjiaNineGrid {
  @Prop panResult: DunjiaPanResult | null = null
  @Prop selectedPalace: number | null = null
  onPalaceClick?: (index: number) => void

  /**
   * Ê†ºÂºèÂåñÈò≥ÂéÜÊó•Êúü
   */
  private formatSolarDate(): string {
    if (!this.panResult) return ''
    const date = this.panResult.input.dateTime
    return `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà${date.getDate()}Êó•`
  }

  /**
   * Ëé∑ÂèñÂÆ´‰ΩçÁõ∏ÂÖ≥Ê†ºÂ±Ä
   */
  private getPalacePatterns(palaceIndex: number): string[] {
    if (!this.panResult || !this.panResult.gejuPatterns) return [];
    return this.panResult.gejuPatterns
      .filter(pattern => pattern.palaceIndices.includes(palaceIndex))
      .map(pattern => pattern.name);
  }

  /**
   * Ëé∑ÂèñÊ†ºÂ±ÄÈ¢úËâ≤
   */
  private getPatternColor(patternName: string): string {
    if (patternName.includes('Â§©ÈÅÅ') || patternName.includes('‰∏âÂ•áÂæó‰Ωø')) {
      return '#FF6B35'; // ÁâπÊÆäÊ†ºÂ±ÄÔºåÊ©ôËâ≤
    } else if (patternName.includes('Âú∞ÈÅÅ') || patternName.includes('‰∫∫ÈÅÅ')) {
      return '#D4A574'; // ‰∏ªË¶ÅÊ†ºÂ±ÄÔºåÈáëËâ≤
    }
    return '#4A90E2'; // Ê¨°Ë¶ÅÊ†ºÂ±ÄÔºåËìùËâ≤
  }

  /**
   * Ê∏≤ÊüìÂçï‰∏™ÂÆ´‰ΩçÂç°Áâá
   */
  @Builder
  buildPalaceCard(index: number) {
    if (this.panResult && this.panResult.palaces.length > index) {
      PalaceInfoCard({
        config: {
          palace: this.panResult.palaces[index],
          index: index,
          isSelected: this.selectedPalace === index,
          isZhiFu: this.panResult.zhiFuPalace === index,
          isZhiShi: this.panResult.zhiShiPalace === index,
          patterns: this.getPalacePatterns(index)
        },
        onCardClick: () => {
          if (this.onPalaceClick) {
            this.onPalaceClick(index)
          }
        }
      })
    }
  }

  build() {
    if (this.panResult) {
      Column({ space: 10 }) {
        // Êó∂Èó¥‰∏éÂ±ÄÊï∞‰ø°ÊÅØ
        Column({ space: 8 }) {
          // Èò≥ÂéÜÊó•Êúü+Êó∂Ëæ∞
          Row({ space: 8 }) {
            Text('Èò≥ÂéÜÔºö')
              .fontSize(13)
              .fontColor('#888888')
            Text(`${this.formatSolarDate()} ${this.panResult.hourGanZhi || ''}Êó∂`)
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#2C2416')
          }
          
          // ÂÜúÂéÜÊó•Êúü+Êó∂Ëæ∞
          if (this.panResult.dayInfo) {
            Row({ space: 8 }) {
              Text('ÂÜúÂéÜÔºö')
                .fontSize(13)
                .fontColor('#888888')
              Text(`${this.panResult.dayInfo.lunar_year}Âπ¥${this.panResult.dayInfo.lunar_month}Êúà${this.panResult.dayInfo.lunar_day}Êó• ${this.panResult.hourGanZhi || ''}Êó∂`)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#2C2416')
            }
          }
          
          // ÁúüÂ§™Èò≥Êó∂ÂÅèÁßª
          if (this.panResult.solarTimeOffset !== undefined) {
            Row({ space: 8 }) {
              Text('ÁúüÂ§™Èò≥Êó∂Ôºö')
                .fontSize(13)
                .fontColor('#888888')
              Text(`${this.panResult.solarTimeOffset >= 0 ? '+' : ''}${this.panResult.solarTimeOffset}ÂàÜÈíü`)
                .fontSize(13)
                .fontColor('#666666')
              Text(`(ÂΩìÂú∞ÁªèÂ∫¶${this.panResult.input.longitude.toFixed(2)}¬∞)`)
                .fontSize(11)
                .fontColor('#999999')
            }
          }
          
          Divider().color('#e0e0e0').strokeWidth(1).margin({ top: 4, bottom: 4 })
          
          // Â±ÄÊï∞
          Row({ space: 8 }) {
            Text('Â±ÄÊï∞Ôºö')
              .fontSize(13)
              .fontColor('#888888')
            Text(this.panResult.juLabel)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#D4A574')
          }
          
          if (this.panResult.summary && this.panResult.summary.overview) {
            Text(this.panResult.summary.overview)
              .fontSize(13)
              .fontColor('#666666')
              .lineHeight(20)
          }
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
        .padding({ left: 16, right: 16, top: 16, bottom: 16 })
        .backgroundColor('#ffffff')
        .borderRadius(12)
        .shadow({ radius: 8, color: '#22000000', offsetX: 0, offsetY: 2 })

        // Ê†ºÂ±ÄÊÄªËßà
        if (this.panResult.gejuPatterns && this.panResult.gejuPatterns.length > 0) {
          Column({ space: 8 }) {
            Row({ space: 8 }) {
              Text('üéØ')
                .fontSize(16)
              Text('ËØÜÂà´Ê†ºÂ±Ä')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
              Text(`${this.panResult.gejuPatterns.length}‰∏™`)
                .fontSize(12)
                .fontColor('#999999')
            }
            .width('100%')

            // Ê†ºÂ±ÄÂàóË°®
            Column({ space: 6 }) {
              ForEach(this.panResult.gejuPatterns, (pattern: GejuPattern) => {
                Row({ space: 8 }) {
                  Text(pattern.name)
                    .fontSize(13)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(this.getPatternColor(pattern.name))
                  Text(pattern.description)
                    .fontSize(12)
                    .fontColor('#666666')
                    .layoutWeight(1)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
                .width('100%')
                .padding({ left: 8, right: 8, top: 6, bottom: 6 })
                .backgroundColor('#F8F8F8')
                .borderRadius(6)
              })
            }
            .width('100%')
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor('#ffffff')
          .borderRadius(12)
          .shadow({ radius: 8, color: '#22000000', offsetX: 0, offsetY: 2 })
        }

        // ‰πùÂÆ´Ê†º
        Column({ space: 4 }) {
          // Á¨¨‰∏ÄË°åÔºö0,1,2
          Row({ space: 4 }) {
            this.buildPalaceCard(0)
            this.buildPalaceCard(1)
            this.buildPalaceCard(2)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)

          // Á¨¨‰∫åË°åÔºö3,4,5
          Row({ space: 4 }) {
            this.buildPalaceCard(3)
            this.buildPalaceCard(4)
            this.buildPalaceCard(5)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)

          // Á¨¨‰∏âË°åÔºö6,7,8
          Row({ space: 4 }) {
            this.buildPalaceCard(6)
            this.buildPalaceCard(7)
            this.buildPalaceCard(8)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
        }
        .width('100%')
      }
      .width('100%')
      .padding(16)
    }
  }
}
