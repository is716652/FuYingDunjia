import { DunjiaPanResult } from '../utils/DunjiaEngine'
import { GejuPattern } from '../utils/DunjiaEngine'

/**
 * ‰πùÂÆ´Ê†ºÊòæÁ§∫ÁªÑ‰ª∂
 * 
 * ÂäüËÉΩÔºö
 * - Â±ïÁ§∫‰πùÂÆ¨Ê†ºÊéíÁõòÁªìÊûú
 * - ÊòæÁ§∫Êó∂Èó¥‰ø°ÊÅØÔºàÈò≥ÂéÜ„ÄÅÂÜúÂéÜ„ÄÅÁúüÂ§™Èò≥Êó∂Ôºâ
 * - ÊòæÁ§∫Â±ÄÊï∞‰ø°ÊÅØ
 * - Â§ÑÁêÜÂÆ¨‰ΩçÁÇπÂáª‰∫ã‰ª∂
 * 
 * ‰ΩøÁî®ÊñπÂºèÔºö
 * ```typescript
 * DunjiaNineGrid({
 *   panResult: this.panResult,
 *   selectedPalace: this.selectedPalace,
 *   onPalaceClick: (index) => { // Â§ÑÁêÜÁÇπÂáª }
 * })
 * ```
 */
@Component
export struct DunjiaNineGrid {
  @Prop panResult: DunjiaPanResult | null = null
  @Prop selectedPalace: number | null = null
  onPalaceClick?: (index: number) => void

  /**
   * Ê†ºÂºèÂåñÈò≥ÂéÜÊó•Êúü
   */
  private formatSolarDate(): string {
    if (!this.panResult) return ''
    const date = this.panResult.input.dateTime
    return `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà${date.getDate()}Êó•`
  }

  /**
   * Ëé∑ÂèñÂÆ´‰ΩçÁõ∏ÂÖ≥Ê†ºÂ±Ä
   */
  private getPalacePatterns(palaceIndex: number): string[] {
    if (!this.panResult || !this.panResult.gejuPatterns) return [];
    return this.panResult.gejuPatterns
      .filter(pattern => pattern.palaceIndices.includes(palaceIndex))
      .map(pattern => pattern.name);
  }

  /**
   * Ëé∑ÂèñÊ†ºÂ±ÄÈ¢úËâ≤
   */
  private getPatternColor(patternName: string): string {
    if (patternName.includes('Â§©ÈÅÅ') || patternName.includes('‰∏âÂ•áÂæó‰Ωø')) {
      return '#FF6B35'; // ÁâπÊÆäÊ†ºÂ±ÄÔºåÊ©ôËâ≤
    } else if (patternName.includes('Âú∞ÈÅÅ') || patternName.includes('‰∫∫ÈÅÅ')) {
      return '#D4A574'; // ‰∏ªË¶ÅÊ†ºÂ±ÄÔºåÈáëËâ≤
    }
    return '#4A90E2'; // Ê¨°Ë¶ÅÊ†ºÂ±ÄÔºåËìùËâ≤
  }

  /**
   * Ê∏≤ÊüìÂçï‰∏™ÂÆ´‰ΩçÂç°Áâá
   */
  @Builder
  buildPalaceCard(index: number) {
    if (this.panResult && this.panResult.palaces.length > index) {
      Stack({ alignContent: Alignment.TopEnd }) {
        Column({ space: 3 }) {
          // ÂÆ´Âêç
          Text(this.panResult.palaces[index].palaceName)
            .fontSize(11)
            .fontColor('#888888')
            .textAlign(TextAlign.Start)
            .width('100%')
          
          // ‰πùÊòüÔºà‰∏ªË¶ÅÊòæÁ§∫Ôºâ
          Text(this.panResult.palaces[index].starName || '')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#2C2416')
            .textAlign(TextAlign.Center)
            .width('100%')
            .margin({ top: 2 })
          
          // ÂÖ´Èó®
          Text(this.panResult.palaces[index].doorName || '')
            .fontSize(12)
            .fontColor('#555555')
            .textAlign(TextAlign.Center)
            .width('100%')
            .margin({ top: 1 })
          
          // ÂàÜÂâ≤Á∫ø
          Divider()
            .color('#f0f0f0')
            .strokeWidth(0.5)
            .margin({ top: 3, bottom: 3 })
          
          // Â§©ÁõòÂú∞ÁõòÂπ≤ÊîØ
          Row({ space: 5 }) {
            Text('Â§©')
              .fontSize(9)
              .fontColor('#999999')
            Text(this.panResult.palaces[index].tianGan || '')
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
              .fontColor('#D4691A')
            Text('Âú∞')
              .fontSize(9)
              .fontColor('#999999')
            Text(this.panResult.palaces[index].diGan || '')
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
              .fontColor('#2A7A8C')
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .margin({ top: 1 })
          
          // ÂÖ´Á•û
          Text(this.panResult.palaces[index].deityName || '')
            .fontSize(10)
            .fontColor('#8B6914')
            .textAlign(TextAlign.Center)
            .width('100%')
            .margin({ top: 2 })
          
          // Ê†ºÂ±ÄÂæΩÁ´†
          if (this.getPalacePatterns(index).length > 0) {
            Row({ space: 2 }) {
              ForEach(this.getPalacePatterns(index).slice(0, 2), (patternName: string) => {
                Text(patternName)
                  .fontSize(9)
                  .fontColor('#FFFFFF')
                  .backgroundColor(this.getPatternColor(patternName))
                  .padding({ left: 4, right: 4, top: 1, bottom: 1 })
                  .borderRadius(4)
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ top: 3 })
          }
        }
        .width('100%')

        // ÂÄºÁ¨¶/ÂÄº‰ΩøËßíÊ†á
        if (this.panResult.zhiFuPalace === index) {
          Text('Á¨¶')
            .fontSize(11)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .backgroundColor('#D4A574')
            .padding({ left: 5, right: 5, top: 2, bottom: 2 })
            .borderRadius({ topRight: 8, bottomLeft: 8 })
        } else if (this.panResult.zhiShiPalace === index) {
          Text('‰Ωø')
            .fontSize(11)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .backgroundColor('#4A6A8B')
            .padding({ left: 5, right: 5, top: 2, bottom: 2 })
            .borderRadius({ topRight: 8, bottomLeft: 8 })
        }
      }
      .width('32%')
      .height(145)
      .padding({ left: 8, right: 8, top: 8, bottom: 8 })
      .backgroundColor(this.selectedPalace === index ? '#FFF8F0' : '#FFFFFF')
      .borderRadius(8)
      .border({
        width: (this.panResult.zhiFuPalace === index || this.panResult.zhiShiPalace === index) ? 2 : 1,
        color: (this.panResult.zhiFuPalace === index) ? '#D4A574' : (this.panResult.zhiShiPalace === index ? '#4A6A8B' : '#E0E0E0')
      })
      .shadow({
        radius: (this.panResult.zhiFuPalace === index || this.panResult.zhiShiPalace === index) ? 10 : 4,
        color: (this.panResult.zhiFuPalace === index) ? '#33D4A574' : '#22000000',
        offsetX: 0,
        offsetY: 1
      })
      .onClick(() => {
        if (this.onPalaceClick) {
          this.onPalaceClick(index)
        }
      })
    }
  }

  build() {
    if (this.panResult) {
      Column({ space: 10 }) {
        // Êó∂Èó¥‰∏éÂ±ÄÊï∞‰ø°ÊÅØ
        Column({ space: 8 }) {
          // Èò≥ÂéÜÊó•Êúü+Êó∂Ëæ∞
          Row({ space: 8 }) {
            Text('Èò≥ÂéÜÔºö')
              .fontSize(13)
              .fontColor('#888888')
            Text(`${this.formatSolarDate()} ${this.panResult.hourGanZhi || ''}Êó∂`)
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#2C2416')
          }
          
          // ÂÜúÂéÜÊó•Êúü+Êó∂Ëæ∞
          if (this.panResult.dayInfo) {
            Row({ space: 8 }) {
              Text('ÂÜúÂéÜÔºö')
                .fontSize(13)
                .fontColor('#888888')
              Text(`${this.panResult.dayInfo.lunar_year}Âπ¥${this.panResult.dayInfo.lunar_month}Êúà${this.panResult.dayInfo.lunar_day}Êó• ${this.panResult.hourGanZhi || ''}Êó∂`)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#2C2416')
            }
          }
          
          // ÁúüÂ§™Èò≥Êó∂ÂÅèÁßª
          if (this.panResult.solarTimeOffset !== undefined) {
            Row({ space: 8 }) {
              Text('ÁúüÂ§™Èò≥Êó∂Ôºö')
                .fontSize(13)
                .fontColor('#888888')
              Text(`${this.panResult.solarTimeOffset >= 0 ? '+' : ''}${this.panResult.solarTimeOffset}ÂàÜÈíü`)
                .fontSize(13)
                .fontColor('#666666')
              Text(`(ÂΩìÂú∞ÁªèÂ∫¶${this.panResult.input.longitude.toFixed(2)}¬∞)`)
                .fontSize(11)
                .fontColor('#999999')
            }
          }
          
          Divider().color('#e0e0e0').strokeWidth(1).margin({ top: 4, bottom: 4 })
          
          // Â±ÄÊï∞
          Row({ space: 8 }) {
            Text('Â±ÄÊï∞Ôºö')
              .fontSize(13)
              .fontColor('#888888')
            Text(this.panResult.juLabel)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#D4A574')
          }
          
          if (this.panResult.summary && this.panResult.summary.overview) {
            Text(this.panResult.summary.overview)
              .fontSize(13)
              .fontColor('#666666')
              .lineHeight(20)
          }
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
        .padding({ left: 16, right: 16, top: 16, bottom: 16 })
        .backgroundColor('#ffffff')
        .borderRadius(12)
        .shadow({ radius: 8, color: '#22000000', offsetX: 0, offsetY: 2 })

        // Ê†ºÂ±ÄÊÄªËßà
        if (this.panResult.gejuPatterns && this.panResult.gejuPatterns.length > 0) {
          Column({ space: 8 }) {
            Row({ space: 8 }) {
              Text('üéØ')
                .fontSize(16)
              Text('ËØÜÂà´Ê†ºÂ±Ä')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
              Text(`${this.panResult.gejuPatterns.length}‰∏™`)
                .fontSize(12)
                .fontColor('#999999')
            }
            .width('100%')

            // Ê†ºÂ±ÄÂàóË°®
            Column({ space: 6 }) {
              ForEach(this.panResult.gejuPatterns, (pattern: GejuPattern) => {
                Row({ space: 8 }) {
                  Text(pattern.name)
                    .fontSize(13)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(this.getPatternColor(pattern.name))
                  Text(pattern.description)
                    .fontSize(12)
                    .fontColor('#666666')
                    .layoutWeight(1)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
                .width('100%')
                .padding({ left: 8, right: 8, top: 6, bottom: 6 })
                .backgroundColor('#F8F8F8')
                .borderRadius(6)
              })
            }
            .width('100%')
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor('#ffffff')
          .borderRadius(12)
          .shadow({ radius: 8, color: '#22000000', offsetX: 0, offsetY: 2 })
        }

        // ‰πùÂÆ´Ê†º
        Column({ space: 4 }) {
          // Á¨¨‰∏ÄË°åÔºö0,1,2
          Row({ space: 4 }) {
            this.buildPalaceCard(0)
            this.buildPalaceCard(1)
            this.buildPalaceCard(2)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)

          // Á¨¨‰∫åË°åÔºö3,4,5
          Row({ space: 4 }) {
            this.buildPalaceCard(3)
            this.buildPalaceCard(4)
            this.buildPalaceCard(5)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)

          // Á¨¨‰∏âË°åÔºö6,7,8
          Row({ space: 4 }) {
            this.buildPalaceCard(6)
            this.buildPalaceCard(7)
            this.buildPalaceCard(8)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
        }
        .width('100%')
      }
      .width('100%')
      .padding(16)
    }
  }
}
