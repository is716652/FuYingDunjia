/**
 * ShichenSelector æ—¶è¾°é€‰æ‹©å™¨ç»„ä»¶
 * 
 * åŠŸèƒ½ï¼š
 * - æ˜¾ç¤ºå½“å‰é€‰ä¸­æ—¶è¾°
 * - ç‚¹å‡»å±•å¼€ç½‘æ ¼é€‰æ‹©å™¨ï¼ˆ4è¡Œ x 3åˆ—ï¼‰
 * - é«˜äº®æ˜¾ç¤ºå½“å‰é€‰ä¸­æ—¶è¾°
 * 
 * ä½¿ç”¨ç¤ºä¾‹ï¼š
 * ShichenSelector({
 *   shichenTexts: this.shichenTexts,
 *   selectedIndex: this.selectedShichenIndex,
 *   onShichenChanged: (index: number) => {
 *     this.selectedShichenIndex = index;
 *   }
 * })
 */

interface ShichenInfo {
  name: string;
  range: string;
  ganZhi: string;
  wuxing: string;
}

@Component
export struct ShichenSelector {
  @Prop shichenTexts: string[] = [];
  @Prop selectedIndex: number = 0;
  
  @State showGrid: boolean = false;
  
  onShichenChanged?: (index: number) => void;

  build() {
    Column({ space: 12 }) {
      // å½“å‰é€‰ä¸­æ—¶è¾°æ˜¾ç¤ºåŒºåŸŸ
      Row({ space: 8 }) {
        Text('ğŸ•')
          .fontSize(18)
        Text(this.shichenTexts[this.selectedIndex] || 'è¯·é€‰æ‹©æ—¶è¾°')
          .fontSize(15)
          .fontColor('#2C2416')
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
        Text(this.showGrid ? 'â–²' : 'â–¼')
          .fontSize(12)
          .fontColor('#999999')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .border({ width: 1, color: '#E5E5E5' })
      .shadow({ radius: 4, color: '#10000000', offsetY: 2 })
      .onClick(() => {
        this.showGrid = !this.showGrid;
      })
      
      // ç½‘æ ¼é€‰æ‹©å™¨ï¼ˆå±•å¼€æ—¶æ˜¾ç¤ºï¼‰
      if (this.showGrid) {
        Column({ space: 10 }) {
          ForEach([0, 1, 2, 3], (rowIndex: number) => {
            Row({ space: 10 }) {
              ForEach([0, 1, 2], (colIndex: number) => {
                this.buildShichenCell(rowIndex * 3 + colIndex)
              })
            }
            .width('100%')
          })
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#FAFAFA')
        .borderRadius(12)
      }
    }
    .width('100%')
  }

  // è§£ææ—¶è¾°æ–‡æœ¬
  private parseShichenText(text: string): ShichenInfo {
    // è§£ææ–‡æœ¬ï¼šå­æ—¶ï¼ˆ23:00-01:00ï¼‰ç”²å­æ—¶ æ°´
    const match = text.match(/(\S+æ—¶)ï¼ˆ([^)]+)ï¼‰(\S+æ—¶)?\s*(\S+)?/);
    return {
      name: match ? match[1] : text,
      range: match ? match[2] : '',
      ganZhi: match ? (match[3] || '') : '',
      wuxing: match ? (match[4] || '') : ''
    };
  }

  @Builder buildShichenCell(index: number) {
    Column({ space: 4 }) {
      // æ—¶è¾°åç§°
      Text(this.parseShichenText(this.shichenTexts[index] || '').name)
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.selectedIndex === index ? '#FFFFFF' : '#333333')
      
      // å¹²æ”¯
      Text(this.parseShichenText(this.shichenTexts[index] || '').ganZhi)
        .fontSize(12)
        .fontColor(this.selectedIndex === index ? '#FFFFFF' : '#666666')
        .visibility(this.parseShichenText(this.shichenTexts[index] || '').ganZhi ? Visibility.Visible : Visibility.None)
      
      // æ—¶é—´èŒƒå›´
      Text(this.parseShichenText(this.shichenTexts[index] || '').range)
        .fontSize(10)
        .fontColor(this.selectedIndex === index ? 'rgba(255,255,255,0.8)' : '#999999')
        .visibility(this.parseShichenText(this.shichenTexts[index] || '').range ? Visibility.Visible : Visibility.None)
    }
    .justifyContent(FlexAlign.Center)
    .layoutWeight(1)
    .height(70)
    .padding({ top: 8, bottom: 8, left: 4, right: 4 })
    .backgroundColor(this.selectedIndex === index ? '#D4A574' : '#FFFFFF')
    .borderRadius(10)
    .border({
      width: this.selectedIndex === index ? 0 : 1,
      color: '#E5E5E5'
    })
    .shadow({
      radius: this.selectedIndex === index ? 8 : 2,
      color: this.selectedIndex === index ? '#40D4A574' : '#10000000',
      offsetY: this.selectedIndex === index ? 4 : 1
    })
    .onClick(() => {
      if (this.onShichenChanged) {
        this.onShichenChanged(index);
      }
      this.showGrid = false;  // é€‰æ‹©åè‡ªåŠ¨æ”¶èµ·
    })
  }
}
