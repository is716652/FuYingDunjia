import { DunjiaPanResult, PalaceState, GejuPattern } from '../utils/DunjiaEngine'

/**
 * ä¹æ˜Ÿæ–­è¯­ä¿¡æ¯
 */
interface StarInterpretation {
  summary: string;
  favorable: string;
  unfavorable: string;
}

/**
 * å…«é—¨å‰å‡¶ä¿¡æ¯
 */
interface DoorInterpretation {
  type: string;
  summary: string;
  favorable: string;
  unfavorable: string;
}

/**
 * å®«ä½è¯¦æƒ…é¢æ¿ç»„ä»¶ï¼ˆå¤ç±çŸ¥è¯†ç‰ˆï¼‰
 * 
 * åŠŸèƒ½ï¼š
 * - åŸºäºã€Šéç”²ç¬¦åº”ç»ã€‹çš„ä¹æ˜Ÿå…«é—¨çŸ¥è¯†è§£è¯»
 * - æ ¼å±€æ·±åº¦åˆ†æä¸å¤ç±ä¾æ®
 * - å¤©åœ°ç›˜ç»„åˆå‰å‡¶åˆ¤æ–­
 * - åº”ç”¨å»ºè®®ä¸æ—¶æœºå‚è€ƒ
 */

@Component
export struct PalaceDetailPanel {
  @Prop panResult: DunjiaPanResult | null = null
  @Prop selectedPalace: number | null = null

  /**
   * è·å–é€‰ä¸­å®«ä½
   */
  private getSelectedPalaceState(): PalaceState | null {
    if (!this.panResult || this.selectedPalace === null) return null;
    return this.panResult.palaces[this.selectedPalace];
  }

  /**
   * è·å–ç›¸å…³æ ¼å±€
   */
  private getRelatedPatterns(): GejuPattern[] {
    if (!this.panResult || this.selectedPalace === null || !this.panResult.gejuPatterns) return [];
    return this.panResult.gejuPatterns.filter(pattern => 
      pattern.palaceIndices.includes(this.selectedPalace!)
    );
  }

  /**
   * è·å–äº”è¡Œç”Ÿå…‹å…³ç³»
   */
  private getWuxingRelation(): string {
    const palace = this.getSelectedPalaceState();
    if (!palace) return '';
    
    interface WuxingRelationInfo {
      sheng: string;
      ke: string;
      beike: string;
      beisheng: string;
    }

    const wuxingShengke: Record<string, WuxingRelationInfo> = {
      'æ°´': { sheng: 'æœ¨', ke: 'ç«', beike: 'åœŸ', beisheng: 'é‡‘' },
      'ç«': { sheng: 'åœŸ', ke: 'é‡‘', beike: 'æ°´', beisheng: 'æœ¨' },
      'æœ¨': { sheng: 'ç«', ke: 'åœŸ', beike: 'é‡‘', beisheng: 'æ°´' },
      'é‡‘': { sheng: 'æ°´', ke: 'æœ¨', beike: 'ç«', beisheng: 'åœŸ' },
      'åœŸ': { sheng: 'é‡‘', ke: 'æ°´', beike: 'æœ¨', beisheng: 'ç«' }
    };
    
    const element = palace.palaceElement;
    const relation = wuxingShengke[element];
    if (!relation) return '';
    
    return `ç”Ÿ${relation.sheng} å…‹${relation.ke} è¢«${relation.beike}å…‹ ${relation.beisheng}ç”Ÿæˆ‘`;
  }

  /**
   * è·å–å€¼ç¬¦å€¼ä½¿è¯´æ˜
   */
  private getZhiFuZhiShiInfo(): string {
    if (!this.panResult || this.selectedPalace === null) return '';
      
    if (this.panResult.zhiFuPalace === this.selectedPalace) {
      return 'æ­¤å®«ä¸ºå€¼ç¬¦æ‰€åœ¨,ä¸ºä¸»å¯¼åŠ›é‡,ä»£è¡¨å¤©æ—¶ä¹‹åˆ©';
    } else if (this.panResult.zhiShiPalace === this.selectedPalace) {
      return 'æ­¤å®«ä¸ºå€¼ä½¿æ‰€åœ¨,ä¸ºè¡ŒåŠ¨ä¹‹é—¨,ä»£è¡¨æ—¶æœºæŠŠæ¡';
    }
    return '';
  }
  
  /**
   * è·å–ä¹æ˜Ÿæ–­è¯­
   */
  private getStarInterpretation(): StarInterpretation | null {
    const palace = this.getSelectedPalaceState();
    if (!palace || !palace.starName) return null;
      
    const starInfo: Record<string, StarInterpretation> = {
      'å¤©è“¬': {
        summary: 'æ™ºæ…§å†’é™©,ä½†ä¸»ç›—è´¼ç ´è´¢ã€‚æ˜¥å¤å‡ºå…µåˆ©å·¦å°†,ç§‹å†¬å¤§å‡¶ã€‚',
        favorable: 'å®‰æŠšè¾¹å¢ƒã€ä¿®ç­‘åŸæ± ã€æ˜¥å¤å­£èŠ‚å†›äº‹è¡ŒåŠ¨',
        unfavorable: 'ç§‹å†¬ç”¨äº‹ã€å«å¨¶ã€æ¬å®¶ã€å…¥å®˜ã€ç»å•†ã€äº‰æ–—'
      },
      'å¤©èŠ®': {
        summary: 'ç—…æ˜Ÿå­¦ç”Ÿæ˜Ÿã€‚ç§‹å†¬å‰,æ˜¥å¤å‡¶ã€‚åˆ©æ±‚åŒ»æ‹œå¸ˆ,å¿Œç”¨å…µå«å¨¶ã€‚',
        favorable: 'æ±‚åŒ»é—®è¯ã€æ‹œå¸ˆå­¦è‰ºã€ç»“äº¤æœ‹å‹',
        unfavorable: 'ç”¨å…µã€å«å¨¶ã€è¯‰è®¼ã€æ¬å®¶ã€ç›–æˆ¿ã€æ˜¥ç§‹ç”¨äº‹å¤§å‡¶'
      },
      'å¤©å†²': {
        summary: 'é›·ç¥è¡ŒåŠ¨æ˜Ÿã€‚å†²åŠ¨å‡ºå‡»,å¿«é€Ÿè¡ŒåŠ¨ã€‚æ˜¥å¤å¤§å‰,ç§‹å†¬å‡¶ã€‚',
        favorable: 'å‡ºå…µæŠ¥ä»‡ã€æ˜¥å¤å­£èŠ‚ä½œæˆ˜(å·¦å°†èƒœ)',
        unfavorable: 'ç§‹å†¬ç”¨äº‹ã€å«å¨¶ã€æ¬å®¶ã€å…¥å®˜ã€ç¥­ç¥€ã€ç»å•†'
      },
      'å¤©è¾…': {
        summary: 'æ–‡æ›²è´µäººæ˜Ÿ(ä¸Šå‰)ã€‚æ•™è‚²æ–‡åŒ–è´µäººæ‰¶æŒã€‚æ˜¥å¤å¤§å‰ã€‚',
        favorable: 'è¯»ä¹¦å­¦ä¹ ã€è®¾ç«‹å­¦æ ¡ã€å¸¦å…µã€å«å¨¶(å¤šå­å¤šç¦)ã€æ¬å®¶ã€ç»å•†ã€å…¥å®˜ã€ç›–æˆ¿(æ˜¥å¤å°¤å‰)',
        unfavorable: 'æ— æ˜æ˜¾ç¦å¿Œ,ç§‹å†¬åŠ›é‡å‡å¼±'
      },
      'å¤©ç¦½': {
        summary: 'å¸ç‹è°ƒå’Œæ˜Ÿ(ä¸Šå‰)ã€‚ä¸­æ­£ç¨³å®š,ç™¾äº‹çš†å®œ,å››å­£çš†å‰ã€‚',
        favorable: 'ç¥­ç¥€æ±‚ç¦ã€å¸¦å…µ(å››æ—¶çš†å‰)ã€å°å®˜æˆçˆµã€æ¬å®¶ã€å…¥å®˜ã€ç»å•†ã€å«å¨¶',
        unfavorable: 'å‡ ä¹æ— ç¦å¿Œ'
      },
      'å¤©å¿ƒ': {
        summary: 'åŒ»æ˜Ÿé¢†å¯¼æ˜Ÿ(ä¸Šå‰)ã€‚åŒ»ç–—ç§‘æŠ€é¢†å¯¼åŠ›ã€‚ç§‹å†¬å¤§å‰,æ˜¥å¤å‡¶ã€‚',
        favorable: 'æ²»ç—…åˆè¯ã€å¸¦å…µã€å«å¨¶ã€å…¥å®˜ã€ç›–æˆ¿ã€ç¥­ç¥€ã€ç»å•†(ç§‹å†¬å‰)',
        unfavorable: 'æ˜¥å¤ç”¨äº‹ä¸åˆ©ã€å°äººè¡Œäº‹åæ‹›ç¥¸'
      },
      'å¤©æŸ±': {
        summary: 'ç ´åéšå£«æ˜Ÿ(å°å‡¶)ã€‚å£èˆŒå˜é©ã€‚åˆ©å®ˆä¸åˆ©æ”»,å®œé™ä¸å®œåŠ¨ã€‚',
        favorable: 'å±¯å…µè‡ªå®ˆã€éšå±…é¿ä¸–ã€å«å¨¶ã€ä¿®é€ ã€ç¥­ç¥€(æœ‰é™å¯ç”¨)',
        unfavorable: 'å¸¦å…µå‡ºå¾ã€æ¬å®¶ã€å…¥å®˜ã€ç»å•†'
      },
      'å¤©ä»»': {
        summary: 'è¯šä¿¡å»ºç­‘æ˜Ÿ(æ¬¡å‰)ã€‚ç¨³é‡ç§¯ç´¯ã€‚å››å­£æœˆå¤§å‰,åˆ©å®ˆæˆä¸åˆ©å˜åŠ¨ã€‚',
        favorable: 'æ‹œè®¿è´µäººã€é€šè´¢åˆ©ã€å¸¦å…µ(å››æ—¶çš†å‰)ã€å«å¨¶(åˆ©å­å­™)ã€å…¥å®˜',
        unfavorable: 'æ¬å®¶ã€ç›–æˆ¿'
      },
      'å¤©è‹±': {
        summary: 'åå£°æ€¥èºæ˜Ÿ(å°å‡¶)ã€‚è™šåç«ç¾ã€‚å¤å°å‡¶,å†¬å¤§å‡¶ã€‚åˆ©è™šåä¸åˆ©å®åˆ©ã€‚',
        favorable: 'å‡ºè¡Œè¿œè¡Œã€é¥®å®´ä½œä¹ã€å«å¨¶(åˆ©åå£°)',
        unfavorable: 'å‡ºå…µã€æ¬å®¶ã€å…¥å®˜ã€ç›–æˆ¿ã€è¯‰è®¼ã€ç»å•†'
      }
    };
      
    return starInfo[palace.starName] || null;
  }
  
  /**
   * è·å–å…«é—¨å‰å‡¶
   */
  private getDoorInterpretation(): DoorInterpretation | null {
    const palace = this.getSelectedPalaceState();
    if (!palace || !palace.doorName) return null;
      
    const doorInfo: Record<string, DoorInterpretation> = {
      'å¼€é—¨': {
        type: 'å‰é—¨',
        summary: 'ä¸‰å¤§å‰é—¨ä¹‹é¦–ã€‚ä¸»å¼€é€šé¡ºè¾¾,ç™¾äº‹å¯ä¸ºã€‚',
        favorable: 'è¿œè¡Œã€ç­¾çº¦ã€å‡èŒã€å¼€ä¸šã€æ±‚èŒã€è§è´µäºº',
        unfavorable: 'å‡ ä¹æ— ç¦å¿Œ'
      },
      'ä¼‘é—¨': {
        type: 'å‰é—¨',
        summary: 'ä¸‰å¤§å‰é—¨ä¹‹ä¸€ã€‚ä¸»ä¼‘å…»ç”Ÿæ¯,è°ˆåˆ¤åå•†ã€‚',
        favorable: 'ä¼‘æ¯ç–—å…»ã€è°ˆåˆ¤åå•†ã€å­¦ä¹ è¿›ä¿®ã€å…»ç”Ÿä¿®ç‚¼',
        unfavorable: 'ä¸å®œç´§æ€¥è¡ŒåŠ¨'
      },
      'ç”Ÿé—¨': {
        type: 'å‰é—¨',
        summary: 'ä¸‰å¤§å‰é—¨ä¹‹ä¸€ã€‚ä¸»ç”Ÿè´¢ç½®ä¸š,åˆ›ä¸šæ±‚è´¢ã€‚',
        favorable: 'æ±‚è´¢ã€ç½®ä¸šã€è§è´µäººã€åˆ›ä¸šã€æŠ•èµ„ã€è´¸æ˜“',
        unfavorable: 'ä¸å®œç ´åæ€§è¡ŒåŠ¨'
      },
      'ä¼¤é—¨': {
        type: 'å‡¶é—¨',
        summary: 'äº”å¤§å‡¶é—¨ã€‚ä¸»ä¼¤å®³å†²çª,ä½†åˆ©ç«äº‰è®¨å€ºã€‚',
        favorable: 'æ•çŒã€ç«äº‰ã€æ‰‹æœ¯ã€è®¨å€ºã€ç´¢èµ”',
        unfavorable: 'å‡ºè¡Œã€å«å¨¶ã€ç­¾çº¦ã€åˆä½œ'
      },
      'æœé—¨': {
        type: 'å‡¶é—¨',
        summary: 'äº”å¤§å‡¶é—¨ã€‚ä¸»é—­å¡éšè—,åˆ©ä¿å¯†é˜²èŒƒã€‚',
        favorable: 'éšè”½è¡ŒåŠ¨ã€ä¿å¯†å·¥ä½œã€é˜²å°äººã€è—åŒ¿',
        unfavorable: 'å…¬å¼€æ´»åŠ¨ã€å®£ä¼ æ¨å¹¿ã€ç¤¾äº¤å¨±ä¹'
      },
      'æ™¯é—¨': {
        type: 'ä¸­å¹³',
        summary: 'åŠå‰åŠå‡¶ã€‚ä¸»æ–‡ä¹¦åå£°,åˆ©è€ƒè¯•é¢è¯•ã€‚',
        favorable: 'ä¸Šä¹¦ã€é¢è¯•ã€å®£ä¼ ã€è€ƒè¯•ã€æ–‡åŒ–æ´»åŠ¨',
        unfavorable: 'ä¸§è‘¬ã€é˜´æš—ä¹‹äº‹'
      },
      'æ­»é—¨': {
        type: 'å‡¶é—¨',
        summary: 'äº”å¤§å‡¶é—¨ã€‚ä¸»ç»ˆç»“æ­»äº¡,ä»…åˆ©ä¸§è‘¬ã€‚',
        favorable: 'ä¸§è‘¬ã€è¯›ç½šã€ç»“æŸæ—§äº‹',
        unfavorable: 'ä¸€åˆ‡æ–°å¼€å§‹ã€åˆ›ä¸šã€å«å¨¶ã€æ¬å®¶'
      },
      'æƒŠé—¨': {
        type: 'å‡¶é—¨',
        summary: 'äº”å¤§å‡¶é—¨ã€‚ä¸»æƒŠæå®˜å¸,åˆ©è¯‰è®¼æŠ“æ•ã€‚',
        favorable: 'è¯‰è®¼ã€æŠ“æ•ã€æ¼”è®²ã€æƒŠé†’',
        unfavorable: 'å®‰é™ä¹‹äº‹ã€ç–—å…»ã€ç­¾çº¦'
      }
    };
      
    return doorInfo[palace.doorName] || null;
  }

  build() {
    if (this.selectedPalace !== null && this.getSelectedPalaceState()) {
      Column({ space: 16 }) {
        // æ ‡é¢˜æ 
        Text('å®«ä½è¯¦æƒ…')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C2416')
          .width('100%')

        Column({ space: 16 }) {
          // åŸºæœ¬ä¿¡æ¯
          Column({ space: 12 }) {
            Text('âš™ï¸ åŸºæœ¬ä¿¡æ¯')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2C2416')
              .width('100%')

            Column({ space: 8 }) {
              this.buildInfoRow('å®«ä½', this.getSelectedPalaceState()!.palaceName)
              this.buildInfoRow('äº”è¡Œ', this.getSelectedPalaceState()!.palaceElement)
              this.buildInfoRow('ä¹æ˜Ÿ', this.getSelectedPalaceState()!.starName || '')
              this.buildInfoRow('å…«é—¨', this.getSelectedPalaceState()!.doorName || '')
              this.buildInfoRow('å¤©ç›˜', this.getSelectedPalaceState()!.tianGan || '')
              this.buildInfoRow('åœ°ç›˜', this.getSelectedPalaceState()!.diGan || '')
              this.buildInfoRow('å…«ç¥', this.getSelectedPalaceState()!.deityName || '')
            }
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#F8F8F8')
          .borderRadius(8)

          // äº”è¡Œç”Ÿå…‹å…³ç³»
          if (this.getWuxingRelation()) {
            Column({ space: 12 }) {
              Text('â˜˜ï¸ äº”è¡Œç”Ÿå…‹')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
                .width('100%')
          
              Text(this.getWuxingRelation())
                .fontSize(13)
                .fontColor('#666666')
                .lineHeight(20)
                .width('100%')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#F8F8F8')
            .borderRadius(8)
          }
          
          // ä¹æ˜Ÿæ–­è¯­
          if (this.getStarInterpretation()) {
            Column({ space: 12 }) {
              Row({ space: 6 }) {
                Text('â­ ä¹æ˜Ÿæ–­è¯­')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#2C2416')
                Text(`[ã€${this.getSelectedPalaceState()!.starName}ã€‘]`)
                  .fontSize(12)
                  .fontColor('#D4A574')
              }
              .width('100%')
          
              Column({ space: 10 }) {
                Text(this.getStarInterpretation()!.summary)
                  .fontSize(13)
                  .fontColor('#666666')
                  .lineHeight(20)
                  .width('100%')
                          
                Column({ space: 6 }) {
                  Row({ space: 6 }) {
                    Text('âœ… å®œï¼š')
                      .fontSize(12)
                      .fontColor('#4CAF50')
                      .fontWeight(FontWeight.Bold)
                    Text(this.getStarInterpretation()!.favorable)
                      .fontSize(12)
                      .fontColor('#4CAF50')
                      .lineHeight(18)
                      .layoutWeight(1)
                  }
                  .width('100%')
                            
                  Row({ space: 6 }) {
                    Text('âŒ å¿Œï¼š')
                      .fontSize(12)
                      .fontColor('#F44336')
                      .fontWeight(FontWeight.Bold)
                    Text(this.getStarInterpretation()!.unfavorable)
                      .fontSize(12)
                      .fontColor('#F44336')
                      .lineHeight(18)
                      .layoutWeight(1)
                  }
                  .width('100%')
                }
                .width('100%')
              }
              .width('100%')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#FFFBF0')
            .borderRadius(8)
            .border({ width: 1, color: '#FFE4B5' })
          }
          
          // å…«é—¨å‰å‡¶
          if (this.getDoorInterpretation()) {
            Column({ space: 12 }) {
              Row({ space: 6 }) {
                Text('ğŸš¦ å…«é—¨å‰å‡¶')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#2C2416')
                Text(`[ã€${this.getSelectedPalaceState()!.doorName}ã€‘]`)
                  .fontSize(12)
                  .fontColor(this.getDoorInterpretation()!.type === 'å‰é—¨' ? '#4CAF50' : 
                           (this.getDoorInterpretation()!.type === 'å‡¶é—¨' ? '#F44336' : '#FF9800'))
                  .fontWeight(FontWeight.Bold)
              }
              .width('100%')
          
              Column({ space: 10 }) {
                Text(this.getDoorInterpretation()!.summary)
                  .fontSize(13)
                  .fontColor('#666666')
                  .lineHeight(20)
                  .width('100%')
                          
                Column({ space: 6 }) {
                  Row({ space: 6 }) {
                    Text('âœ… å®œï¼š')
                      .fontSize(12)
                      .fontColor('#4CAF50')
                      .fontWeight(FontWeight.Bold)
                    Text(this.getDoorInterpretation()!.favorable)
                      .fontSize(12)
                      .fontColor('#4CAF50')
                      .lineHeight(18)
                      .layoutWeight(1)
                  }
                  .width('100%')
                            
                  Row({ space: 6 }) {
                    Text('âŒ å¿Œï¼š')
                      .fontSize(12)
                      .fontColor('#F44336')
                      .fontWeight(FontWeight.Bold)
                    Text(this.getDoorInterpretation()!.unfavorable)
                      .fontSize(12)
                      .fontColor('#F44336')
                      .lineHeight(18)
                      .layoutWeight(1)
                  }
                  .width('100%')
                }
                .width('100%')
              }
              .width('100%')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#F0F8FF')
            .borderRadius(8)
            .border({ width: 1, color: '#B0D4FF' })
          }

          // å€¼ç¬¦å€¼ä½¿ä¿¡æ¯
          if (this.getZhiFuZhiShiInfo()) {
            Column({ space: 12 }) {
              Text('â­ ç‰¹æ®Šæ ‡è¯†')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
                .width('100%')

              Text(this.getZhiFuZhiShiInfo())
                .fontSize(13)
                .fontColor('#D4A574')
                .lineHeight(20)
                .width('100%')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#FFF8F0')
            .borderRadius(8)
          }

          // ç›¸å…³æ ¼å±€
          if (this.getRelatedPatterns().length > 0) {
            Column({ space: 12 }) {
              Text('ğŸ¯ ç›¸å…³æ ¼å±€')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
                .width('100%')

              Column({ space: 8 }) {
                ForEach(this.getRelatedPatterns(), (pattern: GejuPattern) => {
                  Column({ space: 6 }) {
                    Text(pattern.name)
                      .fontSize(13)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#FF6B35')
                      .width('100%')
                    
                    Text(pattern.description)
                      .fontSize(12)
                      .fontColor('#666666')
                      .lineHeight(18)
                      .width('100%')
                  }
                  .width('100%')
                  .padding(10)
                  .backgroundColor('#FFFFFF')
                  .borderRadius(6)
                  .border({ width: 1, color: '#FFE0D6' })
                })
              }
              .width('100%')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#F8F8F8')
            .borderRadius(8)
          }
        }
        .width('100%')
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({ radius: 8, color: '#22000000', offsetX: 0, offsetY: 2 })
    }
  }

  @Builder
  buildInfoRow(label: string, value: string) {
    Row({ space: 12 }) {
      Text(label)
        .fontSize(13)
        .fontColor('#888888')
        .width(60)
        .textAlign(TextAlign.Start)
      
      Text(value)
        .fontSize(13)
        .fontColor('#2C2416')
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Start)
    }
    .width('100%')
  }
}
