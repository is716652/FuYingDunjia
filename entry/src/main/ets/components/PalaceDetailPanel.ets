import { DunjiaPanResult, PalaceState, GejuPattern } from '../utils/DunjiaEngine'

/**
 * ÂÆ´‰ΩçËØ¶ÊÉÖÈù¢ÊùøÁªÑ‰ª∂Ôºà‰ºòÂåñÁâàÔºâ
 * 
 * ÂäüËÉΩÔºö
 * - ÊòæÁ§∫ÈÄâ‰∏≠ÂÆ´‰ΩçÁöÑÂÆåÊï¥‰ø°ÊÅØ
 * - Ê†ºÂ±ÄËß£ÊûêËØ¥Êòé
 * - ÂÄºÁ¨¶ÂÄº‰ΩøËØ¶ÁªÜ‰ø°ÊÅØ
 * - ÂÆ´‰ΩçÁîüÂÖãÂÖ≥Á≥ª
 */

@Component
export struct PalaceDetailPanel {
  @Prop panResult: DunjiaPanResult | null = null
  @Prop selectedPalace: number | null = null

  /**
   * Ëé∑ÂèñÈÄâ‰∏≠ÂÆ´‰Ωç
   */
  private getSelectedPalaceState(): PalaceState | null {
    if (!this.panResult || this.selectedPalace === null) return null;
    return this.panResult.palaces[this.selectedPalace];
  }

  /**
   * Ëé∑ÂèñÁõ∏ÂÖ≥Ê†ºÂ±Ä
   */
  private getRelatedPatterns(): GejuPattern[] {
    if (!this.panResult || this.selectedPalace === null || !this.panResult.gejuPatterns) return [];
    return this.panResult.gejuPatterns.filter(pattern => 
      pattern.palaceIndices.includes(this.selectedPalace!)
    );
  }

  /**
   * Ëé∑Âèñ‰∫îË°åÁîüÂÖãÂÖ≥Á≥ª
   */
  private getWuxingRelation(): string {
    const palace = this.getSelectedPalaceState();
    if (!palace) return '';
    
    interface WuxingRelationInfo {
      sheng: string;
      ke: string;
      beike: string;
      beisheng: string;
    }

    const wuxingShengke: Record<string, WuxingRelationInfo> = {
      'Ê∞¥': { sheng: 'Êú®', ke: 'ÁÅ´', beike: 'Âúü', beisheng: 'Èáë' },
      'ÁÅ´': { sheng: 'Âúü', ke: 'Èáë', beike: 'Ê∞¥', beisheng: 'Êú®' },
      'Êú®': { sheng: 'ÁÅ´', ke: 'Âúü', beike: 'Èáë', beisheng: 'Ê∞¥' },
      'Èáë': { sheng: 'Ê∞¥', ke: 'Êú®', beike: 'ÁÅ´', beisheng: 'Âúü' },
      'Âúü': { sheng: 'Èáë', ke: 'Ê∞¥', beike: 'Êú®', beisheng: 'ÁÅ´' }
    };
    
    const element = palace.palaceElement;
    const relation = wuxingShengke[element];
    if (!relation) return '';
    
    return `Áîü${relation.sheng} ÂÖã${relation.ke} Ë¢´${relation.beike}ÂÖã ${relation.beisheng}ÁîüÊàë`;
  }

  /**
   * Ëé∑ÂèñÂÄºÁ¨¶ÂÄº‰ΩøËØ¥Êòé
   */
  private getZhiFuZhiShiInfo(): string {
    if (!this.panResult || this.selectedPalace === null) return '';
    
    if (this.panResult.zhiFuPalace === this.selectedPalace) {
      return 'Ê≠§ÂÆ´‰∏∫ÂÄºÁ¨¶ÊâÄÂú®Ôºå‰∏∫‰∏ªÂØºÂäõÈáèÔºå‰ª£Ë°®Â§©Êó∂‰πãÂà©';
    } else if (this.panResult.zhiShiPalace === this.selectedPalace) {
      return 'Ê≠§ÂÆ´‰∏∫ÂÄº‰ΩøÊâÄÂú®Ôºå‰∏∫Ë°åÂä®‰πãÈó®Ôºå‰ª£Ë°®Êó∂Êú∫ÊääÊè°';
    }
    return '';
  }

  build() {
    if (this.selectedPalace !== null && this.getSelectedPalaceState()) {
      Column({ space: 16 }) {
        // Ê†áÈ¢òÊ†è
        Text('ÂÆ´‰ΩçËØ¶ÊÉÖ')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C2416')
          .width('100%')

        Column({ space: 16 }) {
          // Âü∫Êú¨‰ø°ÊÅØ
          Column({ space: 12 }) {
            Text('‚öôÔ∏è Âü∫Êú¨‰ø°ÊÅØ')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2C2416')
              .width('100%')

            Column({ space: 8 }) {
              this.buildInfoRow('ÂÆ´‰Ωç', this.getSelectedPalaceState()!.palaceName)
              this.buildInfoRow('‰∫îË°å', this.getSelectedPalaceState()!.palaceElement)
              this.buildInfoRow('‰πùÊòü', this.getSelectedPalaceState()!.starName || '')
              this.buildInfoRow('ÂÖ´Èó®', this.getSelectedPalaceState()!.doorName || '')
              this.buildInfoRow('Â§©Áõò', this.getSelectedPalaceState()!.tianGan || '')
              this.buildInfoRow('Âú∞Áõò', this.getSelectedPalaceState()!.diGan || '')
              this.buildInfoRow('ÂÖ´Á•û', this.getSelectedPalaceState()!.deityName || '')
            }
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#F8F8F8')
          .borderRadius(8)

          // ‰∫îË°åÁîüÂÖãÂÖ≥Á≥ª
          if (this.getWuxingRelation()) {
            Column({ space: 12 }) {
              Text('‚òØÔ∏è ‰∫îË°åÁîüÂÖã')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
                .width('100%')

              Text(this.getWuxingRelation())
                .fontSize(13)
                .fontColor('#666666')
                .lineHeight(20)
                .width('100%')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#F8F8F8')
            .borderRadius(8)
          }

          // ÂÄºÁ¨¶ÂÄº‰Ωø‰ø°ÊÅØ
          if (this.getZhiFuZhiShiInfo()) {
            Column({ space: 12 }) {
              Text('‚≠ê ÁâπÊÆäÊ†áËØÜ')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
                .width('100%')

              Text(this.getZhiFuZhiShiInfo())
                .fontSize(13)
                .fontColor('#D4A574')
                .lineHeight(20)
                .width('100%')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#FFF8F0')
            .borderRadius(8)
          }

          // Áõ∏ÂÖ≥Ê†ºÂ±Ä
          if (this.getRelatedPatterns().length > 0) {
            Column({ space: 12 }) {
              Text('üéØ Áõ∏ÂÖ≥Ê†ºÂ±Ä')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C2416')
                .width('100%')

              Column({ space: 8 }) {
                ForEach(this.getRelatedPatterns(), (pattern: GejuPattern) => {
                  Column({ space: 6 }) {
                    Text(pattern.name)
                      .fontSize(13)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#FF6B35')
                      .width('100%')
                    
                    Text(pattern.description)
                      .fontSize(12)
                      .fontColor('#666666')
                      .lineHeight(18)
                      .width('100%')
                  }
                  .width('100%')
                  .padding(10)
                  .backgroundColor('#FFFFFF')
                  .borderRadius(6)
                  .border({ width: 1, color: '#FFE0D6' })
                })
              }
              .width('100%')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#F8F8F8')
            .borderRadius(8)
          }
        }
        .width('100%')
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({ radius: 8, color: '#22000000', offsetX: 0, offsetY: 2 })
    }
  }

  @Builder
  buildInfoRow(label: string, value: string) {
    Row({ space: 12 }) {
      Text(label)
        .fontSize(13)
        .fontColor('#888888')
        .width(60)
        .textAlign(TextAlign.Start)
      
      Text(value)
        .fontSize(13)
        .fontColor('#2C2416')
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Start)
    }
    .width('100%')
  }
}
